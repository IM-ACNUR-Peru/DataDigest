---
title: "Weekly Data Digest"
author: IM ACNUR Peru
output: unhcrdown::paged_simple

---


```{r setup, include=FALSE}
library(robotoolbox)
library(tidyverse)
library(purrr)
library(dplyr)
library(readxl)
library(ggplot2) 
library(unhcrthemes)
library(scales)
library(directlabels)

date_start_filter <- Sys.Date() - 207

kobo_setup(url = "https://kobo.unhcr.org",
           token = Sys.getenv('KOBO_API_KEY'))


# Monitoreo de fronteras
x <- kobo_submissions("aGSPzf4eNgZ5xKhYDe8kbm")
main <- x$main
member2 <- x$member2

main_last_week <- main %>% 
  filter(today > date_start_filter)

main_last_week_tumbes <- main_last_week %>% 
  filter(lugar_monitoreo == "tumbes")

main_last_week_tacna <- main_last_week %>% 
  filter(lugar_monitoreo == "tacna")

main_last_week_mdd <- main_last_week %>% 
  filter(lugar_monitoreo == "mdd")

main_last_week_lima <- main_last_week %>% 
  filter(lugar_monitoreo == "lima")

main_last_week_puno <- main_last_week %>% 
  filter(lugar_monitoreo == "puno")


# # MasterFile Excel on SharePoint
# library(Microsoft365R)# Get your SharePoint site
# 
# # Replace "My Site" to your SharePoint site
# my_site_url="https://unhcr365.sharepoint.com/teams/amer-peria/"
# app = Sys.getenv('SHAREPOINT_KEY')
# 
# #pass error?
# site <- get_sharepoint_site(site_url = my_site_url, app = app)
# drv <- site$get_drive()## you can see your files
# 
# # File path in the form of "Folder1/Folder2"
# drv$list_files()
# drv$list_files("MyE ACNUR/5. IM Products/Dashboard Situacion Peru", full_names=TRUE)
# 
# # download your file in the current diretory
# drv$download_file("MyE ACNUR/5. IM Products/Dashboard Situacion Peru/MasterFile.xlsx",overwrite = TRUE)
# 
# DTM <- read_excel("MasterFile.xlsx", sheet="DTM", skip=0 ) 
#   
# file.remove("MasterFile.xlsx")



```
`r Sys.Date()`

Boletín semanal para la operación ACNUR Perú.

## Monitoreo de fronteras

Durante la semana pasada se entrevistaron `r nrow(main_last_week)` grupos (`r sum(main_last_week$miembros)` personas). Entre ellos, `r nrow(main_last_week_tumbes)` en Tumbes, `r nrow(main_last_week_tacna)` en Tacna, `r nrow(main_last_week_puno)` en Puno, `r nrow(main_last_week_mdd)` en Madre de Dios y `r nrow(main_last_week_lima)` en Lima.  

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.align = 'center', results='hide', fig.width=7,fig.height=2.7}

library(labelled)
data(main_last_week, package = "unhcrthemes")
names <- c('lugar_monitoreo')
main_last_week[,names] <- lapply(main_last_week[,names] , to_factor)

main_last_week_chart_previo <- main_last_week %>% 
  select(paisprevio, lugar_monitoreo) %>% 
  group_by(paisprevio, lugar_monitoreo) %>% 
  summarise(total = n()) %>% 
  group_by(lugar_monitoreo) %>% 
  mutate(percent = total/sum(total)) %>% 
  ungroup() %>% 
  select(paisprevio, lugar_monitoreo, percent) 


#glimpse(main_last_week_chart_previo)

#ymax_previo <- ifelse(max(main_last_week_chart_previo$total) / sum(main_last_week_chart_previo$total) > 0.89, 1, max(main_last_week_chart_previo$total) / sum(main_last_week_chart_previo$total) + 0.1)


ggplot(main_last_week_chart_previo, aes(x = reorder(paisprevio, -percent), y = percent)) +
  geom_col(
           fill = unhcr_pal(n = 1, "pal_blue"),
           width = 0.8) +
   geom_text(aes(label = paste0( round(percent*100, 0), "%" )), vjust = 1.5, colour = "white") +
  labs(title = "Principales paises de procedencia",
       y = "Personas entrevistadas",
       caption = "Fuente: Monitoreo de Fronteras de ACNUR") +
  scale_y_continuous(labels=scales::percent) +
  coord_cartesian(ylim = c(0.0, 1)) + 
 # scale_x_continuous(breaks = pretty_breaks(10)) +
 theme_unhcr(font_size = 11,
    grid = FALSE,
    axis = FALSE,
    axis_title = FALSE,
    axis_text = "x"
  ) +
  facet_grid(~ lugar_monitoreo, scales='free', space='free') 


```

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.align = 'center', results='hide', fig.width=7,fig.height=2.7}

data(main_last_week, package = "unhcrthemes")


main_last_week_chart_destino <- main_last_week %>% 
  select(paisdestino, lugar_monitoreo) %>% 
  group_by(paisdestino, lugar_monitoreo) %>% 
  summarise(total = n()) %>% 
  group_by(lugar_monitoreo) %>% 
  mutate(percent = total/sum(total)) %>% 
  ungroup() %>% 
  select(paisdestino, lugar_monitoreo, percent) 


#glimpse(main_last_week_chart_destino)

#ymax_destino <- ifelse(max(main_last_week_chart_destino$total) / sum(main_last_week_chart_destino$total) > 0.89, 1, max(main_last_week_chart_destino$total) / sum(main_last_week_chart_destino$total) + 0.1)



ggplot(main_last_week_chart_destino, aes(x = reorder(paisdestino, -percent), y = percent)) +
  geom_col(
           fill = unhcr_pal(n = 1, "pal_blue"),
           width = 0.8) +
   geom_text(aes(label = paste0( round(percent*100, 0), "%" )), vjust = 1.5, colour = "white") +
  labs(title = "Principales paises de destino",
       y = "Personas entrevistadas",
       caption = "Fuente: Monitoreo de Fronteras de ACNUR") +
  scale_y_continuous(labels=scales::percent) +
  coord_cartesian(ylim = c(0.0, 1)) + 
 # scale_x_continuous(breaks = pretty_breaks(10)) +
 theme_unhcr(font_size = 11,
    grid = FALSE,
    axis = FALSE,
    axis_title = FALSE,
    axis_text = "x"
  ) +
  facet_grid(~ lugar_monitoreo, scales='free', space='free') 




```


Para más información, consultar el [dashboard de monitoreo de fronteras](https://app.powerbi.com/links/5xMJ63-7XL?ctid=e5c37981-6664-4134-8a0c-6543d2af80be).


## Flujos en frontera



```{r eval=FALSE, fig.height=2.5, fig.width=7, message=FALSE, warning=FALSE, dpi=150, include=FALSE}

# La última actualización de la OIM-DTM fue el `r# max(as.Date(DTM$Fecha, '%d/%m/%Y'))`:
#Plot
f <- function(punto) {
  df = filter(DTM, Punto == punto)
  df1 = filter(df, Fecha > Sys.Date() - 90)
  df_max = max(df1$Personas)
  ggplot(df1, aes(
  x = Fecha,
  y = Personas,
  color = Tipo
)) +
  geom_line(size = 0.5) +
  geom_dl(aes(label = Tipo),
    method = list(cex = 2,
      dl.trans(x = x + 0.1),
      "last.points"
    ),
    size = 10 / .pt
  ) +
  labs(
    title = paste("Flujos en ", punto),
    y = "Personas observadas",
    caption = "Fuente: Conteo DTM (OIM)"
  ) +
 # scale_x_continuous(breaks = pretty_breaks()) +
  scale_y_continuous(
    expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(),
    labels = label_number_si(),
    limits = c(0, df_max)
  ) +
  scale_color_unhcr_d(
    palette = "pal_unhcr",
    nmax = 10,
    order = c(4, 1)
  ) +
  coord_cartesian(clip = "off") +
  theme_unhcr(
    grid = "Y",
    axis = "x",
    axis_title = "y",
    legend = FALSE,
    font_size = 40
  ) +
  theme(plot.margin = margin(r = 50))
}

Tumbes_Plot <- f("Tumbes")
Tumbes_Plot


```

```{r eval=FALSE, include=FALSE, fig.align='center', fig.height=2.5, fig.width=7, warning=FALSE, dpi=150, results='hide'}

Tacna_Plot <- f("Tacna")
Tacna_Plot

```

```{r  eval=FALSE, include=FALSE, echo=FALSE, warning=FALSE, fig.align = 'center', results='hide', fig.width=7,fig.height=2.5, dpi=150}

Puno_Plot <- f("Puno")
Puno_Plot


```

Para más información, consultar el [dashboard de estadísticas poblacionales](https://app.powerbi.com/links/xEqM6jT2c9?ctid=e5c37981-6664-4134-8a0c-6543d2af80be) (pestaña "Flujos Irregulares").


## Respuesta en curso: Kits distribuidos

```{r , echo=FALSE, warning=FALSE}

kobo_setup(url = "https://kobo.unhcr.org",
           token = Sys.getenv('KOBO_API_KEY'))


# Monitoreo de fronteras
rudah <- kobo_submissions("aBtojPUs4yxmaLNqN7NCvc")

rudah <- rudah$main

rudah <- rudah %>% 
    mutate_at(vars(starts_with("qt_")), ~ replace(., is.na(.), 0)) %>% 
    mutate_at(vars(starts_with("tipo_orientacion_")), ~ replace(., is.na(.), 0)) %>% 
    filter(today > date_start_filter) %>% 
    filter(test_real == "registro_real")

total_kits <- rudah %>% 
 select("qt_kit01":"qt_kit_other") %>% 
  rowSums() %>% 
  sum()

total_cris <- rudah %>% 
 select("qt_cri01":"qt_cri_other") %>% 
  rowSums() %>% 
  sum()

personas_kits <- rudah %>% 
  mutate(sum = rowSums(across("qt_kit01":"qt_kit_other"))) %>% 
  filter(sum > 0) %>% 
  select("member_count") %>% 
  rowSums() %>% 
  sum()

personas_cris <- rudah %>% 
  mutate(sum = rowSums(across("qt_cri01":"qt_cri_other"))) %>% 
  filter(sum > 0) %>% 
  select("member_count") %>% 
  rowSums() %>% 
  sum()


personas_kits_cris <- rudah %>% 
  filter(grepl('asistencia_kit', kit_orientacion)) %>% 
  select("member_count") %>% 
  rowSums() %>% 
  sum()



```

Durante la última semana, la operación distribuyó `r total_kits` Kits y `r total_cris` CRIs, asistiendo a un total de `r personas_kits_cris` personas (`r personas_kits` personas recibieron kits y `r personas_cris` recibieron CRIs).


```{r, echo=FALSE, warning = FALSE, message = FALSE, result = FALSE, fig.width=7,fig.height=3}


#drv$list_files("MyE ACNUR/2. Monitoreo respuesta/2023/Reporte Kits e items Humanitarios - 2023", full_names=TRUE)

# download your file in the current diretory
# drv$download_file("MyE ACNUR/2. Monitoreo respuesta/2023/Reporte Kits e items Humanitarios - 2023/Versiones anteriores propuesta kits/Registro de Asistencia y Ayuda Humanitaria 2023 v.03.xlsx",overwrite = TRUE)
# 
# rudah_xls <- read_excel("Registro de Asistencia y Ayuda Humanitaria 2023 v.03.xlsx", sheet="choices", skip=0 ) 
#   
# invisible(file.remove("Registro de Asistencia y Ayuda Humanitaria 2023 v.03.xlsx"))
# 
# rudah_xls_ofi <- rudah_xls %>% 
#   filter(list_name == "oficina") %>% 
#   select(name, label)
# 
# colnames(rudah_xls_ofi) <- c("oficina", "Nombre")
# 
rudah_kits_cris_plot <- rudah %>%
  mutate(sum_kits = rowSums(across("qt_kit01":"qt_kit_other"))) %>%
  mutate(sum_cris = rowSums(across("qt_cri01":"qt_cri_other"))) %>%
  select("oficina", "sum_kits", "sum_cris") %>%
  group_by(oficina) %>%
  summarise_at(c("sum_kits", "sum_cris"), sum, na.rm = TRUE)
# 
# 
# rudah_kits_cris_plot <- left_join(rudah_kits_cris_plot, rudah_xls_ofi, by="oficina")
# 
# colnames(rudah_kits_cris_plot) <- c("oficina_code", "Kits", "CRIs", "Oficina")
# 
# rudah_kits_cris_plot <- rudah_kits_cris_plot %>% 
#   select(Oficina, Kits, CRIs) %>% 
#   pivot_longer(!Oficina, names_to="Tipo", values_to="Total")
# 
# rudah_kits_cris_plot_ymax <- max(rudah_kits_cris_plot$Total)*1.1
# 
#   
# ggplot(rudah_kits_cris_plot) +
#   geom_col(aes(
#     x = Tipo,
#     y = Total,
#     fill = Tipo
#   ),
#   position = position_dodge(width = 0.7),
#   width = 0.6
#   ) +
# #  facet_wrap(~ Oficina, nrow = 2) +
#     facet_grid(~ Oficina, scales='free', space='free') +
#   geom_text(aes(
#     x = Tipo,
#     y = Total,
#     group = Tipo,
#     label = Total
#   ),
#   position = position_dodge(width = 0.7),
#   vjust = -1,
#   size = 8 / .pt
#   ) +
#   scale_fill_unhcr_d(
#     palette = "pal_unhcr",
#     nmax = 3,
#     order = c(2, 3, 1)
#   ) +
#   labs(
#     title = "Asistencia brindada",
#     y = "Insumos distribuidos",
#     x = "Oficina de terreno",
#     caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
#   ) +
#  # scale_x_continuous(breaks = pretty_breaks(n = 4)) +
#   scale_y_continuous(expand = expansion(c(0, 0.1))) +
#   theme_unhcr(
#     grid = FALSE,
#     axis = "x",
#     axis_title = FALSE,
#     axis_text = "x"
#   ) +
#   ylim(0,rudah_kits_cris_plot_ymax) +
#   guides(fill = guide_legend(nrow = 2, byrow = TRUE))


```


## Respuesta en curso: Orientaciones brindadas


```{r, echo=FALSE, warning=FALSE}

total_ori_gen <- rudah %>%
 select("tipo_orientacion_ori_general") %>%
  rowSums() %>%
  sum()

total_ori_legal <- rudah %>%
 select("tipo_orientacion_ori_legal") %>%
  rowSums() %>%
  sum()

personas_ori_gen <- rudah %>%
  mutate(sum = rowSums(across("tipo_orientacion_ori_general"))) %>%
  filter(sum > 0) %>%
  select("member_count") %>%
  rowSums() %>%
  sum()

personas_ori_legal <- rudah %>%
  mutate(sum = rowSums(across("tipo_orientacion_ori_legal"))) %>%
  filter(sum > 0) %>%
  select("member_count") %>%
  rowSums() %>%
  sum()


personas_ori_tot <- rudah %>%
  filter(!is.na(tipo_orientacion)) %>%
  select("member_count") %>%
  rowSums() %>%
  sum()

tot_ori_statement <- ifelse(personas_ori_tot == 0 | personas_ori_gen == 0 | personas_ori_legal == 0, "", paste(" (", personas_ori_gen, "personas con orientaciones generales y ", personas_ori_legal, "personas con orientaciones legales)"))

```


La operación brindó `r total_ori_gen` orientaciones generales y `r total_ori_legal` orientaciones legales durante los últimos 7 días a un total de `r personas_ori_tot` personas`r tot_ori_statement`.


```{r eval=FALSE, fig.height=3, fig.width=7, message=FALSE, warning=FALSE, include=FALSE, result=FALSE}

rudah_ori_plot <- rudah %>%
  mutate(sum_ori_gen = rowSums(across("tipo_orientacion_ori_general"))) %>%
  mutate(sum_ori_legal = rowSums(across("tipo_orientacion_ori_legal"))) %>%
  select("oficina", "sum_ori_gen", "sum_ori_legal") %>%
  group_by(oficina) %>%
  summarise_at(c("sum_ori_gen", "sum_ori_legal"), sum, na.rm = TRUE)


rudah_ori_plot <- left_join(rudah_ori_plot, rudah_xls_ofi, by="oficina")

colnames(rudah_ori_plot) <- c("oficina_code", "Orientaciones Generales", "Orientaciones Legales", "Oficina")

rudah_ori_plot <- rudah_ori_plot %>%
  select(Oficina, `Orientaciones Generales`, `Orientaciones Legales`) %>%
  pivot_longer(!Oficina, names_to="Tipo", values_to="Total")

rudah_ori_plot_ymax <- max(rudah_ori_plot$Total)*1.1


ggplot(rudah_ori_plot) +
  geom_col(aes(
    x = Tipo,
    y = Total,
    fill = Tipo
  ),
  position = position_dodge(width = 0.7),
  width = 0.6
  ) +
#  facet_wrap(~ Oficina, nrow = 2) +
    facet_grid(~ Oficina, scales='free', space='free') +
  geom_text(aes(
    x = Tipo,
    y = Total,
    group = Tipo,
    label = Total
  ),
  position = position_dodge(width = 0.7),
  vjust = -1,
  size = 8 / .pt
  ) +
  scale_fill_unhcr_d(
    palette = "pal_unhcr",
    nmax = 3,
    order = c(2, 3, 1)
  ) +
  labs(
    title = "Asistencia brindada",
    y = "Orientaciones brindadas",
    x = "Oficina de terreno",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
 # scale_x_continuous(breaks = pretty_breaks(n = 4)) +
  scale_y_continuous(expand = expansion(c(0, 0.1))) +
  theme_unhcr(
    grid = FALSE,
    axis = "x",
    axis_title = FALSE,
    axis_text = "x"
  ) +
  ylim(0,rudah_kits_cris_plot_ymax) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE))


```


```{r, echo=FALSE, warning = FALSE, message=FALSE, fig.align = 'left', fig.width=7,fig.height=2}

# library(knitr)
# library(kableExtra)
# 
# 
# orientaciones <- rudah %>% 
#   select(oficina, "orientacion_general_ori_general1":"orientacion_general_other", "orientacion_legal_ori_legal1":"orientacion_legal_other") %>% 
#   mutate_at(vars(starts_with("ori")), ~ replace(., is.na(.), 0)) %>% 
#   pivot_longer(!oficina, names_to="Tipo", values_to="Total") %>% 
#   filter(Total > 0) %>% 
#   group_by(oficina, Tipo) %>% 
#   summarise_at(c("Total"), sum, na.rm = TRUE)
# 
# 
# orientaciones <- left_join(orientaciones, rudah_xls_ofi, by="oficina")
# 
# 
# rudah_xls_ori <- rudah_xls %>% 
#   filter(list_name == "orientacion_general" | list_name == "orientacion_legal") %>% 
#   mutate(namenew = paste(list_name, "_", name, sep="")) %>% 
#   select(namenew, label) 
#   
# 
# colnames(rudah_xls_ori) <- c("Tipo", "Nombre Orientacion")
# 
# orientaciones <- left_join(orientaciones, rudah_xls_ori, by="Tipo")
# 
# orientaciones <- orientaciones[,c("Nombre", "Nombre Orientacion", "Total")]
# 
# 
# colnames(orientaciones) <- c("Oficina/Unidad", "Tipo de Orientación Brindada", "Total")
# 
# orientaciones %>%
#   kbl() %>%
#   kable_styling(bootstrap_options = "striped", html_font = "Arial", font_size = 9)

```


