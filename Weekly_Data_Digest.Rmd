---
title: "Weekly Data Digest"
author: IM ACNUR Peru
output: 
  pagedown::html_paged:
    css: resources/paged.css
knit: pagedown::chrome_print
---


```{r setup, include=FALSE}
library(robotoolbox)
library(tidyverse)
library(purrr)
library(dplyr)
library(readxl)
library(ggplot2) 
library(unhcrthemes)
library(scales)
library(directlabels)
library(labelled)
library(knitr)
library(kableExtra)
library(treemapify)
library(gt)
library(httr)
library(ggrepel)
library(tools)
library(stringr)
library(stringi)
library(htmltools)
library(activityinfo)
library(lubridate)

date_today <- Sys.Date() - 1

date_start_filter <- Sys.Date() - 7

date_start_filter_month <- Sys.Date() - 31

kobo_setup(url = "https://kobo.unhcr.org",
           token = Sys.getenv('KOBO_API_KEY'))


# RUDAH 2023
 x_2023 <- kobo_submissions("a9Erto2aYbgJamz8vdrtJt")
main_2023 <- x_2023$main |> 
  rename(
      qt_kit_t_familiar =  qt_kit01,
      qt_kit_t_adulto =  qt_kit02,
      qt_kit_t_extramujer =  qt_kit03,
      qt_kit_t_NNA = qt_kit04,
      qt_kit_t_bebe = qt_kit05,
      qt_kit_a_adulto = qt_kit06,
      qt_kit_a_nna = qt_kit07,
      qt_kit_a_bebe = qt_kit08,
      qt_kit_re_familia = qt_kit09,
      qt_kit_re_nna = qt_kit10,
      qt_kit_re_sola = qt_kit11,
      qt_kit_re_bebe = qt_kit12,
      qt_kit_oficina = qt_kit15,
      qt_kit_escolar = qt_kit16,
      
      qt_cri_frazada = qt_cri01,
      qt_cri_setcocina = qt_cri02,
      qt_cri_baldes = qt_cri03,
      qt_cri_galoneras = qt_cri04,
      qt_cri_sillaruedas = qt_cri05,
      qt_cri_bastones = qt_cri06,
      qt_cri_muletas = qt_cri07,
      qt_cri_botellasagua = qt_cri08,
      qt_cri_ropa_termica = qt_cri09,
      qt_cri_mosquitero = qt_cri10,
      qt_cri_colchoneta = qt_cri11,
      qt_cri_carpa = qt_cri12,
      qt_cri_jabones = qt_cri13,
      qt_cri_bidon = qt_cri14,
      qt_cri_papelhigienico = qt_cri15,
      qt_cri_libro_viaje = qt_cri16,
      qt_cri_libro_heroina = qt_cri17,
      qt_cri_libro_pabellon = qt_cri18,
      qt_cri_laptop = qt_cri19,
      qt_cri_teclado = qt_cri20,
      qt_cri_tablet = qt_cri21,
      qt_cri_sandalias_crocs = qt_cri22,
      qt_cri_mochila = qt_cri23,
      qt_cri_panales = qt_cri24
  ) |> 
  select("today":"perfil", "tipo_orientacion":"kit_other",  "sign":"paisprevio", "paisdestino", starts_with("cri_dis"), starts_with("kit_dis"), starts_with("qt_kit"), starts_with("qt_cri"), "member_count")
member2_2023 <- x_2023$member


# RUDAH 2024 (hasta agosto)
 x_2024 <- kobo_submissions("aMRCvAGEpGSMsvS4A2VMzC")
main_2024 <- x_2024$main |> 
  select("today":"perfil", "tipo_orientacion":"TotalKitsCRI", "lugar_monitoreo":"paisdestino", starts_with("cri_dis"), starts_with("kit_dis"), starts_with("qt_kit"), starts_with("qt_cri"), "member_count") |> 
  mutate_at(vars(ori_gen_other), as.character) |> 
  mutate_at(vars(TotalKit, TotalCRI), as.numeric)

member2_2024 <- x_2024$member


# RUDAH 2024 (desde septiembre)
 x_2024b <- kobo_submissions("aoSWoUrToEhdL2Zc9pvhJY")
main_2024b <- x_2024b$main |> 
  # rename(
  #     qt_kit01 = qt_kit_t_familiar,
  #     qt_kit02 = qt_kit_t_adulto,
  #     qt_kit03 = qt_kit_t_extramujer,
  #     qt_kit04 = qt_kit_t_NNA,
  #     qt_kit05 = qt_kit_t_bebe,
  #     qt_kit06 = qt_kit_a_adulto,
  #     qt_kit07 = qt_kit_a_nna,
  #     qt_kit08 = qt_kit_a_bebe,
  #     qt_kit09 = qt_kit_re_familia,
  #     qt_kit10 = qt_kit_re_nna,
  #     qt_kit11 = qt_kit_re_sola,
  #     qt_kit12 = qt_kit_re_bebe,
  #     qt_kit15 = qt_kit_oficina,
  #     qt_kit16 = qt_kit_escolar,
  # 
  #     fi01 = qt_cri_frazada,
  #     qt_cri02 = qt_cri_setcocina,
  #     qt_cri03 = qt_cri_baldes,
  #     qt_cri04 = qt_cri_galoneras,
  #     qt_cri05 = qt_cri_sillaruedas,
  #     qt_cri06 = qt_cri_bastones,
  #     qt_cri07 = qt_cri_muletas,
  #     qt_cri08 = qt_cri_botellasagua,
  #     qt_cri09 = qt_cri_ropa_termica,
  #     qt_cri10 = qt_cri_mosquitero,
  #     qt_cri11 = qt_cri_colchoneta,
  #     qt_cri12 = qt_cri_carpa,
  #     qt_cri13 = qt_cri_jabones,
  #     qt_cri14 = qt_cri_bidon,
  #     qt_cri15 = qt_cri_papelhigienico,
  #     qt_cri16 = qt_cri_libro_viaje,
  #     qt_cri17 = qt_cri_libro_heroina,
  #     qt_cri18 = qt_cri_libro_pabellon,
  #     qt_cri19 = qt_cri_laptop,
  #     qt_cri20 = qt_cri_teclado,
  #     qt_cri21 = qt_cri_tablet,
  #     qt_cri22 = qt_cri_sandalidas_crocs,
  #     qt_cri23 = qt_cri_mochila,
  #     qt_cri24 = qt_cri_panales
  # ) |> 
  select("today":"perfil", "tipo_orientacion":"TotalKitsCRI", "punto_monitoreo":"paisdestino", starts_with("cri_dis"), starts_with("kit_dis"), starts_with("qt_kit"), starts_with("qt_cri"), "member_count") |> 
  mutate_at(vars(ori_gen_other), as.character) |> 
  mutate_at(vars(TotalKit, TotalCRI), as.numeric)

member2_2024b <- x_2024b$member


main <- bind_rows(main_2023, main_2024, main_2024b)
member2 <- bind_rows(member2_2023, member2_2024, member2_2024b)

main <- main |> 
    dplyr::filter(fecha <= date_today) |> 
    dplyr::filter(test_real == "registro_real") |> 
    rename(today_rev = today) |> 
    rename(today = fecha)

main_last_week <- main |> 
  dplyr::filter(today > date_start_filter) |>
  dplyr::filter(today <= date_today) |> 
  dplyr::filter(grepl("mon_fro",kit_orientacion)) 

names_per <- c('perfil')
main_last_week[,names_per] <- lapply(main_last_week[,names_per] , to_factor)

names_reg <- c('region')
main_last_week[,names_reg] <- lapply(main_last_week[,names_reg] , to_factor)

main_last_week_tumbes <- main_last_week |> 
  filter(region == "Tumbes")

main_last_week_tacna <- main_last_week |> 
  filter(region == "Tacna")

main_last_week_mdd <- main_last_week |> 
  filter(region == "Madre de Dios")

main_last_week_lima <- main_last_week |> 
  filter(region == "Lima")

main_last_week_puno <- main_last_week |> 
  filter(region == "Puno")

main_last_month <- main |> 
  dplyr::filter(today > date_start_filter_month) |>
  dplyr::filter(grepl("mon_fro",kit_orientacion)) 

names_per_month <- c('perfil')
main_last_month[,names_per_month] <- lapply(main_last_month[,names_per_month] , to_factor)

names_reg <- c('region')
main_last_month[,names_reg] <- lapply(main_last_month[,names_reg] , to_factor)


main_last_month_tumbes <- main_last_month |> 
  filter(region == "Tumbes")

main_last_month_tacna <- main_last_month |> 
  filter(region == "Tacna")

main_last_month_mdd <- main_last_month |> 
  filter(region == "Madre de Dios")

main_last_month_lima <- main_last_month |> 
  filter(region == "Lima")

main_last_month_puno <- main_last_month |> 
  filter(region == "Puno")


```

`r date_today`

Boletín semanal para la operación ACNUR Perú.

## Flujos irregulares (DTM)

```{r pbi_scraping, dpi = 200, echo=FALSE, warning=FALSE, message=FALSE, fig.align = 'center', results='hide', fig.height=3.5}

url <- "https://wabi-north-europe-f-primary-api.analysis.windows.net/public/reports/querydata?synchronous=true"

# Dashboard data

pbi <- function(file, location, pob) {
  query <- read_file(file) |> 
  str_replace("2023-01-03", as.character(Sys.Date()-180)) |> 
  str_replace("2024-05-30", as.character(Sys.Date()))
  
  r <- POST(url, body = query, add_headers("X-PowerBI-ResourceKey" = "f4238ef3-6559-492b-95ac-f285a3a62588"))
  
  ds <- jsonlite::fromJSON(content(r, as = "text"))$results$result$data$dsr$DS[[1]]

  df <- ds$PH[[1]]$DM0[[1]] |> 
  select(C, X) |> 
  unnest(cols = X) |> 
  mutate(direction = rep_len(c("entradas", "salidas"), n())) |>
  mutate(across(c('C'), substr, 3, nchar(C))) |> 
  mutate(across(c('C'), substr, 1, nchar(C)-1)) |> 
  select(C, M1, direction) |> 
  separate(C,
             into = c("year", "month", "day", "whatever"), 
                             sep = ",", 
                             fill = "left") |> 
  mutate(year = str_replace_all(year, "[^A-Za-z0-9]", "")) |> 
  mutate(month = str_replace_all(month, "[^A-Za-z0-9]", "")) |> 
  mutate(day = str_replace_all(day, "[^A-Za-z0-9]", "")) |> 
  fill(year, month) |> 
  select(year, month, day, M1, direction) |> 
   pivot_wider(names_from = direction, values_from = M1) |> 
  mutate(level = location) |> 
    mutate(pop = pob)
  
  df
}

nat_data_dtm <- pbi("json/dtm_national_new_2.json", "Nacional", "Total")
tacna_data_dtm <- pbi("json/dtm_tacna_new_2.json", "Tacna", "Total")
tumbes_data_dtm <- pbi("json/dtm_tumbes_new_2.json", "Tumbes", "Total")
puno_data_dtm <- pbi("json/dtm_puno_new_2.json", "Puno", "Total")

nat_data_dtm_ven <- pbi("json/dtm_national_VEN.json", "Nacional", "Ven")
tacna_data_dtm_ven <- pbi("json/dtm_tacna_VEN.json", "Tacna", "Ven")
tumbes_data_dtm_ven <- pbi("json/dtm_tumbes_VEN.json", "Tumbes", "Ven")
puno_data_dtm_ven <- pbi("json/dtm_puno_VEN.json", "Puno", "Ven")


# All together now!

all_data_dtm <- bind_rows(nat_data_dtm, tacna_data_dtm, tumbes_data_dtm, puno_data_dtm, nat_data_dtm_ven, tacna_data_dtm_ven, tumbes_data_dtm_ven, puno_data_dtm_ven) |> 
  mutate(across('month', str_replace, 'enero', '01')) |> 
  mutate(across('month', str_replace, 'febrero', '02')) |> 
  mutate(across('month', str_replace, 'marzo', '03')) |> 
  mutate(across('month', str_replace, 'abril', '04')) |> 
  mutate(across('month', str_replace, 'mayo', '05')) |> 
  mutate(across('month', str_replace, 'junio', '06')) |> 
  mutate(across('month', str_replace, 'julio', '07')) |> 
  mutate(across('month', str_replace, 'agosto', '08')) |> 
  mutate(across('month', str_replace, 'septiembre', '09')) |> 
  mutate(across('month', str_replace, 'octubre', '10')) |> 
  mutate(across('month', str_replace, 'noviembre', '11')) |> 
  mutate(across('month', str_replace, 'diciembre', '12')) |> 
  mutate_at(vars(starts_with("day")), as.character) |>
  mutate(day = if_else(nchar(day) == 2, day, paste("0", day, sep = ""))) |> 
  mutate(date = paste(year, month, day, sep = "/")) |> 
  mutate(date=as.Date(date, format = "%Y/%m/%d"))  |> 
  select(date, entradas, salidas, level, pop) |> 
  pivot_longer(cols = c(entradas, salidas), names_to = "Tipo", values_to = "Total") |> 
  mutate(date_text = format(date, "%d/%m")) |> 
  as.data.frame() |> 
  group_by(date, level, Tipo, date_text) |> 
  pivot_wider(names_from = pop, values_from = Total) |> 
  mutate(Total = replace(Total, date == "2024-05-29" & Tipo == "salidas" & level == "Tumbes", 267)) |> 
  mutate(Ven = replace(Ven, date == "2024-05-29" & Tipo == "entradas" & level == "Puno", 21)) |> 
  mutate(Total = replace(Total, date == "2024-07-04" & Tipo == "salidas" & level == "Puno", 51)) |> 
  mutate(Otras = Total - Ven) 



first_date <- all_data_dtm |> 
  filter(date > max(all_data_dtm$date)-23)  

start_date <- min(first_date$date)

last_data_dtm <- all_data_dtm |> 
    filter(date >= start_date)

# Plot
ggplot(last_data_dtm, 
       aes(
  x = date,
  y = Total,
  color = Tipo
)) +
    annotate("rect", xmin = max(last_data_dtm$date), xmax = as.Date(Inf), ymin = -Inf, ymax = Inf, fill = "white", alpha = 0.8) +
  geom_line(size = 0.7) +
  geom_point(size = 2) +
  labs(
 #   title = "Flujos en frontera",
    y = "Personas observadas",
    caption = "Fuente: Conteos DTM OIM"
  ) +
  scale_x_continuous(
    breaks = last_data_dtm$date,
#    limits = c(start_date, max(all_data_dtm$date)+7)
    labels = format(last_data_dtm$date, "%d-%b")
  ) +
  # scale_x_date(
  #   date_labels="%b %Y", 
  #   date_breaks  = all_data_dtm$date,
  #              limits = c(start_date, max(all_data_dtm$date)+7)
  #              ) +
  coord_cartesian(clip = "off") +
  facet_wrap(~ level, ncol = 2, scales='free') +
  scale_y_continuous(
    expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(n = 4),
    labels = label_number(scale_cut = cut_short_scale())
#    limits = c(0, max(last_data_dtm$Total) * 1.1)
  ) +
  scale_color_unhcr_d(
    palette = "pal_unhcr",
    nmax = 10,
    order = c(1, 3)
  ) +
  geom_text_repel(
    aes(label = Total),
    size = 3,
 #   hjust = -2,
     direction = "y",
     box.padding = unit(1, "lines"),
     point.padding = unit(1, "lines"),
     segment.color = NA,
     min.segment.length = 0
    # nudge_y = 2
    # segment.color = NA,
    # show.legend = FALSE
  ) +
  # geom_text(
  #   aes(label = Total),
  #   nudge_x = 0.25,
  #   nudge_y = 20,
  #   check_overlap = TRUE,
  #   size = 7
  # ) +
  theme(
     panel.background = element_rect(fill = "white"),
 #   panel.grid = element_blank(),
     panel.grid.major.y = element_blank(),
     panel.grid.major.x = element_blank(),
    axis.ticks = element_blank(),
    strip.background = element_rect(colour = "white", fill = "white"),
    axis.text.x = element_text(size=9,
        family="Lato"),
    axis.text.y = element_blank(),
    axis.line.x = element_line(colour = "black"),
    text = element_text(size=9,
        family="Lato"),
    strip.text = element_text(size=12, face = "bold"),
    title = element_text(size=14,
        family="Lato", face = "bold"),
    plot.caption = element_text(size=6,
        family="Lato", face = "plain"),
    legend.position = "bottom",
    legend.title = element_blank(),
     axis.title = element_blank(),
     panel.spacing = unit(1, "lines")  # Adjust the space between facets
   )

mean_entradas <- last_data_dtm |> 
  filter(Tipo == "entradas") |> 
  filter(level == "Nacional")

mean_salidas <- last_data_dtm |> 
  filter(Tipo == "salidas") |>  
  filter(level == "Nacional")

tot_entradas_promedio <- round(mean(mean_entradas$Total), 0)
ven_entradas_promedio <- round(mean(mean_entradas$Ven), 0)

tot_salidas_promedio <- round(mean(mean_salidas$Total), 0)
ven_salidas_promedio <- round(mean(mean_salidas$Ven), 0)

year_mean_entradas <- all_data_dtm |> 
  filter(date >= date_today - 365) |> 
  filter(Tipo == "entradas") |> 
  filter(level == "Nacional")

year_mean_salidas <- all_data_dtm |> 
  filter(date >= date_today - 365) |> 
  filter(Tipo == "salidas") |>  
  filter(level == "Nacional")

year_tot_entradas_promedio <- round(mean(year_mean_entradas$Total), 0)
year_ven_entradas_promedio <- round(mean(year_mean_entradas$Ven), 0)

year_tot_salidas_promedio <- round(mean(year_mean_salidas$Total), 0)
year_ven_salidas_promedio <- round(mean(year_mean_salidas$Ven), 0)

```

<div class="main-container">

<div class="row">


<div class = "column column-50">

Durante la última observación de conteo DTM (`r format(max(last_data_dtm$date), "%d-%b")`) se observaron los siguientes flujos:

```{r table_dtm, echo=FALSE, warning=FALSE, message=FALSE}

ultimos_flujos <- last_data_dtm |> 
  ungroup() |> 
  filter(date == max(last_data_dtm$date)) |> 
  select(level, Tipo, Total, Ven, Otras) |> 
  rename(Punto = level) |> 
  mutate(Tipo = replace(Tipo, Tipo == "entradas", "Entradas")) |> 
  mutate(Tipo = replace(Tipo, Tipo == "salidas", "Salidas"))


ultimos_flujos |>
  group_by(Tipo) |>
  gt() |> 
  tab_style(
    style = cell_text(size = px(12), indent = px(20)),
    locations = cells_body()) |> 
  # tab_header(
  #   title = md("Anexo 2b: Proyección de CRI necesarios"),
  #   subtitle = "Para los próximos 30 días por región, socio y tipo de insumo"
  # ) |> 
  # tab_source_note(
  #   source_note = md(
  #     "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  #   )
  # ) |> 
    opt_row_striping(row_striping = TRUE) |> 
  tab_options(data_row.padding = px(1),
                heading.padding = px(3),
                heading.title.font.size = px(14),
                heading.subtitle.font.size = px(12),
                column_labels.font.size = px(12),
                column_labels.font.weight = px(12),
                row_group.font.size = px(13),
                row_group.padding = px(2),
                source_notes.font.size = px(9),
                table.width = pct(100))

# display_unhcr_pal(10, "pal_unhcr")

```

</div>

<div class = "column column-5">
   
</div>

<div class = "column column-45">

En promedio, en las últimas 4 semanas de observaciones, se contaron **`r tot_entradas_promedio` entradas diarias** (`r ven_entradas_promedio` de personas venezolanas) y **`r tot_salidas_promedio` salidas diarias** (`r ven_salidas_promedio` de personas venezolanas) por un **saldo promedio de `r tot_entradas_promedio - tot_salidas_promedio` personas** (`r ven_entradas_promedio - ven_salidas_promedio` de personas venezolanas).

Durante los últimos 12 meses, el saldo diario según conteos DTM ha sido de **`r year_tot_entradas_promedio - year_tot_salidas_promedio` personas** (`r year_ven_entradas_promedio - year_ven_salidas_promedio` de personas venezolanas).

Cabe resaltar que estas cifras no corresponden necesariamente a las estimaciones del GTRM.

Dashboard DTM de conteos en frontera: [ ](https://app.powerbi.com/view?r=eyJrIjoiZjQyMzhlZjMtNjU1OS00OTJiLTk1YWMtZjI4NWEzYTYyNTg4IiwidCI6IjE1ODgyNjJkLTIzZmItNDNiNC1iZDZlLWJjZTQ5YzhlNjE4NiIsImMiOjh9)

</div>

</div>

</div>


\newpage

## Flujos regulares
```{r snm_activityinfo_setup, echo=FALSE, warning=FALSE}

activityInfoToken(Sys.getenv('ACTIVITYINFO_API'), prompt = FALSE)

snm_data <- queryTable("cxcy0gmm144dgd8b") |> 
  dplyr::filter(Update == max(Update)) |> 
  dplyr::filter(grepl("2024|2023", Mes))

snm_month <- as.character(month(max(snm_data$Update), label = TRUE))


```

La Superintendencia Nacional de Migraciones reporta los siguientes flujos de ingreso y salidas regulares (todas las nacionalidades) durante los últimos 12 meses:
```{r snm_activityinfo,dpi = 200,  echo=FALSE, warning=FALSE, fig.height=3.5}
# Entries and exits total since Jan 2023 by month

tot_snm <- snm_data |> 
  select(Flujos, Mes, Total, Update) |> 
  group_by(Flujos, Mes, Update) |> 
  summarise_at(vars("Total"), sum, na.rm = TRUE) |> 
  ungroup() |> 
  mutate(Mes = paste(Mes, "-01", sep="")) |> 
  mutate(Mes = ymd(Mes)) |> 
  mutate(Update = ymd(Update)) |> 
  mutate(Tot_Days_Mes = days_in_month(Mes)) |> 
  mutate(Tot_Days_Mes = if_else(year(Update) != year(Sys.Date()), Tot_Days_Mes, if_else(month(Update) == month(Mes), as.numeric(day(Update)), Tot_Days_Mes))) |> 
  filter(Tot_Days_Mes > 2) |> #With just one day of data results can be inaccurate
  mutate(Promedio_Diario = round(Total / Tot_Days_Mes, 0))

tot_snm_saldo <- tot_snm |> 
  select(Flujos, Mes, Total) |> 
  pivot_wider(names_from = Flujos, values_from = Total) |>
  mutate(Saldo = Ingresos - Salidas) |> 
  mutate(Flujos = "") |> 
  select(Mes, Saldo)

tot_snm <- tot_snm |> 
  select(Flujos, Mes, Promedio_Diario) 
  # group_by(Flujos)  |> 
  # slice_tail(n = 12) |> 
  # ungroup()

  
# ggplot(data = tot_snm) +
#   geom_col(aes(Mes,
#     Saldo,
#     fill = "Saldo Mensual"
#   ),
#   width = 6
#   ) +
#    geom_text_repel(
#     aes(Mes, Saldo, label = Saldo),
#     size = 3,
#  #   hjust = -2,
#      direction = "y",
#      box.padding = unit(1, "lines"),
#      point.padding = unit(1, "lines"),
#      segment.color = NA,
#      min.segment.length = 0
#     # nudge_y = 2
#     # segment.color = NA,
#     # show.legend = FALSE
#   ) +
#   geom_line(aes(Mes,
#     Ingresos,
#     color = "Ingresos"
#   ),
#   size = 0.7
#   ) +
#      geom_text_repel(
#     aes(Mes, Ingresos, label = Ingresos),
#     size = 3,
#  #   hjust = -2,
#      direction = "y",
#      box.padding = unit(1, "lines"),
#      point.padding = unit(1, "lines"),
#      segment.color = NA,
#      min.segment.length = 0
#     # nudge_y = 2
#     # segment.color = NA,
#     # show.legend = FALSE
#   ) +
#   geom_line(aes(Mes,
#     Salidas,
#     color = "Salidas"
#   ),
#   size = 0.7
#   ) +
#      geom_text_repel(
#     aes(Mes, Salidas, label = Salidas),
#     size = 3,
#  #   hjust = -2,
#      direction = "y",
#      box.padding = unit(1, "lines"),
#      point.padding = unit(1, "lines"),
#      segment.color = NA,
#      min.segment.length = 0
#     # nudge_y = 2
#     # segment.color = NA,
#     # show.legend = FALSE
#   ) +
#   scale_fill_manual(values = setNames(
#     unhcr_pal(n = 1, "pal_blue"),
#     "Saldo Mensual"
#   )) +
#   scale_color_manual(values = setNames(
#     unhcr_pal(n = 1, "pal_red"),
#     "Ingresos"
#   )) +
#   scale_color_manual(values = setNames(
#     unhcr_pal(n = 1, "pal_green"),
#     "Salidas"
#   )) +
#   scale_x_continuous(breaks = pretty_breaks(n = nrow(tot_snm))) +
#   scale_y_continuous("Saldo Mensual",
#     expand = expansion(c(0, 0.2)),
#     breaks = pretty_breaks(),
#     sec.axis = sec_axis(~ . / 10,
#       breaks = pretty_breaks(),
#       name = "Flujos diarios"
#     )
#   ) +
#   theme(
#      panel.background = element_rect(fill = "white"),
#  #   panel.grid = element_blank(),
#      panel.grid.major.y = element_blank(),
#      panel.grid.major.x = element_blank(),
#     axis.ticks = element_blank(),
#     strip.background = element_rect(colour = "white", fill = "white"),
#     axis.text.x = element_text(size=9,
#         family="Lato"),
#     axis.text.y = element_blank(),
#     axis.line.x = element_line(colour = "black"),
#     text = element_text(size=9,
#         family="Lato"),
#     strip.text = element_text(size=12, face = "bold"),
#     title = element_text(size=14,
#         family="Lato", face = "bold"),
#     plot.caption = element_text(size=6,
#         family="Lato", face = "plain"),
#     legend.position = "bottom",
#     legend.title = element_blank(),
#      axis.title = element_blank(),
#      panel.spacing = unit(1, "lines")  # Adjust the space between facets
#    )
# 



# Plot
ggplot(tot_snm, 
       aes(
  x = Mes,
  y = Promedio_Diario,
  color = Flujos
)) +
#    annotate("rect", xmin = max(last_data_dtm$date), xmax = as.Date(Inf), ymin = -Inf, ymax = Inf, fill = "white", alpha = 0.8) +
  geom_line(size = 0.7) +
  geom_point(size = 2) +
  labs(
 #   title = "Flujos en frontera",
    y = "Personas",
    caption = "Fuente: SNM"
  ) +
#   scale_x_continuous(
#     breaks = last_data_dtm$date,
# #    limits = c(start_date, max(all_data_dtm$date)+7)
#     labels = format(last_data_dtm$date, "%d-%b")
#   ) +
  # scale_x_date(
  #   date_labels="%b %Y", 
  #   date_breaks  = all_data_dtm$date,
  #              limits = c(start_date, max(all_data_dtm$date)+7)
  #              ) +
  # coord_cartesian(clip = "off") +
  # facet_wrap(~ level, ncol = 2, scales='free') +
  scale_y_continuous(
    expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(n = 4),
#    labels = label_number(scale_cut = cut_short_scale())
    limits = c(min(tot_snm$Promedio_Diario) * 0.8, max(tot_snm$Promedio_Diario) * 1.1)
  ) +
  scale_color_unhcr_d(
    palette = "pal_unhcr",
    nmax = 10,
    order = c(1, 3)
  ) +
  geom_text_repel(
    aes(label = Promedio_Diario),
    size = 3,
 #   hjust = -2,
     direction = "y",
     box.padding = unit(1, "lines"),
     point.padding = unit(1, "lines"),
     segment.color = NA,
     min.segment.length = 0
    # nudge_y = 2
    # segment.color = NA,
    # show.legend = FALSE
  ) +
  # geom_text(
  #   aes(label = Total),
  #   nudge_x = 0.25,
  #   nudge_y = 20,
  #   check_overlap = TRUE,
  #   size = 7
  # ) +
  theme(
     panel.background = element_rect(fill = "white"),
 #   panel.grid = element_blank(),
     panel.grid.major.y = element_blank(),
     panel.grid.major.x = element_blank(),
    axis.ticks = element_blank(),
    strip.background = element_rect(colour = "white", fill = "white"),
    axis.text.x = element_text(size=9,
        family="Lato"),
    axis.text.y = element_blank(),
    axis.line.x = element_line(colour = "black"),
    text = element_text(size=9,
        family="Lato"),
    strip.text = element_text(size=12, face = "bold"),
    title = element_text(size=14,
        family="Lato", face = "bold"),
    plot.caption = element_text(size=6,
        family="Lato", face = "plain"),
    legend.position = "bottom",
    legend.title = element_blank(),
     axis.title = element_blank(),
     panel.spacing = unit(1, "lines")  # Adjust the space between facets
   )

saldo_2024_tot <- snm_data |> 
  group_by(Flujos) |> 
  summarise_at(vars("Total"), sum, na.rm = TRUE) |> 
  ungroup() |> 
  pivot_wider(names_from = "Flujos", values_from = "Total") |> 
  mutate(Saldo = Ingresos - Salidas)

saldo_total <- format(sum(saldo_2024_tot$Saldo), big.mark = ",")


# Overall chart since Jan 2023

# PCF con más flujos





```
Entre el 1/Ene 2023 y el `r day(max(snm_data$Update))`/`r snm_month` de 2024, el **saldo total de flujos regulares ha sido `r saldo_total`**.

<br>

::: row

::: column

```{r snm_frontera, dpi = 200,  echo=FALSE, warning=FALSE, fig.height=10}

snm_frontera <- snm_data |> 
  dplyr::filter(grepl("2024", Mes)) |> 
  select(Flujos, Frontera, Total) |> 
  group_by(Flujos, Frontera) |> 
  summarise_at(vars("Total"), sum, na.rm = TRUE) |> 
  pivot_wider(names_from = Flujos, values_from = Total) |> 
  mutate(Total = Ingresos + Salidas) |> 
  mutate(across(Frontera, str_replace, 'Aeropuerto_Puerto', 'Aero/Puertos')) 


ggplot(snm_frontera) +
  geom_col(aes(-Ingresos,
    reorder(Frontera, Total),
    fill = "Ingresos"
  ),
  width = 0.7
  ) +
  geom_col(aes(Salidas,
    reorder(Frontera, Total),
    fill = "Salidas"
  ),
  width = 0.7
  ) +
  geom_text(aes(-Ingresos,
    Frontera,
    label = format(Ingresos, big.mark = ",")
  ),
  hjust = 1.25,
  size = 14 / .pt
  ) +
  geom_text(aes(Salidas,
    Frontera,
    label = format(Salidas, big.mark = ",")
  ),
  hjust = -0.25,
  size = 14 / .pt
  ) +
  labs(
    title = "Ingresos y salidas totales",
    subtitle = "Por frontera en 2024",
    caption = "Fuente: Fuente: SNM"
  ) +
  scale_x_continuous(expand = expansion(c(0.2, 0.2)),
      limits = c(-max(snm_frontera$Ingresos) * 1.4, max(snm_frontera$Salidas) * 1.4)
) +
  scale_fill_manual(values = setNames(
    unhcr_pal(n = 3, "pal_unhcr")[c(2, 1)],
    c("Ingresos", "Salidas")
  )) +
  theme(
     panel.background = element_rect(fill = "white"),
 #   panel.grid = element_blank(),
     panel.grid.major.y = element_blank(),
     panel.grid.major.x = element_blank(),
    axis.ticks = element_blank(),
    strip.background = element_rect(colour = "white", fill = "white"),
    axis.text.y = element_text(size=16,
        family="Lato"),
    axis.text.x = element_blank(),
    axis.line.y = element_line(colour = "black"),
    text = element_text(size=16,
        family="Lato"),
    strip.text = element_text(size=18, face = "bold"),
    title = element_text(size=22,
        family="Lato", face = "bold"),
    plot.caption = element_text(size=12,
        family="Lato", face = "plain"),
    legend.position = "bottom",
    legend.title = element_blank(),
     axis.title = element_blank(),
     panel.spacing = unit(1, "lines")  # Adjust the space between facets
   )
```
  
::: 

::: column
```{r snm_puntos, dpi = 200,  echo=FALSE, warning=FALSE, fig.height=10}

snm_puntos <- snm_data |> 
  dplyr::filter(grepl("2024", Mes)) |> 
  select(Flujos, Punto, Total) |> 
  mutate(across(Punto, str_replace, 'PCF TUMBES-CEBAFEV1PER', 'CEBAF (Tumbes)')) |> 
  mutate(across(Punto, str_replace, 'PCF TUMBES-CEBAFEV1ECU', 'CEBAF (Tumbes)')) |> 
  mutate(across(Punto, str_replace, 'A.I.J.CH.', 'Aeropuerto (Lima)')) |> 
  mutate(across(Punto, str_replace, 'STA. ROSA', 'Sta. Rosa (Tacna)')) |> 
  mutate(across(Punto, str_replace, 'A.I.J.CH.', 'Aeropuerto (Lima)')) |> 
  mutate(across(Punto, str_replace, 'CEBAF DESAGUADERO', 'CEBAF (Puno)')) |> 
  mutate(across(Punto, str_replace, 'DESAGUADERO', 'Desaguadero (Puno)')) |> 
  mutate(across(Punto, str_replace, 'PCM CUSCO AIAVA', 'Aeropuerto (Cusco)')) |> 
  mutate(across(Punto, str_replace, 'PCF CARANCAS', 'Carancas (Puno)')) |> 
  mutate(across(Punto, str_replace, 'KASANI', 'Kasani (Puno)')) |> 
  mutate(across(Punto, str_replace, 'PUERTO CALLAO', 'Puerto (Callao)')) |> 
  mutate(across(Punto, str_replace, 'CEBAF LA TINA - MACARA', 'CEBAF (La Tina)')) |> 
  group_by(Flujos, Punto) |> 
  summarise_at(vars("Total"), sum, na.rm = TRUE) |> 
  pivot_wider(names_from = Flujos, values_from = Total) |> 
  mutate(Total = Ingresos + Salidas) |> 
  arrange(desc(Total)) |> 
  slice_head(n = 10)

ggplot(snm_puntos) +
  geom_col(aes(-Ingresos,
    reorder(Punto, Total),
    fill = "Ingresos"
  ),
  width = 0.7
  ) +
  geom_col(aes(Salidas,
    reorder(Punto, Total),
    fill = "Salidas"
  ),
  width = 0.7
  ) +
  geom_text(aes(-Ingresos,
    Punto,
    label = format(Ingresos, big.mark = ",")
  ),
  hjust = 1.25,
  size = 14 / .pt
  ) +
  geom_text(aes(Salidas,
    Punto,
    label = format(Salidas, big.mark = ",")
  ),
  hjust = -0.25,
  size = 14 / .pt
  ) +
  labs(
    title = "Puntos Fronterizos",
    subtitle = "Más utilizados en 2024",
    caption = "Fuente: Fuente: SNM"
  ) +
  scale_x_continuous(expand = expansion(c(0.2, 0.2)),
      limits = c(-max(snm_puntos$Ingresos) * 1.4, max(snm_puntos$Salidas) * 1.4)
) +
  scale_fill_manual(values = setNames(
    unhcr_pal(n = 3, "pal_unhcr")[c(2, 1)],
    c("Ingresos", "Salidas")
  )) +
  theme(
     panel.background = element_rect(fill = "white"),
 #   panel.grid = element_blank(),
     panel.grid.major.y = element_blank(),
     panel.grid.major.x = element_blank(),
    axis.ticks = element_blank(),
    strip.background = element_rect(colour = "white", fill = "white"),
    axis.text.y = element_text(size=16,
        family="Lato"),
    axis.text.x = element_blank(),
    axis.line.y = element_line(colour = "black"),
    text = element_text(size=16,
        family="Lato"),
    strip.text = element_text(size=18, face = "bold"),
    title = element_text(size=22,
        family="Lato", face = "bold"),
    plot.caption = element_text(size=12,
        family="Lato", face = "plain"),
    legend.position = "bottom",
    legend.title = element_blank(),
     axis.title = element_blank(),
     panel.spacing = unit(1, "lines")  # Adjust the space between facets
   )
```
::: 

::: 

\newpage

::: row
::: column

```{r snm_activityinfo_ecu, echo=FALSE, warning=FALSE}
# Entries and exits total since Jan 2023 by month

tot_snm_ecu <- snm_data |> 
  filter(Nacionalidad == "ECUATORIANA") |> 
  select(Flujos, Mes, Total, Update) |> 
  group_by(Flujos, Mes, Update) |> 
  summarise_at(vars("Total"), sum, na.rm = TRUE) |> 
  ungroup() |> 
  mutate(Mes = paste(Mes, "-01", sep="")) |> 
  mutate(Mes = ymd(Mes)) |> 
  mutate(Update = ymd(Update)) |> 
  mutate(Tot_Days_Mes = days_in_month(Mes)) |> 
  mutate(Tot_Days_Mes = if_else(month(Update) == month(Mes), as.numeric(day(Update)), Tot_Days_Mes)) |> 
  filter(Tot_Days_Mes > 2) |> #With just one day of data results can be inaccurate
  mutate(Promedio_Diario = round(Total / Tot_Days_Mes, 0)) 


tot_snm_saldo_ecu <- tot_snm_ecu |> 
  select(Flujos, Mes, Total) |> 
  pivot_wider(names_from = Flujos, values_from = Total) |>
  mutate(Saldo = Ingresos - Salidas) |> 
  mutate(Flujos = "") |> 
  select(Mes, Saldo) |> 
  mutate(Q = quarter(Mes)) |> 
  mutate(y = year(Mes)) |> 
  mutate(Q = paste( y,"-", "Q", Q, sep = "")) |> 
  group_by(Q) |> 
  summarise_at(vars("Saldo"), sum, na.rm = TRUE) 
#  slice_tail(n = 4)


tot_snm_ecu <- tot_snm_ecu |> 
  select(Flujos, Mes, Promedio_Diario) |> 
  pivot_wider(names_from = Flujos, values_from = Promedio_Diario) |> 
  mutate(Total = Ingresos + Salidas) |> 
  # group_by(Flujos) |> 
  # slice_tail(n = 12) |> 
  # ungroup()
  mutate(
    last_value = Mes == max(Mes),
    top_2 = Total %in% sort(unique(Total), decreasing = TRUE)[1:2],
    bottom_2 = Total %in% sort(unique(Total))[1:2]
  ) |> 
  select(Mes, Ingresos, Salidas, last_value, top_2, bottom_2) |> 
  pivot_longer(c(Ingresos, Salidas), names_to = "Flujos", values_to = "Promedio_Diario")



# Plot
ggplot(tot_snm_ecu, 
       aes(
  x = Mes,
  y = Promedio_Diario,
  color = Flujos
)) +
#    annotate("rect", xmin = max(last_data_dtm$date), xmax = as.Date(Inf), ymin = -Inf, ymax = Inf, fill = "white", alpha = 0.8) +
  geom_line(size = 0.7) +
  geom_point(size = 2) +
  labs(
    title = "Personas ecuatorianas",
    subtitle = "Promedio de flujos diarios",
    y = "Personas",
    caption = "Fuente: SNM"
  ) +
#   scale_x_continuous(
#     breaks = last_data_dtm$date,
# #    limits = c(start_date, max(all_data_dtm$date)+7)
#     labels = format(last_data_dtm$date, "%d-%b")
#   ) +
  # scale_x_date(
  #   date_labels="%b %Y", 
  #   date_breaks  = all_data_dtm$date,
  #              limits = c(start_date, max(all_data_dtm$date)+7)
  #              ) +
  # coord_cartesian(clip = "off") +
  # facet_wrap(~ level, ncol = 2, scales='free') +
  scale_y_continuous(
    expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(n = 4),
#    labels = label_number(scale_cut = cut_short_scale())
    limits = c(min(tot_snm_ecu$Promedio_Diario) * 0.8, max(tot_snm_ecu$Promedio_Diario) * 1.1)
  ) +
  scale_color_unhcr_d(
    palette = "pal_unhcr",
    nmax = 10,
    order = c(1, 3)
  ) +
  geom_text_repel(
    aes(label = ifelse(last_value | top_2 | bottom_2, format(Promedio_Diario, big.mark = ","), NA)),
    size = 6,
 #   hjust = -2,
     direction = "y",
     box.padding = unit(1, "lines"),
     point.padding = unit(1, "lines"),
     segment.color = NA,
     min.segment.length = 0
    # nudge_y = 2
    # segment.color = NA,
    # show.legend = FALSE
  ) +
  # geom_text(
  #   aes(label = Total),
  #   nudge_x = 0.25,
  #   nudge_y = 20,
  #   check_overlap = TRUE,
  #   size = 7
  # ) +
  theme(
     panel.background = element_rect(fill = "white"),
 #   panel.grid = element_blank(),
     panel.grid.major.y = element_blank(),
     panel.grid.major.x = element_blank(),
    axis.ticks = element_blank(),
    strip.background = element_rect(colour = "white", fill = "white"),
    axis.text.x = element_text(size=16,
        family="Lato"),
    axis.text.y = element_blank(),
    axis.line.x = element_line(colour = "black"),
    text = element_text(size=16,
        family="Lato"),
    strip.text = element_text(size=18, face = "bold"),
    title = element_text(size=22,
        family="Lato", face = "bold"),
    plot.caption = element_text(size=12,
        family="Lato", face = "plain"),
    legend.position = "bottom",
    legend.title = element_blank(),
     axis.title = element_blank(),
     panel.spacing = unit(1, "lines")  # Adjust the space between facets
   )

saldo_2024_tot_ecu <- snm_data |> 
  filter(Nacionalidad == "ECUATORIANA") |> 
  group_by(Flujos) |> 
  summarise_at(vars("Total"), sum, na.rm = TRUE) |> 
  ungroup() |> 
  pivot_wider(names_from = "Flujos", values_from = "Total") |> 
  mutate(Saldo = Ingresos - Salidas)


saldo_ecu <- format(sum(saldo_2024_tot_ecu$Saldo), big.mark = ",")


# Overall chart since Jan 2023

# PCF con más flujos





```
Entre el 1/Ene de 2023 y el `r day(max(snm_data$Update))`/`r snm_month` de 2024, el **saldo total de flujos regulares ha sido `r saldo_ecu`**.

```{r snm_saldo_ecu, dpi = 200,  echo=FALSE, warning=FALSE, fig.height=3.8}

min_saldo_ecu <- if_else(min(tot_snm_saldo_ecu$Saldo) > 0, 0, min(tot_snm_saldo_ecu$Saldo) * 1.1)
max_saldo_ecu <- if_else(max(tot_snm_saldo_ecu$Saldo) < 0, 0, max(tot_snm_saldo_ecu$Saldo) * 1.1)

# Saldo trimestral
ggplot(tot_snm_saldo_ecu, aes(x = Saldo, y = factor(Q, levels = rev(unique(Q))))) +
  geom_col(
  fill = ifelse(tot_snm_saldo_ecu$Saldo < 0, "#EF4A60", "#00B398"),
  width = 0.5
  ) +
  geom_text(aes(label = format(Saldo, big.mark = ","),
                colour = ifelse(Saldo < 0, "white", "black")),
            position = position_dodge(width = 0.7),
            hjust = -0.1,
            size = 7
  ) +
  scale_colour_identity() +  # This ensures the colours are used as is
  labs(
    title = "Saldo trimestral",
    x = "Personas",
    caption = "Fuente: SNM"
  ) +
  scale_x_continuous(
    expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(n = 4), 
    labels = label_number(scale_cut = cut_short_scale()),
    limits = c(min_saldo_ecu, max_saldo_ecu)
  ) +
  theme(
     panel.background = element_rect(fill = "white"),
 #   panel.grid = element_blank(),
     panel.grid.major.y = element_blank(),
     panel.grid.major.x = element_blank(),
    axis.ticks = element_blank(),
    strip.background = element_rect(colour = "white", fill = "white"),
    axis.text.y = element_text(size=16,
        family="Lato"),
    axis.text.x = element_blank(),
    axis.line.y = element_line(colour = "black"),
    text = element_text(size=16,
        family="Lato"),
    strip.text = element_text(size=18, face = "bold"),
    title = element_text(size=22,
        family="Lato", face = "bold"),
    plot.caption = element_text(size=12,
        family="Lato", face = "plain"),
    legend.position = "bottom",
    legend.title = element_blank(),
     axis.title = element_blank(),
     panel.spacing = unit(1, "lines")  # Adjust the space between facets
   )


```

::: 

::: column
```{r snm_activityinfo_col, echo=FALSE, warning=FALSE}
# Entries and exits total since Jan 2023 by month

tot_snm_col <- snm_data |> 
  filter(Nacionalidad == "COLOMBIANA") |> 
  select(Flujos, Mes, Total, Update) |> 
  group_by(Flujos, Mes, Update) |> 
  summarise_at(vars("Total"), sum, na.rm = TRUE) |> 
  ungroup() |> 
  mutate(Mes = paste(Mes, "-01", sep="")) |> 
  mutate(Mes = ymd(Mes)) |> 
  mutate(Update = ymd(Update)) |> 
  mutate(Tot_Days_Mes = days_in_month(Mes)) |> 
  mutate(Tot_Days_Mes = if_else(month(Update) == month(Mes), as.numeric(day(Update)), Tot_Days_Mes)) |> 
  filter(Tot_Days_Mes > 2) |> #With just one day of data results can be inaccurate
  mutate(Promedio_Diario = round(Total / Tot_Days_Mes, 0)) 

tot_snm_saldo_col <- tot_snm_col |> 
  select(Flujos, Mes, Total) |> 
  pivot_wider(names_from = Flujos, values_from = Total) |>
  mutate(Saldo = Ingresos - Salidas) |> 
  mutate(Flujos = "") |> 
  select(Mes, Saldo) |> 
  mutate(Q = quarter(Mes)) |> 
  mutate(y = year(Mes)) |> 
  mutate(Q = paste( y,"-", "Q", Q, sep = "")) |> 
  group_by(Q) |> 
  summarise_at(vars("Saldo"), sum, na.rm = TRUE)

tot_snm_col <- tot_snm_col |> 
  select(Flujos, Mes, Promedio_Diario) |> 
  pivot_wider(names_from = Flujos, values_from = Promedio_Diario) |> 
  mutate(Total = Ingresos + Salidas) |> 
  # group_by(Flujos) |> 
  # slice_tail(n = 12) |> 
  # ungroup()
  mutate(
    last_value = Mes == max(Mes),
    top_2 = Total %in% sort(unique(Total), decreasing = TRUE)[1:2],
    bottom_2 = Total %in% sort(unique(Total))[1:2]
  ) |> 
  select(Mes, Ingresos, Salidas, last_value, top_2, bottom_2) |> 
  pivot_longer(c(Ingresos, Salidas), names_to = "Flujos", values_to = "Promedio_Diario")




# Plot
ggplot(tot_snm_col, 
       aes(
  x = Mes,
  y = Promedio_Diario,
  color = Flujos
)) +
#    annotate("rect", xmin = max(last_data_dtm$date), xmax = as.Date(Inf), ymin = -Inf, ymax = Inf, fill = "white", alpha = 0.8) +
  geom_line(size = 0.7) +
  geom_point(size = 2) +
  labs(
    title = "Personas colombianas",
    subtitle = "Promedio de flujos diarios",
    y = "Personas",
    caption = "Fuente: SNM"
  ) +
#   scale_x_continuous(
#     breaks = last_data_dtm$date,
# #    limits = c(start_date, max(all_data_dtm$date)+7)
#     labels = format(last_data_dtm$date, "%d-%b")
#   ) +
  # scale_x_date(
  #   date_labels="%b %Y", 
  #   date_breaks  = all_data_dtm$date,
  #              limits = c(start_date, max(all_data_dtm$date)+7)
  #              ) +
  # coord_cartesian(clip = "off") +
  # facet_wrap(~ level, ncol = 2, scales='free') +
  scale_y_continuous(
    expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(n = 4),
#    labels = label_number(scale_cut = cut_short_scale())
    limits = c(min(tot_snm_col$Promedio_Diario) * 0.8, max(tot_snm_col$Promedio_Diario) * 1.1)
  ) +
  scale_color_unhcr_d(
    palette = "pal_unhcr",
    nmax = 10,
    order = c(1, 3)
  ) +
  geom_text_repel(
   aes(label = ifelse(last_value | top_2 | bottom_2, format(Promedio_Diario, big.mark = ","), NA)),
   size = 6,
 #   hjust = -2,
     direction = "y",
     box.padding = unit(1, "lines"),
     point.padding = unit(1, "lines"),
     segment.color = NA,
     min.segment.length = 0
    # nudge_y = 2
    # segment.color = NA,
    # show.legend = FALSE
  ) +
  # geom_text(
  #   aes(label = Total),
  #   nudge_x = 0.25,
  #   nudge_y = 20,
  #   check_overlap = TRUE,
  #   size = 7
  # ) +
  theme(
     panel.background = element_rect(fill = "white"),
 #   panel.grid = element_blank(),
     panel.grid.major.y = element_blank(),
     panel.grid.major.x = element_blank(),
    axis.ticks = element_blank(),
    strip.background = element_rect(colour = "white", fill = "white"),
    axis.text.x = element_text(size=16,
        family="Lato"),
    axis.text.y = element_blank(),
    axis.line.x = element_line(colour = "black"),
    text = element_text(size=16,
        family="Lato"),
    strip.text = element_text(size=18, face = "bold"),
    title = element_text(size=22,
        family="Lato", face = "bold"),
    plot.caption = element_text(size=12,
        family="Lato", face = "plain"),
    legend.position = "bottom",
    legend.title = element_blank(),
     axis.title = element_blank(),
     panel.spacing = unit(1, "lines")  # Adjust the space between facets
   )

saldo_2024_tot_col <- snm_data |> 
  filter(Nacionalidad == "COLOMBIANA") |> 
  group_by(Flujos) |> 
  summarise_at(vars("Total"), sum, na.rm = TRUE) |> 
  ungroup() |> 
  pivot_wider(names_from = "Flujos", values_from = "Total") |> 
  mutate(Saldo = Ingresos - Salidas)

saldo_col <- format(sum(saldo_2024_tot_col$Saldo), big.mark = ",")


# Overall chart since Jan 2023

# PCF con más flujos





```
Entre el 1/Ene de 2023 y el `r day(max(snm_data$Update))`/`r snm_month` de 2024, el **saldo total de flujos regulares ha sido `r saldo_col`**.

```{r snm_saldo_col, dpi = 200,  echo=FALSE, warning=FALSE, fig.height=3.8}

min_saldo_col <- if_else(min(tot_snm_saldo_col$Saldo) > 0, 0, min(tot_snm_saldo_col$Saldo) * 1.1)
max_saldo_col <- if_else(max(tot_snm_saldo_col$Saldo) < 0, 0, max(tot_snm_saldo_col$Saldo) * 1.1)
 
# Saldo triestral
ggplot(tot_snm_saldo_col, aes(x = Saldo, y = factor(Q, levels = rev(unique(Q))))) +
  geom_col(
  fill = ifelse(tot_snm_saldo_col$Saldo < 0, "#EF4A60", "#00B398"),
  width = 0.5
  ) +
  geom_text(aes(label = format(Saldo, big.mark = ","),
                colour = ifelse(Saldo < 0, "white", "black")),
            position = position_dodge(width = 0.7),
            hjust = -0.1,
            size = 7
  ) +
  scale_colour_identity() +  # This ensures the colours are used as is
  labs(
    title = "Saldo trimestral",
    x = "Personas",
    caption = "Fuente: SNM"
  ) +
  scale_x_continuous(
    expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(n = 4), 
    labels = label_number(scale_cut = cut_short_scale()),
    limits = c(min_saldo_col, max_saldo_col)
  ) +
  theme(
     panel.background = element_rect(fill = "white"),
 #   panel.grid = element_blank(),
     panel.grid.major.y = element_blank(),
     panel.grid.major.x = element_blank(),
    axis.ticks = element_blank(),
    strip.background = element_rect(colour = "white", fill = "white"),
    axis.text.y = element_text(size=16,
        family="Lato"),
    axis.text.x = element_blank(),
    axis.line.y = element_line(colour = "black"),
    text = element_text(size=16,
        family="Lato"),
    strip.text = element_text(size=18, face = "bold"),
    title = element_text(size=22,
        family="Lato", face = "bold"),
    plot.caption = element_text(size=12,
        family="Lato", face = "plain"),
    legend.position = "bottom",
    legend.title = element_blank(),
     axis.title = element_blank(),
     panel.spacing = unit(1, "lines")  # Adjust the space between facets
   )


```

:::
:::

<br>

::: row
::: column

```{r snm_activityinfo_bol, echo=FALSE, warning=FALSE}
# Entries and exits total since Jan 2023 by month

tot_snm_bol <- snm_data |> 
  filter(Nacionalidad == "BOLIVIANA") |> 
  select(Flujos, Mes, Total, Update) |> 
  group_by(Flujos, Mes, Update) |> 
  summarise_at(vars("Total"), sum, na.rm = TRUE) |> 
  ungroup() |> 
  mutate(Mes = paste(Mes, "-01", sep="")) |> 
  mutate(Mes = ymd(Mes)) |> 
  mutate(Update = ymd(Update)) |> 
  mutate(Tot_Days_Mes = days_in_month(Mes)) |> 
  mutate(Tot_Days_Mes = if_else(month(Update) == month(Mes), as.numeric(day(Update)), Tot_Days_Mes)) |> 
  filter(Tot_Days_Mes > 2) |> #With just one day of data results can be inaccurate
  mutate(Promedio_Diario = round(Total / Tot_Days_Mes, 0)) 

tot_snm_saldo_bol <- tot_snm_bol |> 
  select(Flujos, Mes, Total) |> 
  pivot_wider(names_from = Flujos, values_from = Total) |>
  mutate(Saldo = Ingresos - Salidas) |> 
  mutate(Flujos = "") |> 
  select(Mes, Saldo) |> 
  mutate(Q = quarter(Mes)) |> 
  mutate(y = year(Mes)) |> 
  mutate(Q = paste( y,"-", "Q", Q, sep = "")) |> 
  group_by(Q) |> 
  summarise_at(vars("Saldo"), sum, na.rm = TRUE)

tot_snm_bol <- tot_snm_bol |> 
  select(Flujos, Mes, Promedio_Diario) |> 
  pivot_wider(names_from = Flujos, values_from = Promedio_Diario) |> 
  mutate(Total = Ingresos + Salidas) |> 
  # group_by(Flujos) |> 
  # slice_tail(n = 12) |> 
  # ungroup()
  mutate(
    last_value = Mes == max(Mes),
    top_2 = Total %in% sort(unique(Total), decreasing = TRUE)[1:2],
    bottom_2 = Total %in% sort(unique(Total))[1:2]
  ) |> 
  select(Mes, Ingresos, Salidas, last_value, top_2, bottom_2) |> 
  pivot_longer(c(Ingresos, Salidas), names_to = "Flujos", values_to = "Promedio_Diario")



# Plot
ggplot(tot_snm_bol, 
       aes(
  x = Mes,
  y = Promedio_Diario,
  color = Flujos
)) +
#    annotate("rect", xmin = max(last_data_dtm$date), xmax = as.Date(Inf), ymin = -Inf, ymax = Inf, fill = "white", alpha = 0.8) +
  geom_line(size = 0.7) +
  geom_point(size = 2) +
  labs(
    title = "Personas bolivianas",
    subtitle = "Promedio de flujos diarios",
    y = "Personas",
    caption = "Fuente: SNM"
  ) +
#   scale_x_continuous(
#     breaks = last_data_dtm$date,
# #    limits = c(start_date, max(all_data_dtm$date)+7)
#     labels = format(last_data_dtm$date, "%d-%b")
#   ) +
  # scale_x_date(
  #   date_labels="%b %Y", 
  #   date_breaks  = all_data_dtm$date,
  #              limits = c(start_date, max(all_data_dtm$date)+7)
  #              ) +
  # coord_cartesian(clip = "off") +
  # facet_wrap(~ level, ncol = 2, scales='free') +
  scale_y_continuous(
    expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(n = 4),
#    labels = label_number(scale_cut = cut_short_scale())
    limits = c(min(tot_snm_bol$Promedio_Diario) * 0.8, max(tot_snm_bol$Promedio_Diario) * 1.1)
  ) +
  scale_color_unhcr_d(
    palette = "pal_unhcr",
    nmax = 10,
    order = c(1, 3)
  ) +
  geom_text_repel(
   aes(label = ifelse(last_value | top_2 | bottom_2, format(Promedio_Diario, big.mark = ","), NA)),
   size = 6,
 #   hjust = -2,
     direction = "y",
     box.padding = unit(1, "lines"),
     point.padding = unit(1, "lines"),
     segment.color = NA,
     min.segment.length = 0
    # nudge_y = 2
    # segment.color = NA,
    # show.legend = FALSE
  ) +
  # geom_text(
  #   aes(label = Total),
  #   nudge_x = 0.25,
  #   nudge_y = 20,
  #   check_overlap = TRUE,
  #   size = 7
  # ) +
  theme(
     panel.background = element_rect(fill = "white"),
 #   panel.grid = element_blank(),
     panel.grid.major.y = element_blank(),
     panel.grid.major.x = element_blank(),
    axis.ticks = element_blank(),
    strip.background = element_rect(colour = "white", fill = "white"),
    axis.text.x = element_text(size=16,
        family="Lato"),
    axis.text.y = element_blank(),
    axis.line.x = element_line(colour = "black"),
    text = element_text(size=16,
        family="Lato"),
    strip.text = element_text(size=18, face = "bold"),
    title = element_text(size=22,
        family="Lato", face = "bold"),
    plot.caption = element_text(size=12,
        family="Lato", face = "plain"),
    legend.position = "bottom",
    legend.title = element_blank(),
     axis.title = element_blank(),
     panel.spacing = unit(1, "lines")  # Adjust the space between facets
   )

saldo_2024_tot_bol <- snm_data |> 
  filter(Nacionalidad == "BOLIVIANA") |> 
  group_by(Flujos) |> 
  summarise_at(vars("Total"), sum, na.rm = TRUE) |> 
  ungroup() |> 
  pivot_wider(names_from = "Flujos", values_from = "Total") |> 
  mutate(Saldo = Ingresos - Salidas)

saldo_bol <- format(sum(saldo_2024_tot_bol$Saldo), big.mark = ",")


# Overall chart since Jan 2023

# PCF con más flujos


```
Entre el 1/Ene de 2023 y el `r day(max(snm_data$Update))`/`r snm_month` de 2024, el **saldo total de flujos regulares ha sido `r saldo_bol`**.

```{r snm_saldo_bol, dpi = 200,  echo=FALSE, warning=FALSE, fig.height=3.8}

min_saldo_bol <- if_else(min(tot_snm_saldo_bol$Saldo) > 0, 0, min(tot_snm_saldo_bol$Saldo) * 1.1)
max_saldo_bol <- if_else(max(tot_snm_saldo_bol$Saldo) < 0, 0, max(tot_snm_saldo_bol$Saldo) * 1.1)
 
# Saldo triestral
ggplot(tot_snm_saldo_bol, aes(x = Saldo, y = factor(Q, levels = rev(unique(Q))))) +
  geom_col(
  fill = ifelse(tot_snm_saldo_bol$Saldo < 0, "#EF4A60", "#00B398"),
  width = 0.5
  ) +
  geom_text(aes(label = format(Saldo, big.mark = ","),
                colour = ifelse(Saldo < 0, "white", "black")),
            position = position_dodge(width = 0.7),
            hjust = -0.1,
            size = 7
  ) +
  scale_colour_identity() +  # This ensures the colours are used as is
  labs(
    title = "Saldo trimestral",
    x = "Personas",
    caption = "Fuente: SNM"
  ) +
  scale_x_continuous(
    expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(n = 4), 
    labels = label_number(scale_cut = cut_short_scale()),
    limits = c(min_saldo_bol, max_saldo_bol)
  ) +
  theme(
     panel.background = element_rect(fill = "white"),
 #   panel.grid = element_blank(),
     panel.grid.major.y = element_blank(),
     panel.grid.major.x = element_blank(),
    axis.ticks = element_blank(),
    strip.background = element_rect(colour = "white", fill = "white"),
    axis.text.y = element_text(size=16,
        family="Lato"),
    axis.text.x = element_blank(),
    axis.line.y = element_line(colour = "black"),
    text = element_text(size=16,
        family="Lato"),
    strip.text = element_text(size=18, face = "bold"),
    title = element_text(size=22,
        family="Lato", face = "bold"),
    plot.caption = element_text(size=12,
        family="Lato", face = "plain"),
    legend.position = "bottom",
    legend.title = element_blank(),
     axis.title = element_blank(),
     panel.spacing = unit(1, "lines")  # Adjust the space between facets
   )


```

::: 

::: column

```{r snm_activityinfo_ven, echo=FALSE, warning=FALSE}
# Entries and exits total since Jan 2023 by month

tot_snm_ven <- snm_data |> 
  filter(Nacionalidad == "VENEZOLANA") |> 
  select(Flujos, Mes, Total, Update) |> 
  group_by(Flujos, Mes, Update) |> 
  summarise_at(vars("Total"), sum, na.rm = TRUE) |> 
  ungroup() |> 
  mutate(Mes = paste(Mes, "-01", sep="")) |> 
  mutate(Mes = ymd(Mes)) |> 
  mutate(Update = ymd(Update)) |> 
  mutate(Tot_Days_Mes = days_in_month(Mes)) |> 
  mutate(Tot_Days_Mes = if_else(month(Update) == month(Mes), as.numeric(day(Update)), Tot_Days_Mes)) |> 
  filter(Tot_Days_Mes > 2) |> #With just one day of data results can be inaccurate
  mutate(Promedio_Diario = round(Total / Tot_Days_Mes, 0)) 


tot_snm_saldo_ven <- tot_snm_ven |> 
  select(Flujos, Mes, Total) |> 
  pivot_wider(names_from = Flujos, values_from = Total) |>
  mutate(Saldo = Ingresos - Salidas) |> 
  mutate(Flujos = "") |> 
  select(Mes, Saldo) |> 
  mutate(Q = quarter(Mes)) |> 
  mutate(y = year(Mes)) |> 
  mutate(Q = paste( y,"-", "Q", Q, sep = "")) |> 
  group_by(Q) |> 
  summarise_at(vars("Saldo"), sum, na.rm = TRUE)

tot_snm_ven <- tot_snm_ven |> 
  select(Flujos, Mes, Promedio_Diario) |> 
  pivot_wider(names_from = Flujos, values_from = Promedio_Diario) |> 
  mutate(Total = Ingresos + Salidas) |> 
  # group_by(Flujos) |> 
  # slice_tail(n = 12) |> 
  # ungroup()
  mutate(
    last_value = Mes == max(Mes),
    top_2 = Total %in% sort(unique(Total), decreasing = TRUE)[1:2],
    bottom_2 = Total %in% sort(unique(Total))[1:2]
  ) |> 
  select(Mes, Ingresos, Salidas, last_value, top_2, bottom_2) |> 
  pivot_longer(c(Ingresos, Salidas), names_to = "Flujos", values_to = "Promedio_Diario")




# Plot
ggplot(tot_snm_ven, 
       aes(
  x = Mes,
  y = Promedio_Diario,
  color = Flujos
)) +
#    annotate("rect", xmin = max(last_data_dtm$date), xmax = as.Date(Inf), ymin = -Inf, ymax = Inf, fill = "white", alpha = 0.8) +
  geom_line(size = 0.7) +
  geom_point(size = 2) +
  labs(
    title = "Personas venezolanas",
    subtitle = "Promedio de flujos diarios",
    y = "Personas",
    caption = "Fuente: SNM"
  ) +
#   scale_x_continuous(
#     breaks = last_data_dtm$date,
# #    limits = c(start_date, max(all_data_dtm$date)+7)
#     labels = format(last_data_dtm$date, "%d-%b")
#   ) +
  # scale_x_date(
  #   date_labels="%b %Y", 
  #   date_breaks  = all_data_dtm$date,
  #              limits = c(start_date, max(all_data_dtm$date)+7)
  #              ) +
  # coord_cartesian(clip = "off") +
  # facet_wrap(~ level, ncol = 2, scales='free') +
  scale_y_continuous(
    expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(n = 4),
#    labels = label_number(scale_cut = cut_short_scale())
    limits = c(min(tot_snm_ven$Promedio_Diario) * 0.8, max(tot_snm_ven$Promedio_Diario) * 1.1)
  ) +
  scale_color_unhcr_d(
    palette = "pal_unhcr",
    nmax = 10,
    order = c(1, 3)
  ) +
  geom_text_repel(
   aes(label = ifelse(last_value | top_2 | bottom_2, format(Promedio_Diario, big.mark = ","), NA)),
   size = 6,
 #   hjust = -2,
     direction = "y",
     box.padding = unit(1, "lines"),
     point.padding = unit(1, "lines"),
     segment.color = NA,
     min.segment.length = 0
    # nudge_y = 2
    # segment.color = NA,
    # show.legend = FALSE
  ) +
  # geom_text(
  #   aes(label = Total),
  #   nudge_x = 0.25,
  #   nudge_y = 20,
  #   check_overlap = TRUE,
  #   size = 7
  # ) +
  theme(
     panel.background = element_rect(fill = "white"),
 #   panel.grid = element_blank(),
     panel.grid.major.y = element_blank(),
     panel.grid.major.x = element_blank(),
    axis.ticks = element_blank(),
    strip.background = element_rect(colour = "white", fill = "white"),
    axis.text.x = element_text(size=16,
        family="Lato"),
    axis.text.y = element_blank(),
    axis.line.x = element_line(colour = "black"),
    text = element_text(size=16,
        family="Lato"),
    strip.text = element_text(size=18, face = "bold"),
    title = element_text(size=22,
        family="Lato", face = "bold"),
    plot.caption = element_text(size=12,
        family="Lato", face = "plain"),
    legend.position = "bottom",
    legend.title = element_blank(),
     axis.title = element_blank(),
     panel.spacing = unit(1, "lines")  # Adjust the space between facets
   )

saldo_2024_tot_ven <- snm_data |> 
  filter(Nacionalidad == "VENEZOLANA") |> 
  group_by(Flujos) |> 
  summarise_at(vars("Total"), sum, na.rm = TRUE) |> 
  ungroup() |> 
  pivot_wider(names_from = "Flujos", values_from = "Total") |> 
  mutate(Saldo = Ingresos - Salidas)


saldo_ven <- format(sum(saldo_2024_tot_ven$Saldo), big.mark = ",")


# Overall chart since Jan 2023

# PCF con más flujos





```
Entre el 1/Ene de 2023 y el `r day(max(snm_data$Update))`/`r snm_month` de 2024, el **saldo total de flujos regulares ha sido `r saldo_ven`**.

```{r snm_saldo_ven, dpi = 200,  echo=FALSE, warning=FALSE, fig.height=3.8}

min_saldo_ven <- if_else(min(tot_snm_saldo_ven$Saldo) > 0, 0, min(tot_snm_saldo_ven$Saldo) * 1.1)
max_saldo_ven <- if_else(max(tot_snm_saldo_ven$Saldo) < 0, 0, max(tot_snm_saldo_ven$Saldo) * 1.1)

# Saldo trimestral
ggplot(tot_snm_saldo_ven, aes(x = Saldo, y = factor(Q, levels = rev(unique(Q))))) +
  geom_col(
  fill = ifelse(tot_snm_saldo_ven$Saldo < 0, "#EF4A60", "#00B398"),
    width = 0.5
  ) +
  geom_text(aes(label = format(Saldo, big.mark = ","),
                colour = ifelse(Saldo < 0, "white", "black")),
            position = position_dodge(width = 0.7),
            hjust = -0.1,
            size = 7
  ) +
  scale_colour_identity() +  # This ensures the colours are used as is
  labs(
    title = "Saldo trimestral",
    x = "Personas",
    caption = "Fuente: SNM"
  ) +
  scale_x_continuous(
    expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(n = 4), 
    labels = label_number(scale_cut = cut_short_scale()),
    limits = c(min_saldo_ven, max_saldo_ven)
  ) +
  theme(
    panel.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.ticks = element_blank(),
    strip.background = element_rect(colour = "white", fill = "white"),
    axis.text.y = element_text(size=16, family="Lato"),
    axis.text.x = element_blank(),
    axis.line.y = element_line(colour = "black"),
    text = element_text(size=16, family="Lato"),
    strip.text = element_text(size=18, face = "bold"),
    title = element_text(size=22, family="Lato", face = "bold"),
    plot.caption = element_text(size=12, family="Lato", face = "plain"),
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.title = element_blank(),
    panel.spacing = unit(1, "lines")  # Adjust the space between facets
  )



```

:::
:::

## Orientaciones brindadas en frontera

```{r, echo=FALSE, warning=FALSE}


rudah_ori <- main |> 
  dplyr::filter(today >= date_start_filter) 


total_ori_gen <- rudah_ori |>
  dplyr::select("tipo_orientacion") |>
  na.omit() |> 
  dplyr::filter(grepl("ori_general", tipo_orientacion)) |> 
  nrow() |>
  sum()

total_ori_legal <- rudah_ori |>
  dplyr::select("tipo_orientacion") |>
  na.omit() |> 
  dplyr::filter(grepl("ori_legal", tipo_orientacion)) |> 
  nrow() |>
  sum()


personas_ori_gen <- rudah_ori |>
  dplyr::select("tipo_orientacion", "member_count") |>
  na.omit() |> 
  dplyr::filter(grepl("ori_general", tipo_orientacion)) |> 
  select("member_count") |>
  rowSums() |>
  sum()

personas_ori_legal <- rudah_ori |>
  dplyr::select("tipo_orientacion", "member_count") |>
  na.omit() |> 
  dplyr::filter(grepl("ori_legal", tipo_orientacion)) |> 
  select("member_count") |>
  rowSums() |>
  sum()


personas_ori_tot <- rudah_ori |>
  dplyr::select("tipo_orientacion", "member_count") |>
  na.omit() |> 
  dplyr::filter(grepl("ori_legal", tipo_orientacion) | grepl("ori_general", tipo_orientacion)) |> 
  select("member_count") |>
  rowSums() |>
  sum()


rudah_ori_month <- main |> 
  dplyr::filter(today > date_start_filter_month) 


total_ori_gen_month <- rudah_ori_month |>
  dplyr::select("tipo_orientacion") |>
  na.omit() |> 
  dplyr::filter(grepl("ori_general", tipo_orientacion)) |> 
  nrow() |>
  sum()

total_ori_legal_month <- rudah_ori_month |>
  dplyr::select("tipo_orientacion") |>
  na.omit() |> 
  dplyr::filter(grepl("ori_legal", tipo_orientacion)) |> 
  nrow() |>
  sum()


personas_ori_gen_month <- rudah_ori_month |>
  dplyr::select("tipo_orientacion", "member_count") |>
  na.omit() |> 
  dplyr::filter(grepl("ori_general", tipo_orientacion)) |> 
  select("member_count") |>
  rowSums() |>
  sum()

personas_ori_legal_month <- rudah_ori_month |>
  dplyr::select("tipo_orientacion", "member_count") |>
  na.omit() |> 
  dplyr::filter(grepl("ori_legal", tipo_orientacion)) |> 
  select("member_count") |>
  rowSums() |>
  sum()


personas_ori_tot_month <- rudah_ori_month |>
  dplyr::select("tipo_orientacion", "member_count") |>
  na.omit() |> 
  dplyr::filter(grepl("ori_legal", tipo_orientacion) | grepl("ori_general", tipo_orientacion)) |> 
  select("member_count") |>
  rowSums() |>
  sum()

tot_ori_statement <- ifelse(personas_ori_tot_month == 0 | personas_ori_gen_month == 0 | personas_ori_legal_month == 0, "", paste(" (", personas_ori_gen_month, "personas con orientaciones generales y ", personas_ori_legal_month, "personas con orientaciones legales)"))

```

Durante los últimos 30 días, la operación brindó `r total_ori_gen_month` orientaciones generales y `r total_ori_legal_month` orientaciones legales a un total de `r personas_ori_tot_month` personas`r tot_ori_statement`. Durante los últimos 7 días, se brindaron `r total_ori_gen` orientaciones generales y `r total_ori_legal` orientaciones legales.

```{r, echo=FALSE, warning = FALSE, message = FALSE,  fig.width=7,fig.height=3.5}


rudah_ori_plot <- main

names_lug_ori <- c('region')
rudah_ori_plot[,names_lug_ori] <- lapply(rudah_ori_plot[,names_lug_ori] , to_factor)

rudah_ori_plot <- rudah_ori_plot |>
  dplyr::filter(today > date_start_filter_month) |> 
  dplyr::select("region", "tipo_orientacion") |>
  # mutate_at(vars("tipo_orientacion"), as.character) |> 
  # mutate_at(c("tipo_orientacion"), ~replace_na(.,"0")) |>
  # mutate_at(vars("tipo_orientacion"), as.numeric) |> 
  dplyr::add_row(region = "Peru", tipo_orientacion = "ori_legal ori_general") |>
  na.omit() |>
  dplyr::filter(grepl("ori_legal", tipo_orientacion) | grepl("ori_general", tipo_orientacion)) |> 
  tidyr::separate(tipo_orientacion, into = c("Ori1", "Ori2"), sep = "\\s") |> 
  pivot_longer(!region, names_to="Tipo", values_to="tipo_orientacion") |> 
  filter(!is.na(tipo_orientacion)) |>
  select(region, tipo_orientacion) |> 
  mutate(tot = 1) |>
  # dplyr::add_row(region = NA, tipo_orientacion = "ori_legal", tot = 0) |>
  # dplyr::add_row(region = NA, tipo_orientacion = "ori_general", tot = 0) |>
  group_by(region, tipo_orientacion) |> 
  summarise_at(vars("tot"), sum, na.rm = TRUE) |> 
  pivot_wider(names_from = "tipo_orientacion", values_from = "tot") |>
  filter(!is.na(region)) |>
  mutate_at(c("ori_legal", "ori_general"), ~replace_na(.,0)) |>
  rename("Legal" = ori_legal) |>
  rename("General" = ori_general) |>
  pivot_longer(!region, names_to="Tipo", values_to="Total") |> 
  ungroup() |> 
  add_count() |> 
  mutate_at(vars("n"), as.numeric) |> 
  dplyr::mutate(Total = replace(Total, region == "Peru", 0)) |> 
  filter(if_else(n > 2, !(region == "Peru"), TRUE)) |> 
  select(region, Tipo, Total)


rudah_ori_plot_ymax <- max(rudah_ori_plot$Total)*1.2


ggplot(rudah_ori_plot) +
  geom_col(aes(
    x = Tipo,
    y = Total,
    fill = Tipo
  ),
  position = position_dodge(width = 0.7),
  width = 0.6
  ) +
#  facet_wrap(~ Oficina, nrow = 2) +
    facet_grid(~ region, scales='free', space='free') +
  geom_text(aes(
    x = Tipo,
    y = Total,
    group = Tipo,
    label = Total, 
    size = 6
  ),
  position = position_dodge(width = 0.7),
  vjust = -1,
  size = 4
  ) +
  scale_fill_unhcr_d(
    palette = "pal_unhcr",
    nmax = 2,
    order = c(7, 2)
  ) +
  labs(
    title = "Orientaciones brindadas durante los últimos 30 días",
    y = "Orientaciones brindadas",
    x = "Oficina de terreno",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
 # scale_x_continuous(breaks = pretty_breaks(n = 4)) +
  scale_y_continuous(expand = expansion(c(0, 0.1))) +
  theme_unhcr(font_size = 10,
    grid = FALSE,
    axis = "x",
    axis_title = FALSE,
    axis_text = "x",
    legend = FALSE
  ) +
  ylim(0,rudah_ori_plot_ymax) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE))


```

Promedio móvil (10 días) de orientaciones brindadas registradas en RUDAH:

```{r, dpi=200, echo=FALSE, warning = FALSE, message=FALSE, fig.align = 'left', fig.width=7,fig.height=3.3}


rudah_ori_plot_all <- main

names_lug_ori_all <- c('region')
rudah_ori_plot_all[,names_lug_ori_all] <- lapply(rudah_ori_plot_all[,names_lug_ori_all] , to_factor)



rudah_ori_plot_all <- rudah_ori_plot_all |>
  dplyr::select("region", "today", "tipo_orientacion") |>
  # mutate_at(vars("tipo_orientacion"), as.character) |> 
  # mutate_at(c("tipo_orientacion"), ~replace_na(.,"0")) |>
  # mutate_at(vars("tipo_orientacion"), as.numeric) |> 
  dplyr::add_row(region = "Peru", tipo_orientacion = "ori_legal ori_general") |>
  na.omit() |>
  dplyr::filter(grepl("ori_legal", tipo_orientacion) | grepl("ori_general", tipo_orientacion)) |> 
  tidyr::separate(tipo_orientacion, into = c("Ori1", "Ori2"), sep = "\\s") |> 
  pivot_longer(cols = c("Ori1", "Ori2"), names_to="Tipo", values_to="tipo_orientacion") |> 
  filter(!is.na(tipo_orientacion)) |>
  select(region, today, tipo_orientacion) |> 
  mutate(tot = 1) |> 
  group_by(today, tipo_orientacion) |> 
  summarise_at(c("tot"), sum, na.rm = TRUE) |> 
  pivot_wider(names_from = tipo_orientacion, values_from = tot) |> 
  mutate_at(vars(starts_with("ori")), ~ replace(., is.na(.), 0)) |>
  ungroup() |> 
  mutate(group = "group") |> 
  padr::pad(interval = "day", group = "group") |> 
  mutate_at(vars(starts_with("ori")), ~ replace(., is.na(.), 0)) |> 
  mutate(cma_origen = zoo::rollmean(ori_general, 10, fill = NA)) |>   # Centered moving average
  mutate(cma_orileg = zoo::rollmean(ori_legal, 10, fill = NA)) |> 
  filter(!is.na(cma_origen)) |> 
  select(today, cma_origen, cma_orileg) |> 
  ungroup() |> 
  rename("Generales" = cma_origen) |>
  rename("Legales" = cma_orileg) |>
  pivot_longer(cols = c("Generales", "Legales"), names_to = "Tipo", values_to = "Total")
  


ymax_rudah_ori_plot_all <- max(rudah_ori_plot_all$Total * 1.1)



# Plot
ggplot(rudah_ori_plot_all, aes(
  x = today,
  y = Total,
  color = Tipo
)) +
  geom_line(size = 1) +
  geom_dl(aes(label = Tipo),
    method = list(cex = 1,
      dl.trans(x = x + 0.1),
      "last.points"
    ),
    size = 6
  ) +
  labs(
    title = "Orientaciones brindadas - acumuladas",
    y = "Numero de orientaciones",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
 # scale_x_continuous(breaks = pretty_breaks()) +
  scale_x_date(date_labels="%b %Y", date_breaks  ="2 months", limits = c(min(rudah_ori_plot_all$today), max(rudah_ori_plot_all$today)+30)) +
  scale_y_continuous(
    expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(),
    labels = label_number(scale_cut = cut_short_scale()),
    limits = c(0, ymax_rudah_ori_plot_all)
  ) +
  scale_color_unhcr_d(
    palette = "pal_unhcr",
    nmax = 10,
    order = c(8, 2)
  ) +
  coord_cartesian(clip = "off") +
     theme(
     panel.background = element_rect(fill = "white"),
 #   panel.grid = element_blank(),
     panel.grid.major.y = element_line(colour = "grey"),
     panel.grid.major.x = element_blank(),
    axis.ticks = element_blank(),
    strip.background = element_rect(colour = "white", fill = "white"),
    axis.text.x = element_text(size=12,
        family="Lato"),
    axis.text.y = element_text(size=12,
        family="Lato"),
    axis.line.x = element_line(colour = "black"),
    text = element_text(size=11,
        family="Lato"),
    strip.text = element_text(size=12, face = "bold"),
    title = element_text(size=12,
        family="Lato", face = "bold"),
    plot.caption = element_text(size=6,
        family="Lato", face = "plain"),
    legend.position = "none",
     axis.title = element_blank()
   )
  # theme_unhcr(
  #   grid = "Y",
  #   axis = "x",
  #   axis_title = "y",
  #   legend = FALSE
  # ) +
  # theme(plot.margin = margin(r = 50))

# 
# ggplot(rudah_ori_plot_all, aes(
#     x = today)) +
#   geom_line(aes(
#     y = cma_origen
#   ),
#   size = 0.5,
#   color = unhcr_pal(n = 1, "pal_blue")
#   ) +
#   geom_line(aes(
#     y = cma_orileg
#   ),
#   size = 0.5,
#   color = unhcr_pal(n = 1, "pal_grey")
#   ) +
#   labs(
#     title = "Orientaciones brindadas",
#     y = "Numero de orientaciones",
#     caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
#   ) +
#  # scale_x_continuous(breaks = pretty_breaks()) +
#   scale_y_continuous(
#     expand = expansion(c(0, 0.1)),
#     breaks = pretty_breaks(n = 4),
#     labels = label_number_si()
#  #   limits = c(0, ymax_rudah_ori_plot_all)
#   ) +
#   theme_unhcr(font_size = 20,
#     grid = "Y",
#     axis = "x",
#     axis_title = "y"
#   ) 


```

\newpage

## Monitoreo de fronteras

Durante el último mes se entrevistaron `r nrow(main_last_month)` grupos (`r sum(main_last_month$member_count)` personas). Entre ellos, `r nrow(main_last_month_tumbes)` en Tumbes, `r nrow(main_last_month_tacna)` en Tacna, `r nrow(main_last_month_puno)` en Puno, y `r nrow(main_last_month_mdd)` en Madre de Dios. Durante los últimos 7 días se entrevisaron a `r nrow(main_last_week)` grupos.

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.align = 'center', results='hide', fig.width=7,fig.height=3.9}


data(main_last_month, package = "unhcrthemes")
names <- c('region')
main_last_month[,names] <- lapply(main_last_month[,names] , to_factor)



main_last_month_chart_previo <- main_last_month |> 
  select(paisprevio, region) |> 
  group_by(paisprevio, region) |> 
  summarise(total = n()) |> 
  group_by(region) |> 
  mutate(percent = total/sum(total)) |> 
  ungroup() |> 
  mutate(percent = round(percent, 2)) |> 
  filter(!is.na(paisprevio))

#  select(paisprevio, lugar_monitoreo, percent) 

# main_last_month_chart_previo_tot <- main_last_month |> 
#   select(paisprevio) |> 
#   group_by(paisprevio) |> 
#   summarise(total = n()) |> 
#   mutate(percent = total/sum(total)) |> 
#   ungroup() |> 
#   select(paisprevio, percent)


# ggplot(main_last_month_chart_previo_tot) +
#   geom_col(aes(
#     x = percent,
#     y = reorder(paisprevio, percent)
#   ),
#   fill = unhcr_pal(n = 1, "pal_blue"),
#   width = 0.8
#   ) +
#   geom_text(aes(
#     x = percent,
#     y = reorder(paisprevio, percent),
#     label = round(percent, 2)
#   ),
#   hjust = -0.5,
#   size = 8 / .pt
#   ) +
#   labs(
#     title = "Principales paises de procedencia durante los últimos 30 días" ) +
#   scale_x_continuous(expand = expansion(c(0, 0.1))) +
#   theme_unhcr(
#     grid = FALSE,
#     axis = "y",
#     axis_title = FALSE,
#     axis_text = "y"
#   )


ggplot(
  main_last_month_chart_previo,
  aes(
    x = fct_rev(paisprevio),
    y = region
  )
) +
  geom_tile(aes(
    fill = percent
  ),
  color = "white",
  lwd = .5,
  linetype = 1
  ) +
  labs(
 title = "Principales paises de procedencia durante los últimos 30 días",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"  
 ) +
  scale_x_discrete(
    labels = scales::label_wrap(3),
    position = "top"
  ) +
  scale_y_discrete(
    labels = scales::label_wrap(3)
  ) +
  scale_fill_stepsn(
    colors = c("#CCE3F2", "#75B5E4", "#0088CC", "#00649F", "#004469"),
    n.break = 5,
    name = "% de personas por punto"
  ) +
  coord_fixed() +
   geom_text(aes(label = scales::percent(percent)), colour = "white", size = 3
  ) +
  theme_unhcr(
    font_size = 11,
    grid = FALSE,
    axis = FALSE,
    axis_title = FALSE,
    axis_text_size = 8,
    legend_title = TRUE,
    legend = FALSE
  )





```

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.align = 'center', results='hide', fig.width=7,fig.height=3.9}


main_last_month_chart_destino <- main_last_month |> 
  select(paisdestino, region) |> 
  group_by(paisdestino, region) |> 
  summarise(total = n()) |> 
  group_by(region) |> 
  mutate(percent = total/sum(total)) |> 
  ungroup() |> 
  mutate(percent = round(percent, 2)) |> 
  filter(!is.na(paisdestino))

#  select(paisdestino, lugar_monitoreo, percent) 

# main_last_month_chart_destino_tot <- main_last_month |> 
#   select(paisdestino) |> 
#   group_by(paisdestino) |> 
#   summarise(total = n()) |> 
#   mutate(percent = total/sum(total)) |> 
#   ungroup() |> 
#   select(paisdestino, percent)

ggplot(
  main_last_month_chart_destino,
  aes(
    x = fct_rev(paisdestino),
    y = region
  )
) +
  geom_tile(aes(
    fill = percent
  ),
  color = "white",
  lwd = .5,
  linetype = 1
  ) +
  labs(
 title = "Principales paises de destino durante los últimos 30 días",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"  
 ) +
  scale_x_discrete(
    labels = scales::label_wrap(3),
    position = "top"
  ) +
  scale_y_discrete(
    labels = scales::label_wrap(3)
  ) +
  scale_fill_stepsn(
    colors = c("#CCE3F2", "#75B5E4", "#0088CC", "#00649F", "#004469"),
    n.break = 5,
    name = "% de personas por punto"
  ) +
  coord_fixed() +
   geom_text(aes(label = scales::percent(percent)), colour = "white", size = 3
  ) +
  theme_unhcr(
    font_size = 11,
    grid = FALSE,
    axis = FALSE,
    axis_title = FALSE,
    axis_text_size = 8,
    legend_title = TRUE,
    legend = FALSE
  )


# ggplot(main_last_month_chart_destino_tot) +
#   geom_col(aes(
#     x = percent,
#     y = reorder(paisdestino, percent)
#   ),
#   fill = unhcr_pal(n = 1, "pal_blue"),
#   width = 0.8
#   ) +
#   geom_text(aes(
#     x = percent,
#     y = reorder(paisdestino, percent),
#     label = round(percent, 2)
#   ),
#   hjust = -0.5,
#   size = 8 / .pt
#   ) +
#   labs(
#     title = "Principales paises de destino durante los últimos 30 días" ) +
#   scale_x_continuous(expand = expansion(c(0, 0.1))) +
#   theme_unhcr(
#     grid = FALSE,
#     axis = "y",
#     axis_title = FALSE,
#     axis_text = "y"
#   )


```

Para más información, consultar el [dashboard de monitoreo de fronteras](https://app.powerbi.com/links/5xMJ63-7XL?ctid=e5c37981-6664-4134-8a0c-6543d2af80be).

\newpage

## Distribuciones durante los últimos 7 días

::: row
::: column
```{r tot_distrib_7, echo=FALSE, warning=FALSE, message=FALSE, fig.align = 'center', results='hide'}

rudah <- main |> 
  dplyr::filter(today >= date_start_filter) 


total_kits <- rudah |> 
 select(starts_with("qt_kit"))  |>  
  mutate_all(~coalesce(.,0)) |> 
  rowSums() |> 
  sum()

total_cris <- rudah |> 
 select(starts_with("qt_cri")) |> 
 mutate_all(~coalesce(.,0)) |> 
 rowSums() |> 
 sum()

personas_kits <- rudah |> 
  select(starts_with("kit_dis_"), "member_count") |> 
  mutate_all(~coalesce(.,0)) |> 
  mutate(sum = rowSums(across(starts_with("kit_dis_")))) |> 
  filter(sum > 0) |> 
  select("member_count") |> 
  mutate_all(~coalesce(.,0)) |> 
  rowSums() |> 
  sum()

personas_cris <- rudah |> 
  select(starts_with("cri_dis_"), "member_count") |> 
  mutate_all(~coalesce(.,0)) |> 
  mutate(sum = rowSums(across(starts_with("cri_dis_")))) |> 
  filter(sum > 0) |> 
  select("member_count") |> 
  mutate_all(~coalesce(.,0)) |> 
  rowSums() |> 
  sum()


personas_kits_cris <- rudah |> 
  filter(grepl('asistencia_kit', kit_orientacion)) |> 
  select("member_count") |> 
  rowSums() |> 
  sum()

# Loading required packages
library(ggtext)
library(ggforce)

kits_cris_plot <- data.frame(total_cris, total_kits) |> 
  rename("CRI" = total_cris) |>
  rename("Kits" = total_kits) |>
  pivot_longer(cols = CRI:Kits, names_to = "Type", values_to = "Total")


# Plot total CRIs and Kits
ggplot(kits_cris_plot) +
  geom_arc_bar(aes(
    x0 = 0,
    y0 = 0,
    r0 = 0.6,
    r = 1,
    amount = Total,
    fill = Type
  ),
  stat = "pie",
  size = 1,
  color = "#FFFFFF"
  ) +
  geom_richtext(
    x = c(1.25, -1.25),
    y = c(-0.3, 0.3),
    aes(label = paste0(
      Type,
      "<br><strong> ",
      round(Total, 0),
      "</strong>", "<br>",
      round(100 * Total / sum(Total), 1),
      "%"
    )),
    size = 7,
    fill = NA,
    label.color = NA
  ) +
  geom_richtext(
    x = 0,
    y = 0,
    label = paste0(
      "Total distribuido",
      "<br><strong>",
      round(sum(kits_cris_plot$Total), 0),
      "</strong>"
    ),
    size = 7,
    fill = NA,
    label.color = NA
  ) +
  labs(
    title = "Kits, CRIs y Food Items distribuidos",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
  scale_fill_unhcr_d(
    palette = "pal_unhcr",
    direction = -1
  ) +
  scale_x_continuous(expand = expansion(c(0.3, 0.5))) +
  theme_unhcr(
    grid = FALSE,
    axis = FALSE,
    axis_title = FALSE,
    axis_text = FALSE,
    legend = FALSE,
    font_size = 16
  )



```
:::

::: column
Durante la última semana, entre el `r format(date_start_filter, "%d-%b")` y el `r format(date_today, "%d-%b")`, la operación distribuyó `r total_kits` Kits y `r total_cris` CRIs y Food Items, asistiendo a un total de `r personas_kits_cris` personas (`r personas_kits` personas recibieron kits y `r personas_cris` recibieron CRIs y/o Food Items).
:::
:::

::: row
::: column
```{r detail_distrib_7, echo=FALSE, warning=FALSE, message=FALSE, fig.align = 'center', results='hide', fig.height= 5.5}


## Preparing totals by region
names_lug <- c('region')
rudah[,names_lug] <- lapply(rudah[,names_lug] , to_factor)

rudah_kits_cris_plot <- rudah |>
  select(region, starts_with("qt_kit"), starts_with("qt_cri")) |>  
  mutate_at(vars(starts_with("qt_kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("qt_kit")), as.numeric) |>
  mutate_at(vars(starts_with("qt_cri")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("qt_cri")), as.numeric) |>
   mutate(Kits = rowSums(across(starts_with("qt_kit")))) |>
  mutate(CRIs = rowSums(across(starts_with("qt_cri")))) |>
  select("region", "Kits", "CRIs") |>
  group_by(region) |>
  summarise_at(c("Kits", "CRIs"), sum, na.rm = TRUE) |> 
  pivot_longer(!region, names_to="Tipo", values_to="Total")


rudah_kits_cris_plot <- mutate(rudah_kits_cris_plot, region = fct_reorder(region, -Total, sum))

cris_region <- rudah_kits_cris_plot |> 
  filter(Tipo == "CRIs") |> 
  filter(Total != 0) |> 
  select(region, Total) |> 
  mutate_at(vars(region), as.character)


kits_region <- rudah_kits_cris_plot |> 
  filter(Tipo == "Kits") |> 
  filter(Total != 0) |> 
  select(region, Total) |> 
  mutate_at(vars(region), as.character)



# CRIs by region
ggplot(cris_region, aes(x = Total, y = reorder(region, Total))) +
  geom_col(
  fill = unhcr_pal(n = 1, "pal_blue"),
  width = 0.5
  ) +
    geom_text(aes(label = Total),
  position = position_dodge(width = 0.7),
  hjust = -0.1,
  size = 6
  ) +
#  geom_text(aes(label = Total), hjust = 1.5, colour = "white", size = 8)  +
  labs(
    title = "CRIs y Food Items distribuidos durante los últimos 7 días",
    x = "Número de CRIs/Food Items",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
  scale_x_continuous(
    expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(n = 4), 
    labels = label_number(scale_cut = cut_short_scale())
  ) +
  theme_unhcr(
    grid = FALSE,
    axis = "y",
    axis_text_size = 18,
    axis_title = "x",
    font_size = 16
  )
# # Kits by region
# ggplot(kits_region, aes(x = Total, y = reorder(region, Total))) +
#   geom_col(
#   fill = unhcr_pal(n = 1, "pal_blue"),
#   width = 0.8
#   ) +
#   geom_text(aes(label = Total), hjust = 1.5, colour = "white")  +
#   labs(
#     title = "Kits distribuidos durante los últimos 7 días",
#     x = "Número de CRIs",
#     caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
#   ) +
#   scale_x_continuous(
#     expand = expansion(c(0, 0.1)),
#     breaks = pretty_breaks(n = 7),
#     labels = label_number_si()
#   ) +
#   theme_unhcr(
#     grid = FALSE,
#     axis = "y",
#     axis_title = "x"
#   )


```
:::

::: column
```{r detail_distrib_2_7, echo=FALSE, warning=FALSE, message=FALSE, fig.align = 'center', results='hide', fig.height= 5.5}

# Kits by region
ggplot(kits_region, aes(x = Total, y = reorder(region, Total))) +
  geom_col(
  fill = unhcr_pal(n = 1, "pal_blue"),
  width = 0.8
  ) +
   geom_text(aes(label = Total),
  position = position_dodge(width = 0.7),
  hjust = -0.1,
  size = 6
  ) +
#  geom_text(aes(label = Total), hjust = 1.5, colour = "white", size = 8)  +
  labs(
    title = "Kits distribuidos durante los últimos 7 días",
    x = "Número de Kits",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
  scale_x_continuous(
    expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(n = 7),
    labels = label_number(scale_cut = cut_short_scale())
  ) +
  theme_unhcr(
    grid = FALSE,
    axis = "y",
    axis_title = "x",
    axis_text_size = 18,
    font_size = 16
  )


```
:::
:::

```{r, echo=FALSE, warning = FALSE, message = FALSE,  fig.width=7,fig.height=3.5}

# 

# 
# 
# ggplot(rudah_kits_cris_plot) +
#   geom_col(aes(
#     x = Tipo,
#     y = Total,
#     fill = Tipo
#   ),
#   position = position_dodge(width = 0.7),
#   width = 0.6
#   ) +
# #  facet_wrap(~ Oficina, nrow = 2) +
#     facet_grid(~ region, scales='free', space='free') +
#   geom_text(aes(
#     x = Tipo,
#     y = Total,
#     group = Tipo,
#     label = Total
#   ),
#   position = position_dodge(width = 0.7),
#   vjust = -1,
#   size = 8 / .pt
#   ) +
#   scale_fill_unhcr_d(
#     palette = "pal_unhcr",
#     nmax = 3,
#     order = c(2, 3, 1)
#   ) +
#   labs(
#     title = "Asistencia brindada",
#     y = "Insumos distribuidos",
#     x = "Oficina de terreno",
#     caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
#   ) +
#  # scale_x_continuous(breaks = pretty_breaks(n = 4)) +
#   scale_y_continuous(expand = expansion(c(0, 0.1))) +
#   theme_unhcr(
#     grid = FALSE,
#     axis = "x",
#     axis_title = FALSE,
#     axis_text = "x"
#   ) +
#   ylim(0,rudah_kits_cris_plot_ymax) +
#   guides(fill = guide_legend(nrow = 2, byrow = TRUE)) +
#   facet_wrap(~ region, ncol = 3, scales='free') 
# 



total_kits_cris_line <- rudah |> 
 select(today, starts_with("qt_kit"), starts_with("qt_cri")) |>  
  mutate_at(vars(starts_with("qt_kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("qt_kit")), as.numeric) |>
  mutate_at(vars(starts_with("qt_cri")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("qt_cri")), as.numeric) |>
  mutate(Kits = rowSums(across(starts_with("qt_kit")))) |>
  mutate(CRIs = rowSums(across(starts_with("qt_cri")))) |>
  select(today, Kits, CRIs) |> 
  group_by(today) |>
  summarise_at(c("Kits", "CRIs"), sum, na.rm = TRUE) |> 
  rename(CRIs_FIs = CRIs) |> 
  pivot_longer(!today, names_to="Tipo", values_to="Total")
  
rudah_kits_cris_plot_ymax <- max(total_kits_cris_line$Total)*1.2

ggplot(total_kits_cris_line, aes(
    x = today,
    y = Total)) +
  geom_col(aes(
    fill = Tipo
  ),
  position = position_dodge(width = 0.7),
  width = 0.6
  ) +
  geom_text(aes(
    group = Tipo,
    label = Total, 
    size = 6
  ),
  position = position_dodge(width = 0.7),
  vjust = -1,
  size = 3
  ) +
  scale_fill_unhcr_d(
    palette = "pal_unhcr",
    nmax = 3,
    order = c(2, 3, 1)
  ) +
  labs(
    title = "Distribuciones diarias durante los ultimos 7 dias",
    y = "Cantidad de insumos",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
  scale_x_date(breaks = unique(total_kits_cris_line$today)) +
  scale_y_continuous(
    expand = expansion(c(0, 0.1)),
    labels = label_number(scale_cut = cut_short_scale())
  ) +
  ylim(0,rudah_kits_cris_plot_ymax) +
  theme_unhcr(
    grid = FALSE,
    axis = "x",
    axis_title = FALSE,
    font_size = 11
  ) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE))


```

El Anexo 1 brinda el desglose de los Kits, CRIs y Food Items distribuidos durante los últimos 7 días por región. \newpage

## Distribuciones acumuladas

::: row
::: column
```{r tot_distrib_all, echo=FALSE, warning=FALSE, message=FALSE, fig.align = 'center', results='hide'}

rudah_all <- main  


total_kits_all <- rudah_all |> 
 select(starts_with("qt_kit"))  |>  
  mutate_all(~coalesce(.,0)) |> 
  rowSums() |> 
  sum()

total_cris_all <- rudah_all |> 
 select(starts_with("qt_cri")) |> 
 mutate_all(~coalesce(.,0)) |> 
 rowSums() |> 
 sum()

personas_kits_all <- rudah_all |> 
  mutate(sum = rowSums(across(starts_with("kit_dis_")))) |> 
  filter(sum > 0) |> 
  select("member_count") |> 
  mutate_all(~coalesce(.,0)) |> 
  rowSums() |> 
  sum()

personas_cris_all <- rudah_all |> 
  mutate(sum = rowSums(across(starts_with("cri_dis_")))) |> 
  filter(sum > 0) |> 
  select("member_count") |> 
  mutate_all(~coalesce(.,0)) |> 
  rowSums() |> 
  sum()


personas_kits_cris_all <- rudah_all |> 
  filter(grepl('asistencia_kit', kit_orientacion)) |> 
  select("member_count") |> 
  rowSums() |> 
  sum()

# Loading required packages
library(ggtext)
library(ggforce)

kits_cris_plot_all <- data.frame(total_cris_all, total_kits_all) |> 
  rename("CRI" = total_cris_all) |>
  rename("Kits" = total_kits_all) |>
  pivot_longer(cols = CRI:Kits, names_to = "Type", values_to = "Total")


# Plot total CRIs and Kits
ggplot(kits_cris_plot_all) +
  geom_arc_bar(aes(
    x0 = 0,
    y0 = 0,
    r0 = 0.6,
    r = 1,
    amount = Total,
    fill = Type
  ),
  stat = "pie",
  size = 1,
  color = "#FFFFFF"
  ) +
  geom_richtext(
    x = c(1.25, -1.25),
    y = c(-0.3, 0.3),
    aes(label = paste0(
      Type,
      "<br><strong> ",
      format(Total, big.mark = ","),
 #     round(Total, 0),
      "</strong>", "<br>",
 #     format(round(100 * Total / sum(Total), 1), big.mark = ","),
      round(100 * Total / sum(Total), 1),
      "%"
    )),
    size = 7,
    fill = NA,
    label.color = NA
  ) +
  geom_richtext(
    x = 0,
    y = 0,
    label = paste0(
      "Total distribuido",
      "<br><strong>",
      format(sum(kits_cris_plot_all$Total), big.mark = ","),
#      round(sum(kits_cris_plot_all$Total), 0),
      "</strong>"
    ),
    size = 7,
    fill = NA,
    label.color = NA
  ) +
  labs(
    title = "Kits, CRIs y Food Items distribuidos",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
  scale_fill_unhcr_d(
    palette = "pal_unhcr",
    direction = -1
  ) +
  scale_x_continuous(expand = expansion(c(0.3, 0.5))) +
  theme_unhcr(
    grid = FALSE,
    axis = FALSE,
    axis_title = FALSE,
    axis_text = FALSE,
    legend = FALSE,
    font_size = 16
  )

## Preparing totals by region
names_lug_all <- c('region')
rudah_all[,names_lug_all] <- lapply(rudah_all[,names_lug_all] , to_factor)

rudah_kits_cris_plot_all <- rudah_all |>
  select(region, starts_with("qt_kit"), starts_with("qt_cri")) |>  
  mutate_at(vars(starts_with("qt_kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("qt_kit")), as.numeric) |>
  mutate_at(vars(starts_with("qt_cri")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("qt_cri")), as.numeric) |>
   mutate(Kits = rowSums(across(starts_with("qt_kit")))) |>
  mutate(CRIs = rowSums(across(starts_with("qt_cri")))) |>
  select("region", "Kits", "CRIs") |>
    group_by(region) |>
  summarise_at(c("Kits", "CRIs"), sum, na.rm = TRUE) |> 
  pivot_longer(!region, names_to="Tipo", values_to="Total")


rudah_kits_cris_plot_all <- mutate(rudah_kits_cris_plot_all, region = fct_reorder(region, -Total, sum))

cris_region_all <- rudah_kits_cris_plot_all |> 
  filter(Tipo == "CRIs") |> 
  filter(Total != 0) |> 
  select(region, Total) |> 
  mutate_at(vars(region), as.character)


kits_region_all <- rudah_kits_cris_plot_all |> 
  filter(Tipo == "Kits") |> 
  filter(Total != 0) |> 
  select(region, Total) |> 
  mutate_at(vars(region), as.character)

start_rudah_all = min(rudah_all$today)

total_kits_cris_all = format(sum(rudah_kits_cris_plot_all$Total), big.mark = ",")

total_kits_all = format(sum(subset(rudah_kits_cris_plot_all, Tipo == "Kits")$Total), big.mark = ",")
total_cris_all = format(sum(subset(rudah_kits_cris_plot_all, Tipo == "CRIs")$Total), big.mark = ",")


```
:::

::: column
Desde la implementación actual del RUDAH (`r start_rudah_all`) se registró la distribución de un total de `r total_kits_cris_all` insumos, entre ellos `r total_kits_all` Kits y `r total_cris_all` CRIs y Food Items.
:::
:::

::: row
::: column
```{r detail_distrib_all, echo=FALSE, warning=FALSE, message=FALSE, fig.align = 'center', results='hide', fig.height= 6}





# CRIs by region
ggplot(cris_region_all, aes(x = Total, y = reorder(region, Total))) +
  geom_col(
  fill = unhcr_pal(n = 1, "pal_blue"),
  width = 0.8
  ) +
    geom_text(aes(label = format(Total, big.mark = ",")),
  position = position_dodge(width = 0.7),
  hjust = -0.1,
  size = 6
  ) +
#  geom_text(aes(label = Total), hjust = 1.5, colour = "white", size = 8)  +
  labs(
    title = "CRIs y Food Items distribuidos",
    x = "Número de CRIs/Food Items",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
  scale_x_continuous(
    expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(n = 4),
    labels = label_number(scale_cut = cut_short_scale()),
    limits = c(0, max(cris_region_all$Total)*1.1)
  ) +
  theme_unhcr(
    grid = FALSE,
    axis = "y",
    axis_title = "x",
    axis_text_size = 18,
    font_size = 16
  )


```
:::

::: column
```{r detail_distrib_2_all, echo=FALSE, warning=FALSE, message=FALSE, fig.align = 'center', results='hide', fig.height= 6}

# Kits by region
ggplot(kits_region_all, aes(x = Total, y = reorder(region, Total))) +
  geom_col(
  fill = unhcr_pal(n = 1, "pal_blue"),
  width = 0.8
  ) +
    geom_text(aes(label = format(Total, big.mark = ",")),
  position = position_dodge(width = 0.7),
  hjust = -0.1,
  size = 6
  ) +
#  geom_text(aes(label = Total), hjust = 1.5, colour = "white", size = 8)  +
  labs(
    title = "Kits distribuidos",
    x = "Número de Kits",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
  scale_x_continuous(
     expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(n = 4),
 #   labels = label_number(scale_cut = cut_short_scale()),
    limits = c(0, max(kits_region_all$Total)*1.1)
  ) +
  theme_unhcr(
    grid = FALSE,
    axis = "y",
    axis_title = "x",
    axis_text_size = 18,
    font_size = 16
  )


```
:::
:::

```{r, echo=FALSE, warning = FALSE, message = FALSE, dpi= 150,  fig.width=7, fig.height=3}

## Mobile average over time of kits and CRI distributions by region

library(zoo)
library(padr)

## Downloading xls form
xls <- kobo_form("aoSWoUrToEhdL2Zc9pvhJY") |> 
  select(name, label) |> 
  filter(grepl("qt_", name)) |> 
  separate_wider_delim(label, delim = "*", names = c("Delete", "label"), too_many = "merge") |> 
  separate_wider_delim(label, delim = "*", names = c("label", "Delete2"), too_many = "merge") |> 
  mutate(across(label, str_replace, '\\$', '_')) |> 
  mutate(across(label, str_replace, '\\{', '_')) |> 
  mutate(across(label, str_replace, '\\}', '_')) |> 
  mutate(across(label, str_replace, '__kit_other_', 'Kit (otro)')) |> 
  mutate(across(label, str_replace, '__cri_other_', 'CRI (otro)')) |> 
  mutate(label = str_trim(label)) |> 
  select(name, label) |> 
#  add_row(name = "qt_cri_toallas", label = "Toallas higiénicas") |> 
#  add_row(name = "qt_cri_bloqueador", label = "Bloqueadores solares") |> 
#  add_row(name = "qt_cri_atun", label = "Latas de conserva de atún") |> 
  add_row(name = "qt_kit_t_familiar", label = "Kit de higiene (familiar)") |> 
  add_row(name = "qt_kit13", label = "Kit de alimento") |> 
  add_row(name = "qt_kit_oficina", label = "Kit de oficina") |> 
  add_row(name = "qt_kit_escolar", label = "Kit escolar") |> 
  add_row(name = "qt_kit_t_extramujer", label = "Kit de dignidad (extra mujer)")


## Total trends CRIs and Kits national level
kits_cris_list_trend_all <- rudah_all |>
  select(today, starts_with("qt_kit"), starts_with("qt_cri")) |>
  mutate_at(vars(starts_with("qt_kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("qt_kit")), as.numeric) |>
  mutate_at(vars(starts_with("qt_cri")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("qt_cri")), as.numeric) |>
  pivot_longer(cols = c(starts_with("qt_")), names_to="Tipo", values_to="Total") |>
  left_join(xls, by = c('Tipo' = 'name')) |> 
  mutate(Kit_CRI = case_when(str_detect(Tipo, 'qt_kit') ~ 'Kit',
                TRUE ~ 'CRI')) |>
  select(today, Kit_CRI, label, Total) |> 
  rename("Tipo" = label) |>

  # separate(Tipo, into=c("Kit_CRI", "Detalle"), sep = 3) |> 
  # mutate(across('Kit_CRI', str_replace, 'kit', 'Kit')) |> 
  # mutate(across('Kit_CRI', str_replace, 'cri', 'CRI')) |> 
  filter(Total != 0) |> 
  mutate_at(vars(Total), as.numeric) |>
  group_by(today, Kit_CRI) |> 
  summarise_at(c("Total"), sum, na.rm = TRUE) |> 
  arrange(today, Kit_CRI, -Total) |> 
  pivot_wider(names_from = Kit_CRI, values_from = Total) |> 
  ungroup() |> 
  mutate(group = "group") |> 
  padr::pad(interval = "day", group = "group") |> 
  mutate_at(vars(starts_with("Kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("CRI")), ~ replace(., is.na(.), 0)) |>
  group_by(group) |> 
#  filter(sum(Kit) + sum(CRI) != 0) |> 
  mutate(cma_kits = zoo::rollmean(Kit, 10, fill = NA)) |>   # Centered moving average
  mutate(cma_cris = zoo::rollmean(CRI, 10, fill = NA)) |> 
  filter(!is.na(cma_kits)) |> 
  select(today, cma_kits, cma_cris) |> 
   rename("Kits" = cma_kits) |>
   rename("CRIs" = cma_cris) |> 
  pivot_longer(cols = c(Kits, CRIs), names_to = "Tipo", values_to = "Total")


ymax_kits_cris_list_trend_all <- max(kits_cris_list_trend_all$Total * 1.1)
# 
# ggplot(kits_cris_list_trend_all, aes(
#     x = today)) +
#   geom_line(aes(
#     y = cma_kits
#   ),
#   size = 0.5,
#   color = unhcr_pal(n = 1, "pal_blue")
#   ) +
#   geom_line(aes(
#     y = cma_cris
#   ),
#   size = 0.5,
#   color = unhcr_pal(n = 1, "pal_grey")
#   ) +
#   labs(
#     title = "Distribución de Kits y CRIs",
#     y = "Numero de insumos",
#     caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
#   ) +
#  # scale_x_continuous(breaks = pretty_breaks()) +
#   scale_y_continuous(
#     expand = expansion(c(0, 0.1)),
#     breaks = pretty_breaks(n = 4),
#     labels = label_number_si(),
#     limits = c(0, ymax_kits_cris_list_trend_all)
#   ) +
#   theme_unhcr(font_size = 20,
#     grid = "Y",
#     axis = "x",
#     axis_title = "y"
#   ) 



# Plot
ggplot(kits_cris_list_trend_all, aes(
  x = today,
  y = Total,
  color = Tipo
)) +
 geom_line(size = 0.5) +
  # geom_dl(aes(label = Tipo),
  #   method = list(cex = 1,
  #     dl.trans(x = x + 0.1),
  #     "last.points"
  #   ),
  #   size = 5 
  # ) +
  labs(
    title = "Distribución de Kits, CRIs y Food Items",
    y = "Numero de insumos",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
 # scale_x_continuous(breaks = pretty_breaks()) +
  scale_x_date(date_labels="%b %Y", date_breaks  ="2 month"
               # limits = c(min(kits_cris_list_trend_all$today), max(kits_cris_list_trend_all$today)+30)
               ) +
  scale_y_continuous(
    expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(),
    labels = label_number(scale_cut = cut_short_scale()),
    limits = c(0, ymax_kits_cris_list_trend_all)
  ) +
  scale_color_unhcr_d(
    palette = "pal_unhcr",
    nmax = 10,
    order = c(7, 1)
  ) +
  coord_cartesian(clip = "off") +
     theme(
     panel.background = element_rect(fill = "white"),
 #   panel.grid = element_blank(),
     panel.grid.major.y = element_line(colour = "grey"),
     panel.grid.major.x = element_blank(),
    axis.ticks = element_blank(),
    strip.background = element_rect(colour = "white", fill = "white"),
    axis.text.x = element_text(size=8,
        family="Lato"),
    axis.text.y = element_text(size=8,
        family="Lato"),
    axis.line.x = element_line(colour = "black"),
    text = element_text(size=11,
        family="Lato"),
    strip.text = element_text(size=12, face = "bold"),
    title = element_text(size=11,
        family="Lato", face = "bold"),
    plot.caption = element_text(size=6,
        family="Lato", face = "plain"),
    legend.position = "none",
     axis.title = element_blank(),
 plot.margin = unit(c(0.1, 3, 0.1, 0.1), "cm")
   ) +
  geom_text_repel(
    data = subset(kits_cris_list_trend_all, today == max(today)),
    aes(label = Tipo),
    xlim = as.Date(c(max(kits_cris_list_trend_all$today), max(kits_cris_list_trend_all$today)+10)),
    size = 3,
    hjust = -2,
    direction = "y",
    box.padding = 0.5,
    nudge_x = 2,
    segment.color = NA,
    show.legend = FALSE
  ) 
  # geom_smooth(method = "gam",formula = y ~ s(x, bs = "cs", k = 20, sp = 0.1), se = FALSE)
   
  # theme_unhcr(
  #   grid = "Y",
  #   axis = "x",
  #   axis_title = "y",
  #   legend = FALSE
  # ) +
  # theme(plot.margin = margin(r = 50))

```

Promedio móvil (10 días) de distribuciones diarias de Kits (en azul) y CRIs/Food Items (en gris) a nivel nacional.

\newpage

```{r, echo=FALSE, warning = FALSE, message = FALSE, dpi=300,  fig.width=7,fig.height=10}

## Mobile average over time of kits and CRI distributions by region



## First total trends by total kits and CRIs
kits_cris_list_trend <- rudah_all |>
  select(region, today, starts_with("qt_kit"), starts_with("qt_cri")) |>
  mutate_at(vars(starts_with("qt_kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("qt_kit")), as.numeric) |>
  mutate_at(vars(starts_with("qt_cri")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("qt_cri")), as.numeric) |>
  pivot_longer(cols = c(starts_with("qt_")), names_to="Tipo", values_to="Total") |>
  left_join(xls, by = c('Tipo' = 'name')) |> 
  mutate(Kit_CRI = case_when(str_detect(Tipo, 'qt_kit') ~ 'Kit',
                TRUE ~ 'CRI')) |>
  select(region, today, Kit_CRI, label, Total) |> 
  rename("Tipo" = label) |> 
    filter(Total != 0) |> 
  mutate_at(vars(Total), as.numeric) |>
  group_by(region, today, Kit_CRI) |> 
  summarise_at(c("Total"), sum, na.rm = TRUE) |> 
  arrange(region, today, Kit_CRI, -Total) |> 
  pivot_wider(names_from = Kit_CRI, values_from = Total) |> 
  ungroup() |> 
  pad(interval = "day", group = "region") |> 
  mutate_at(vars(starts_with("Kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("CRI")), ~ replace(., is.na(.), 0)) |>
  group_by(region) |> 
#  filter(sum(Kit) + sum(CRI) != 0) |> 
  mutate(cma_kits = zoo::rollmean(Kit, 10, fill = NA)) |>   # Centered moving average
  mutate(cma_cris = zoo::rollmean(CRI, 10, fill = NA)) |> # Centered moving average
  filter(!is.na(cma_cris)) 
  # select(region, today, cma_kits, cma_cris) |> 
  # pivot_longer(cols = c(cma_kits, cma_cris), names_to = "Tipo", values_to = "CMA") |> 
  #  na.omit() |> 
  # group_by(region) %>%
  # filter(sum(Kit) + sum(CRI) != 0)


ymax_kits_cris_list_trend <- max(kits_cris_list_trend$cma_cris * 1.1)

ggplot(kits_cris_list_trend, aes(
    x = today, group = region)) +
   geom_line(aes(
     y = cma_kits
  ),
  size = 0.7,
  color = unhcr_pal(n = 1, "pal_blue"),
  lineend = "round",
  linejoin = "round"
  ) +
  # geom_smooth(aes(y = cma_kits),
  #             method = "gam",
  #             formula = y ~ s(x, bs = "cs", k = 20, sp = 0.05),
  #             se = FALSE,
  #             color = unhcr_pal(n = 1, "pal_blue")) +
    geom_line(aes(
    y = cma_cris
  ),
  size = 0.7,
  color = unhcr_pal(n = 1, "pal_grey"),
  lineend = "round",
  linejoin = "round"
  ) +
   # geom_smooth(aes(y = cma_cris),
   #            method = "gam",
   #            formula = y ~ s(x, bs = "cs", k = 20, sp = 0.05),
   #            se = FALSE,
   #            color = unhcr_pal(n = 1, "pal_grey")) +
  labs(
    title = "Distribución de Kits, CRIs y Food Items en el tiempo",
    subtitle = "Promedio móvil (10 días) de Kits (en azul) y CRIs/Food Items (en gris) por región",
    y = "Numero de insumos",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
 # scale_x_continuous(breaks = pretty_breaks()) +
  scale_x_date(date_labels="%b %Y", date_breaks  ="2 month") +
  scale_y_continuous(
    expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(n = 4),
    labels = label_number(scale_cut = cut_short_scale(),
    limits = c(0, NA))
#    limits = c(0, ymax_kits_cris_list_trend)
  ) +
  # theme_unhcr(font_size = 45,
  #   grid = "Y",
  #   axis = "x",
  #   axis_title = "y",
  #   legend = F
  # ) +
     theme(
     panel.background = element_rect(fill = "white"),
 #   panel.grid = element_blank(),
     panel.grid.major.y = element_line(colour = "grey"),
     panel.grid.major.x = element_blank(),
    axis.ticks = element_blank(),
    strip.background = element_rect(colour = "white", fill = "white"),
    axis.text.x = element_text(size=6,
        family="Lato"),
    axis.text.y = element_text(size=6,
        family="Lato"),
    axis.line.x = element_line(colour = "black"),
    text = element_text(size=6,
        family="Lato"),
    strip.text = element_text(size=11, face = "bold"),
    title = element_text(size=11,
        family="Lato", face = "bold"),
    plot.caption = element_text(size=6,
        family="Lato", face = "plain"),
    legend.position = "none",
     axis.title = element_blank()
   )  +
  facet_wrap(~ region, 
             ncol = 2, 
             scales='free') 
  
```

## Predicción: 30 días de Kits, CRIs y Food Items necesarios

Utilizando los promedios indicados arriba para los últimos dos meses, se puede proyectar que **durante los próximos 30 días** cada región necesitará los siguientes insumos:

```{r, echo=FALSE, warning = FALSE, message = FALSE,  fig.width=7,fig.height=3}

## Prediction: # of Kits and # of CRIs needed over the coming two weeks, with breakdown of type

## Reference periods
referencemin = Sys.Date() - 60
referencemax = Sys.Date()

projectiondays = 30

## Basic prediction calculation based on moving averages

kits_cris_list_trend_pred <- kits_cris_list_trend |> 
  filter(today > referencemin) |> 
  na.omit() |> 
  group_by(region) |> 
  summarise_at(c("cma_kits", "cma_cris"), mean, na.rm = TRUE) |> 
  mutate("Kits Necesarios" = round(cma_kits * projectiondays, digits = 0)) |> 
  mutate("CRIs Necesarios" = round(cma_cris * projectiondays, digits = 0)) |> 
  mutate(Total = `Kits Necesarios` + `CRIs Necesarios`) |> 
  arrange(-Total) |> 
  select(region, "Kits Necesarios", "CRIs Necesarios") 
  


kits_cris_list_trend_pred |>
  gt() |> 
  tab_style(
    style = cell_text(size = px(12)),
    locations = cells_body()) |> 
  tab_header(
    title = md("Predicción: Insumos necesarios"),
    subtitle = "Por región y tipo de insumo"
  ) |> 
  tab_source_note(
    source_note = md(
      "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
    )
  ) |> 
    opt_row_striping(row_striping = TRUE) |> 
  tab_options(data_row.padding = px(1),
                heading.padding = px(3),
                heading.title.font.size = px(14),
                heading.subtitle.font.size = px(12),
                column_labels.font.size = px(12),
                column_labels.font.weight = px(12),
                row_group.font.size = px(13),
                row_group.padding = px(2),
                source_notes.font.size = px(9),
              table.width = pct(100))


```

Con desglose estimado por tipo de Kit, CRI y Food Item:

```{r, dpi=200, echo=FALSE, warning = FALSE, message = FALSE,  fig.width=7,fig.height=4.5}

## Mobile average over time of kits and CRI distributions by region


## Trends by Kits and CRIs
kits_cris_list_trend_detail <- rudah_all |>
  select(region, today, starts_with("qt_kit"), starts_with("qt_cri")) |>
  mutate_at(vars(starts_with("qt_kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("qt_kit")), as.numeric) |>
  mutate_at(vars(starts_with("qt_cri")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("qt_cri")), as.numeric) |>
  group_by(region, today) |> 
  summarise_at(vars(starts_with("qt_kit"), starts_with("qt_cri")), sum, na.rm = TRUE) 

  

## Adding min and max dates for missing values by region
kits_cris_list_trend_detail_min <- kits_cris_list_trend_detail |> 
  group_by(region) |> 
  summarize(across(where(is.numeric), ~ 0), today = referencemin)

kits_cris_list_trend_detail_max <- kits_cris_list_trend_detail |> 
  group_by(region) |> 
  summarize(across(where(is.numeric), ~ 0), today = referencemax)



kits_cris_list_trend_detail <- kits_cris_list_trend_detail |>
  ungroup() |> 
  bind_rows(kits_cris_list_trend_detail_min) |> 
  bind_rows(kits_cris_list_trend_detail_max) |>
  pad(interval = "day", group = "region") |> 
  mutate_at(vars(starts_with("qt_")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("qt_")), list(~zoo::rollmean(., 7, fill = NA, align = "center"))) |> 
  na.omit()|> 
  filter(today > referencemin) |> 
  na.omit() |> 
  group_by(region) |> 
  summarise_at(vars(starts_with("qt_")), mean, na.rm = TRUE) |> 
  mutate_at(vars(starts_with("qt_")), 
            list(~. * projectiondays)) |> 
  mutate_at(vars(starts_with("qt_")), 
            list(~round(., digits = 0))) |> 
    pivot_longer(cols = c(starts_with("qt_")), names_to="Tipo", values_to="Total") |>
  left_join(xls, by = c('Tipo' = 'name')) |> 
  mutate(Kit_CRI = case_when(str_detect(Tipo, 'qt_kit') ~ 'Kit',
                TRUE ~ 'CRI')) |>
  select(region, Kit_CRI, label, Total) |> 
  rename("Detalle" = label) |> 
  filter(Total > 0) |> 
  ungroup() |> 
  group_by(region, Kit_CRI, Detalle) |> 
  summarise_at(vars("Total"), sum, na.rm = TRUE) |> 
  ungroup() |> 
  mutate_if(is.numeric , replace_na, replace = 0) |> 
  filter(Total > 0) |> 
  pivot_wider(names_from = region, values_from = Total) |> 
  mutate_if(is.numeric , replace_na, replace = 0) |> 
#   separate(Tipo, into=c("Kit_CRI", "Detalle"), sep = 3) |> 
#   mutate(across(c('Detalle'), substr, 6, nchar(Detalle))) |> 
# #  mutate(across(c('Detalle'), str_replace, '_', ' '))
#   mutate_all(funs(str_replace_all(., "_", " "))) |> 
#   mutate(Detalle = sub("(.)", "\\U\\1", Detalle, perl=TRUE)) |> 
#   mutate_all(funs(str_replace_all(., "acnur", "ACNUR"))) |> 
#   mutate_all(funs(str_replace_all(., "nna", "NNA"))) |> 
#   mutate(across('Kit_CRI', str_replace, 'kit', 'Kit')) |> 
#   mutate(across('Kit_CRI', str_replace, 'cri', 'CRI')) |> 
#   mutate_at(vars(3:last_col()), as.numeric) |>
  mutate(Total = rowSums(across(3:last_col()))) |>
  filter(Total != 0) |> 
  arrange(Kit_CRI, Detalle) |> 
  select(2:(last_col()-1)) |> 
  pivot_longer(cols = 2:last_col(), names_to = "region", values_to = "Total") |> 
  filter(Total > 5) |> 
  mutate(Detalle = str_remove(Detalle, "(caminante)")) |> 
  mutate(Detalle = str_remove(Detalle, " – ")) |> 
  mutate(Detalle = str_remove_all(Detalle, "\\(\\)")) |> 
  mutate(Detalle = str_remove(Detalle, "para adolescente y/o adulto")) |> 
  mutate(Detalle = str_remove(Detalle, "personas en ")) |> 
  mutate(Detalle = str_remove(Detalle, "de niñas, niños y adolescentes "))




ggplot(
  kits_cris_list_trend_detail,
  aes(
    x = region,
    y = fct_rev(Detalle)
  )
) +
  geom_tile(aes(
    fill = Total
  ),
  color = "white",
  lwd = .5,
  linetype = 1
  ) +
  geom_text(aes(label = Total), colour = "white", size = 3)  +
  labs(
    title = "Kits, CRIs y Food Items posiblemente necesitados por región y tipo de insumo",
  #  subtitle = "Por región y tipo de insumo",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
  scale_fill_stepsn(
    colors = unhcr_pal(n = 2, "pal_blue"),
    n.break = 10,
    name = "Numero de insumos"
  ) +
  # coord_fixed() +
    theme_unhcr(
    font_size = 11,
    grid = FALSE,
    axis = FALSE,
    axis_title = FALSE,
    axis_text_size = 8,
    legend_title = TRUE,
    legend = FALSE
  )


```

Cabe resaltar que se trata de datos indicativos basados en actividades pasadas, que no consideran eventuales nuevos eventos o decisiones operativas.

</br>

Entre estos, los siguientes insumos podrían ser destinados a los socios:

```{r, echo=FALSE, warning = FALSE, message = FALSE,  fig.width=7,fig.height=5}

## Mobile average over time of kits and CRI distributions by region by partner

## Preparing the data

kits_cris_list_trend_detail_socios <- rudah_all |>
  dplyr::filter(grepl("sociounhcr", organizacion) | grepl("obc", organizacion) | grepl("ciremi", organizacion)) |> 
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "hias", "HIAS")) |>  
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "crus_roja", "Cruz Roja")) |> 
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "caritas", "Caritas")) |>  
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "encuentros", "Encuentros")) |> 
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "scalabrini", "Scalabrini")) |> 
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "ach", "ACH")) |> 
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "uv", "UV")) |> 
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "aldeas", "Aldeas"))|> 
  dplyr::filter(tipo_socio != "other") |> 
    select(region, today, organizacion, starts_with("qt_kit"), starts_with("qt_cri")) |>
  mutate_at(vars(starts_with("qt_kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("qt_kit")), as.numeric) |>
  mutate_at(vars(starts_with("qt_cri")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("qt_cri")), as.numeric) |>
  group_by(region, today, organizacion) |> 
  summarise_at(vars(starts_with("qt_")), sum, na.rm = TRUE) 

  


## Adding min and max dates for missing values by region and organization
kits_cris_list_trend_detail_socios_min <- kits_cris_list_trend_detail_socios |> 
  group_by(region, organizacion) |> 
  summarize(across(where(is.numeric), ~ 0), today = referencemin)

kits_cris_list_trend_detail_socios_max <- kits_cris_list_trend_detail_socios |> 
  group_by(region, organizacion) |> 
  summarize(across(where(is.numeric), ~ 0), today = referencemax)



## Continuing the pipe: Trends by type of kits and CRIs and partners
kits_cris_list_trend_detail_socios <- kits_cris_list_trend_detail_socios |>
  ungroup() |> 
  bind_rows(kits_cris_list_trend_detail_socios_min) |>
  bind_rows(kits_cris_list_trend_detail_socios_max) |>
  group_by(region, organizacion) |> 
  complete(today = seq(min(today), max(today), by = "1 day")) %>%
  # pad(interval = "day") |>
  ungroup() |> 
  mutate_at(vars(starts_with("qt_")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("qt_")), list(~zoo::rollmean(., 7, fill = NA, align = "center"))) |> 
  na.omit()|> 
  filter(today > referencemin) |> 
  na.omit() |> 
  group_by(region, organizacion) |> 
  summarise_at(vars(starts_with("qt_")), mean, na.rm = TRUE) |> 
  mutate_at(vars(starts_with("qt_")), 
            list(~. * projectiondays)) |> 
  mutate_at(vars(starts_with("qt_")), 
            list(~round(., digits = 0))) |> 
    pivot_longer(cols = c(starts_with("qt_")), names_to="Tipo", values_to="Total") |>
  left_join(xls, by = c('Tipo' = 'name')) |> 
  mutate(Kit_CRI = case_when(str_detect(Tipo, 'qt_kit') ~ 'Kit',
                TRUE ~ 'CRI')) |>
  select(region, organizacion, Kit_CRI, label, Total) |> 
  rename("Detalle" = label) |> 
    filter(Total > 0) |> 
    #rowSums(na.rm = TRUE) |> 
  pivot_wider(names_from = region, values_from = Total) |> 
  mutate_if(is.numeric , replace_na, replace = 0) |> 
#   separate(Tipo, into=c("Kit_CRI", "Detalle"), sep = 3) |> 
#   mutate(across(c('Detalle'), substr, 6, nchar(Detalle))) |> 
# #  mutate(across(c('Detalle'), str_replace, '_', ' '))
#   mutate_all(funs(str_replace_all(., "_", " "))) |> 
  # mutate(Detalle = sub("(.)", "\\U\\1", Detalle, perl=TRUE)) |> 
  mutate_all(funs(str_replace_all(., "acnur", "ACNUR"))) |> 
  mutate_all(funs(str_replace_all(., "nna", "NNA"))) |> 
  mutate(across('Kit_CRI', str_replace, 'kit', 'Kit')) |> 
  mutate(across('Kit_CRI', str_replace, 'cri', 'CRI')) |> 
  mutate(across('organizacion', str_replace, 'obc', 'OBC')) |> 
  mutate(across('organizacion', str_replace, 'sociounhcr', 'Socio ACNUR Local')) |> 
  mutate(across('organizacion', str_replace, 'ciremi', 'CIREMI')) |> 
  mutate_at(vars(4:last_col()), as.numeric) |>
  mutate_at(vars(4:last_col()), ~replace_na(.,0)) |>
  mutate(Total = rowSums(across(4:last_col()))) |>
  rename("Org." = organizacion) |>
  # mutate_at(vars("PE04":"PE24"), as.numeric) |>
  # mutate_at(vars("PE04":"PE24"), ~replace_na(.,0)) |>
  # mutate(Total = rowSums(across("PE04":"PE24"))) |>
  filter(Total > 5) |> 
  select(`Org.`, Detalle, Total)


ggplot(
  kits_cris_list_trend_detail_socios,
  aes(
    x = `Org.`,
    y = fct_rev(Detalle)
  )
) +
  geom_tile(aes(
    fill = Total
  ),
  color = "white",
  lwd = .5,
  linetype = 1
  ) +
  geom_text(aes(label = Total), colour = "white", size = 3)  +
  labs(
    title = "Kits, CRIs y Food Items posiblemente necesitados por socio",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
  # scale_x_continuous(
  #   expand = expansion(c(0, 0)),
  #   breaks = pretty_breaks(n = 10)
  # ) +
  # scale_y_discrete(
  #   labels = scales::label_wrap(17)
  # ) +
  scale_fill_stepsn(
    colors = unhcr_pal(n = 3, "pal_navy"),
    n.break = 10,
    name = "Numero de insumos"
  ) +
  # coord_fixed() +
    theme_unhcr(
    font_size = 11,
    grid = FALSE,
    axis = FALSE,
    axis_title = FALSE,
    axis_text_size = 10,
    legend_title = TRUE,
    legend = FALSE
  )

# kits_cris_list_trend_detail_socios |>
#   kbl() |>
#   kable_styling(bootstrap_options = "striped", html_font = "Arial", font_size = 9)
# 
# library(glue)
# library(gluedown)
# 
# kits_cris_list_trend_detail_socios_top_5 <- kits_cris_list_trend_detail_socios |>
#   # group_by(Detalle, `Org.`) |>
#   # summarise_at(vars("Total"), sum, na.rm = TRUE) |>
#   slice_max(order_by = Total, n = 5) |>
#   glue_data("**{Detalle}**: {`Org.`} ({Total})") |>
#   md_bullet()

```

El Anexo 2 brinda un desglose completo por tipo de insumo, socio y región.

\newpage

## Brechas
```{r brechas_setup, echo=FALSE, warning=FALSE}

#How much is available in stock

activityInfoToken(Sys.getenv('ACTIVITYINFO_API'), prompt = FALSE)

stock_data <- queryTable("c9rxrtmlyt3ar193") |> 
  select(Unidad.Name, Tipo.de.kit, Cantidad.en.stock, Fecha.de.actualizacion) |> 
  rename(region = Unidad.Name) |> 
  rename(Detalle = Tipo.de.kit) |> 
  rename(Stock = Cantidad.en.stock) |> 
  rename(Update = Fecha.de.actualizacion) |> 
  mutate(Detalle = stri_trans_general(Detalle, "Latin-ASCII")) |> 
  mutate(across('Detalle', str_replace, 'Familiar', 'Kit de higiene (familiar)')) |> 
  mutate(across('Detalle', str_replace, 'Adultos', 'Kit Adultos/as/es (personas en tránsito – caminante)')) |> 
  mutate(across('Detalle', str_replace, 'Extra Mujer', 'Kit de dignidad (extra mujer)')) |>
  mutate(across('Detalle', str_replace, 'Nino/a', 'Kit de niño/a (personas en tránsito – caminante)')) |> 
  mutate(across('Detalle', str_replace, 'Bebe', 'Kit bebe (personas en tránsito – caminante)')) |> 
  mutate(across('region', str_replace, 'FU Tacna', 'Tacna'))


# How much has been distributed since the stock update
stock_used <- rudah_all |>
  select(region, today, starts_with("qt_kit"), starts_with("qt_cri")) |>
  mutate_at(vars(starts_with("qt_kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("qt_kit")), as.numeric) |>
  mutate_at(vars(starts_with("qt_cri")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("qt_cri")), as.numeric) |>
  group_by(region, today) |> 
  summarise_at(vars(starts_with("qt_kit"), starts_with("qt_cri")), sum, na.rm = TRUE) |> 
  ungroup() |> 
  filter(today > max(stock_data$Update)) |> 
  group_by(region) |> 
  summarise_at(vars(starts_with("qt_")), sum, na.rm = TRUE) |> 
  pivot_longer(cols = c(starts_with("qt_")), names_to="Tipo", values_to="Total") |>
  left_join(xls, by = c('Tipo' = 'name')) |>
  select(region, label, Total) |> 
  rename("Detalle" = label) |> 
  filter(Total > 0) |> 
  ungroup() |> 
  group_by(region, Detalle) |> 
  summarise_at(vars("Total"), sum, na.rm = TRUE) |> 
  filter(region == "Tacna")

# Projection: Kits needed
predict_tacna <- kits_cris_list_trend_detail |> 
  filter(region == "Tacna") |> 
  mutate(Detalle = stri_trans_general(Detalle, "Latin-ASCII")) |> 
  mutate(across('Detalle', ~ str_replace(., 'Kit Adultos/as/es \\(transito\\)', 'Kit Adultos/as/es (personas en tránsito – caminante)'))) |> 
  mutate(across('Detalle', ~ str_replace(., 'Kit de nino/a \\(transito\\)', 'Kit de niño/a (personas en tránsito – caminante)'))) |> 
    mutate(across('Detalle', ~ str_replace(., 'Kit bebe \\(transito\\)', 'Kit bebe (personas en tránsito – caminante)'))) 
  
# Gap calculation
brecha <- stock_data |> 
  left_join(stock_used, by = "Detalle") |> 
  mutate(Stock_rev = if_else(Stock - Total < 0, 0, Stock - Total)) |> 
  select(region.x, Detalle, Stock_rev) |> 
  left_join(predict_tacna, by = "Detalle") |> 
  rename(Predict = Total) |> 
  mutate(Available = Stock_rev - Predict) |> 
  mutate(Per_Day = Predict / 30) |> 
  mutate(Days_Left = round(Stock_rev / Per_Day, 0)) |> 
  mutate(Brecha = if_else(Days_Left < 30, "Brecha", "OK"))

```

Hay una **posible brecha** para los siguientes insumos:
```{r, echo=FALSE, warning = FALSE, message=FALSE, fig.align = 'left', fig.width=7,fig.height=2}
brecha |>
  filter(Brecha == "Brecha") |> 
  select(region, Detalle, Stock_rev, Predict, Days_Left) |> 
  rename(`Stock estimado` = Stock_rev) |> 
  rename(`Necesarios` = Predict) |> 
  rename(`Días cubiertos` = Days_Left) |>  
  group_by(region) |>
  gt() |> 
  tab_style(
    style = cell_text(size = px(12), indent = px(20)),
    locations = cells_body()) |> 
  tab_header(
    title = md("Brechas de insumos durante los próximos 30 días"),
    subtitle = "Por región, tipo de insumo y cantidad"
  ) |> 
  tab_source_note(
    source_note = md(
      "Fuente: Estimación desde el Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
    )
  ) |> 
    opt_row_striping(row_striping = TRUE) |> 
  tab_options(data_row.padding = px(1),
                heading.padding = px(3),
                heading.title.font.size = px(14),
                heading.subtitle.font.size = px(12),
                column_labels.font.size = px(12),
                column_labels.font.weight = px(12),
                row_group.font.size = px(13),
                row_group.padding = px(2),
                source_notes.font.size = px(9),
                table.width = pct(100))

```

No se registra una brecha para los siguientes insumos:
```{r, echo=FALSE, warning = FALSE, message=FALSE, fig.align = 'left', fig.width=7,fig.height=2}
brecha |>
  filter(Brecha != "Brecha") |> 
  select(region, Detalle, Stock_rev, Predict, Days_Left) |> 
  rename(`Stock estimado` = Stock_rev) |> 
  rename(`Necesarios` = Predict) |> 
  rename(`Días cubiertos` = Days_Left) |>  
  group_by(region) |>
  gt() |> 
  tab_style(
    style = cell_text(size = px(12), indent = px(20)),
    locations = cells_body()) |> 
  tab_header(
    title = md("Insumos y stocks para los próximos 30 días"),
    subtitle = "Por región, tipo de insumo y cantidad"
  ) |> 
  tab_source_note(
    source_note = md(
      "Fuente: Estimación desde el Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
    )
  ) |> 
    opt_row_striping(row_striping = TRUE) |> 
  tab_options(data_row.padding = px(1),
                heading.padding = px(3),
                heading.title.font.size = px(14),
                heading.subtitle.font.size = px(12),
                column_labels.font.size = px(12),
                column_labels.font.weight = px(12),
                row_group.font.size = px(13),
                row_group.padding = px(2),
                source_notes.font.size = px(9),
                table.width = pct(100))

```

\newpage
```{r, echo=FALSE, warning = FALSE, message=FALSE, fig.align = 'left', fig.width=7,fig.height=2}



kits_cris_list <- rudah |>
  select(region, starts_with("qt_kit"), starts_with("qt_cri")) |>
  mutate_at(vars(starts_with("qt_kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("qt_kit")), as.numeric) |>
  mutate_at(vars(starts_with("qt_cri")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("qt_cri")), as.numeric) |>
  pivot_longer(!region, names_to="Tipo", values_to="Total") |>
  rename(`name` = Tipo) |> 
  left_join(xls, by = "name") |> 
  separate(name, into=c("Kit_CRI", "Detalle"), sep = 6) |> 
#  mutate(across(c('Kit_CRI'), substr, 2, nchar(my_column))) |> 
  mutate(across(c('Kit_CRI'), substr, 4, nchar(Kit_CRI))) |> 
  select(region, Kit_CRI, Total, label) |> 
  mutate(across('Kit_CRI', str_replace, 'kit', 'Kit')) |> 
  mutate(across('Kit_CRI', str_replace, 'cri', 'CRI')) |> 
  filter(Total != 0) |> 
  rename(`Detalle` = `label`) |> 
  mutate(Detalle = str_remove(Detalle, "(caminante)")) |> 
  mutate(Detalle = str_remove(Detalle, " – ")) |> 
  mutate(Detalle = str_remove_all(Detalle, "\\(\\)")) |> 
  mutate(Detalle = str_remove(Detalle, "para adolescente y/o adulto")) |> 
  mutate(Detalle = str_remove(Detalle, "personas en ")) |> 
  mutate(Detalle = str_remove(Detalle, "de niñas, niños y adolescentes ")) |> 
  mutate_at(vars(Total), as.numeric) |>
  group_by(region, Kit_CRI, Detalle) |> 
  summarise_at(c("Total"), sum, na.rm = TRUE) |> 
  arrange(region, Kit_CRI, -Total)

kits_list <- kits_cris_list |> 
  filter(Kit_CRI == "Kit") |> 
  ungroup() |> 
  select(region, Detalle, Total)

cris_list <- kits_cris_list |> 
  filter(Kit_CRI == "CRI") |> 
  ungroup() |> 
  select(region, Detalle, Total)


kits_list |>
  group_by(region) |>
  gt() |> 
  tab_style(
    style = cell_text(size = px(12), indent = px(20)),
    locations = cells_body()) |> 
  tab_header(
    title = md("Anexo 1a: Kits distribuidos durante los últimos 7 días"),
    subtitle = "Por región, tipo de insumo y cantidad"
  ) |> 
  tab_source_note(
    source_note = md(
      "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
    )
  ) |> 
    opt_row_striping(row_striping = TRUE) |> 
  tab_options(data_row.padding = px(1),
                heading.padding = px(3),
                heading.title.font.size = px(14),
                heading.subtitle.font.size = px(12),
                column_labels.font.size = px(12),
                column_labels.font.weight = px(12),
                row_group.font.size = px(13),
                row_group.padding = px(2),
                source_notes.font.size = px(9),
                table.width = pct(100))


cris_list |>
  group_by(region) |>
  gt(groupname_col = "region") |> 
  tab_style(
    style = cell_text(size = px(12), indent = px(20)),
    locations = cells_body()) |> 
  tab_header(
    title = md("Anexo 1b: CRI/Food Items distribuidos durante los últimos 7 días"),
    subtitle = "Por región, tipo de insumo y cantidad"
  ) |> 
  tab_source_note(
    source_note = md(
      "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
    )
  ) |> 
    opt_row_striping(row_striping = TRUE) |> 
   tab_options(data_row.padding = px(1),
                heading.padding = px(3),
                heading.title.font.size = px(14),
                heading.subtitle.font.size = px(12),
                column_labels.font.size = px(12),
                column_labels.font.weight = px(12),
                row_group.font.size = px(13),
                row_group.padding = px(2),
                source_notes.font.size = px(9),
                table.width = pct(100))


```

\newpage

```{r, echo=FALSE, warning = FALSE, message = FALSE,  fig.width=7,fig.height=3}

## Mobile average over time of kits and CRI distributions by region by partner

## Preparing the data

kits_cris_list_trend_detail_socios <- rudah_all |>
  dplyr::filter(grepl("sociounhcr", organizacion) | grepl("obc", organizacion) | grepl("ciremi", organizacion)) |> 
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "hias", "HIAS")) |>  
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "crus_roja", "Cruz Roja")) |> 
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "caritas", "Caritas")) |>  
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "encuentros", "Encuentros")) |> 
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "scalabrini", "Scalabrini")) |> 
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "ach", "ACH")) |> 
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "uv", "UV")) |> 
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "aldeas", "Aldeas"))|> 
  dplyr::filter(tipo_socio != "other") |> 
  select(region, today, organizacion, "kit_dis_kit_abrigo_bebe":"kit_dis_other", "cri_dis_balde":"cri_dis_teclado") |>
  mutate_at(vars(starts_with("kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("kit")), as.numeric) |>
  mutate_at(vars(starts_with("cri")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("cri")), as.numeric) |>
   group_by(region, today, organizacion) |> 
  summarise_at(vars("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), sum, na.rm = TRUE) 


## Adding min and max dates for missing values by region and organization
kits_cris_list_trend_detail_socios_min <- kits_cris_list_trend_detail_socios |> 
  group_by(region, organizacion) |> 
  summarize(across(where(is.numeric), ~ 0), today = referencemin)

kits_cris_list_trend_detail_socios_max <- kits_cris_list_trend_detail_socios |> 
  group_by(region, organizacion) |> 
  summarize(across(where(is.numeric), ~ 0), today = referencemax)



## Continuing the pipe: Trends by type of kits and CRIs and partners
kits_cris_list_trend_detail_socios <- kits_cris_list_trend_detail_socios |>
  ungroup() |> 
  bind_rows(kits_cris_list_trend_detail_socios_min) |>
  bind_rows(kits_cris_list_trend_detail_socios_max) |>
  group_by(region, organizacion) |> 
  complete(today = seq(min(today), max(today), by = "1 day")) %>%
  # pad(interval = "day") |>
  ungroup() |> 
  mutate_at(vars(starts_with("Kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("CRI")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), list(~zoo::rollmean(., 7, fill = NA, align = "center"))) |> 
  na.omit()|> 
  filter(today > referencemin) |> 
  na.omit() |> 
  group_by(region, organizacion) |> 
  summarise_at(vars("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), mean, na.rm = TRUE) |> 
  mutate_at(vars("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), 
            list(~. * projectiondays)) |> 
  mutate_at(vars("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), 
            list(~round(., digits = 0))) |> 
  pivot_longer(cols = c("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), names_to="Tipo", values_to="Total") |>
 # filter(Total > 0) |> 
  mutate_if(is.numeric , replace_na, replace = 0) |> 
  pivot_wider(names_from = region, values_from = Total) |> 
  separate(Tipo, into=c("Kit_CRI", "Detalle"), sep = 3) |> 
  mutate(across(c('Detalle'), substr, 6, nchar(Detalle))) |> 
#  mutate(across(c('Detalle'), str_replace, '_', ' '))
  mutate_all(funs(str_replace_all(., "_", " "))) |> 
  mutate(Detalle = sub("(.)", "\\U\\1", Detalle, perl=TRUE)) |> 
  mutate_all(funs(str_replace_all(., "acnur", "ACNUR"))) |> 
  mutate_all(funs(str_replace_all(., "nna", "NNA"))) |> 
  mutate(across('Kit_CRI', str_replace, 'kit', 'Kit')) |> 
  mutate(across('Kit_CRI', str_replace, 'cri', 'CRI')) |> 
  mutate(across('organizacion', str_replace, 'obc', 'OBC')) |> 
  mutate(across('organizacion', str_replace, 'sociounhcr', 'Socio ACNUR Local')) |> 
  mutate(across('organizacion', str_replace, 'ciremi', 'CIREMI')) |> 
  mutate_at(vars(4:last_col()), as.numeric) |>
  mutate_at(vars(4:last_col()), ~replace_na(.,0)) |>
  mutate(Total = rowSums(across(4:last_col()))) |>  mutate_at(vars(4:last_col()), ~replace_na(.,0)) |>
  mutate(Total = rowSums(across(4:last_col()))) |> 
  rename("Org." = organizacion) |>
  # mutate_at(vars("PE04":"PE24"), as.numeric) |>
  # mutate_at(vars("PE04":"PE24"), ~replace_na(.,0)) |>
  # mutate(Total = rowSums(across("PE04":"PE24"))) |>
  filter(Total > 5) |> 
  arrange(`Org.`, Kit_CRI, Detalle) 


kits_list_trend_detail_socios <- kits_cris_list_trend_detail_socios |> 
  filter(Kit_CRI == "Kit") |> 
  ungroup() |> 
  select(!Kit_CRI)

cris_list_trend_detail_socios <- kits_cris_list_trend_detail_socios |> 
  filter(Kit_CRI == "CRI") |> 
  ungroup() |> 
  select(!Kit_CRI)

kits_list_trend_detail_socios |>
  group_by(`Org.`) |>
  gt() |> 
  tab_style(
    style = cell_text(size = px(12), indent = px(20)),
    locations = cells_body()) |> 
  tab_header(
    title = md("Anexo 2a: Proyección de Kits necesarios"),
    subtitle = "Para los próximos 30 días por región, socio y tipo de insumo"
  ) |> 
  tab_source_note(
    source_note = md(
      "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
    )
  ) |> 
    opt_row_striping(row_striping = TRUE) |> 
  tab_options(data_row.padding = px(1),
                heading.padding = px(3),
                heading.title.font.size = px(14),
                heading.subtitle.font.size = px(12),
                column_labels.font.size = px(12),
                column_labels.font.weight = px(12),
                row_group.font.size = px(13),
                row_group.padding = px(2),
                source_notes.font.size = px(9))



cris_list_trend_detail_socios |>
  group_by(`Org.`) |>
  gt() |> 
  tab_style(
    style = cell_text(size = px(12), indent = px(20)),
    locations = cells_body()) |> 
  tab_header(
    title = md("Anexo 2b: Proyección de CRI/Food Items necesarios"),
    subtitle = "Para los próximos 30 días por región, socio y tipo de insumo"
  ) |> 
  tab_source_note(
    source_note = md(
      "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
    )
  ) |> 
    opt_row_striping(row_striping = TRUE) |> 
  tab_options(data_row.padding = px(1),
                heading.padding = px(3),
                heading.title.font.size = px(14),
                heading.subtitle.font.size = px(12),
                column_labels.font.size = px(12),
                column_labels.font.weight = px(12),
                row_group.font.size = px(13),
                row_group.padding = px(2),
                source_notes.font.size = px(9),
                table.width = pct(100))



```
