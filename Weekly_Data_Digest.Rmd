---
title: "Weekly Data Digest"
author: IM ACNUR Peru
output: unhcrdown::paged_simple
knit: pagedown::chrome_print

---

<style type="text/css">

body, td {
   font-size: 12px;
}
code.r{
  font-size: 10px;
}
pre {
  font-size: 10px
}

   .main-container {max-width: 100%;}
   .row {display: flex;}
   .column {flex: 50%;}

</style>


```{r setup, include=FALSE}
library(robotoolbox)
library(tidyverse)
library(purrr)
library(dplyr)
library(readxl)
library(ggplot2) 
library(unhcrthemes)
library(scales)
library(directlabels)
library(labelled)
library(knitr)
library(kableExtra)
library(treemapify)

#load("token.rds")

date_start_filter <- Sys.Date() - 7

kobo_setup(url = "https://kobo.unhcr.org",
           token = Sys.getenv('KOBO_API_KEY'))


# Monitoreo de fronteras
x <- kobo_submissions("a9Erto2aYbgJamz8vdrtJt")
main <- x$main
member2 <- x$member

main <- main |> 
    dplyr::filter(test_real == "registro_real")

main_last_week <- main |> 
  dplyr::filter(today > date_start_filter) |>
  dplyr::filter(grepl("mon_fro",kit_orientacion)) 

names_per <- c('perfil')
main_last_week[,names_per] <- lapply(main_last_week[,names_per] , to_factor)

main_last_week_tumbes <- main_last_week |> 
  filter(lugar_monitoreo == "tumbes")

main_last_week_tacna <- main_last_week |> 
  filter(lugar_monitoreo == "tacna")

main_last_week_mdd <- main_last_week |> 
  filter(lugar_monitoreo == "mdd")

main_last_week_lima <- main_last_week |> 
  filter(lugar_monitoreo == "lima")

main_last_week_puno <- main_last_week |> 
  filter(lugar_monitoreo == "puno")


# MasterFile Excel on SharePoint
# library(Microsoft365R)# Get your SharePoint site

# Replace "My Site" to your SharePoint site
# my_site_url="https://unhcr365.sharepoint.com/teams/amer-peria/"
#app = Sys.getenv('SHAREPOINT_KEY')
# app = read_rds("token.rds")
# 
# 
# #pass error?
# site <- get_sharepoint_site(site_url = my_site_url, app = app)
# drv <- site$get_drive()## you can see your files
# 
# # File path in the form of "Folder1/Folder2"
# drv$list_files()
# drv$list_files("MyE ACNUR/5. IM Products/Dashboard Situacion Peru", full_names=TRUE)
# 
# # download your file in the current diretory
# drv$download_file("MyE ACNUR/5. IM Products/Dashboard Situacion Peru/MasterFile.xlsx",overwrite = TRUE)
# 
# DTM <- read_excel("MasterFile.xlsx", sheet="DTM", skip=0 )
# 
# file.remove("MasterFile.xlsx")
# 


```
`r Sys.Date()`

Boletín semanal para la operación ACNUR Perú.

## Flujos en frontera


```{r echo=FALSE, warning=FALSE, message=FALSE, fig.align = 'center', results='hide', fig.width=7,fig.height=2.7}

library(webshot2)
library(png)

img <- webshot2::webshot(url = "https://app.powerbi.com/view?r=eyJrIjoiMjlmZjcyNzYtODI5Yy00NzQ2LWIwZTItZjczMWM0OTI3NGU1IiwidCI6IjE1ODgyNjJkLTIzZmItNDNiNC1iZDZlLWJjZTQ5YzhlNjE4NiIsImMiOjh9", 
                             "dtm.png", delay = 10, zoom = 2)

img <- readPNG("dtm.png")

# Define the cropping coordinates
x_start <- 0  # starting x-coordinate
y_start <- 160   # starting y-coordinate
width <- 1970    # width of the cropped region
height <- 1000   # height of the cropped region

# Crop the image
cropped_img <- img[y_start:(y_start + height - 1), x_start:(x_start + width - 1), ]

# Save the cropped image (optional)
writePNG(cropped_img, "dtm.png")


```


![](dtm.png){height=90%}

Dashboard DTM de conteos en frontera: [](https://app.powerbi.com/view?r=eyJrIjoiMjlmZjcyNzYtODI5Yy00NzQ2LWIwZTItZjczMWM0OTI3NGU1IiwidCI6IjE1ODgyNjJkLTIzZmItNDNiNC1iZDZlLWJjZTQ5YzhlNjE4NiIsImMiOjh9)

Se preparará proximamente una visualización de los flujos observados directamente en este reporte.

Para más información, consultar el [dashboard de estadísticas poblacionales](https://app.powerbi.com/links/xEqM6jT2c9?ctid=e5c37981-6664-4134-8a0c-6543d2af80be) (pestaña "Flujos Irregulares").

\newpage
## Monitoreo de fronteras

Durante la semana pasada se entrevistaron `r nrow(main_last_week)` grupos (`r sum(main_last_week$miembros)` personas). Entre ellos, `r nrow(main_last_week_tumbes)` en Tumbes, `r nrow(main_last_week_tacna)` en Tacna, `r nrow(main_last_week_puno)` en Puno, y `r nrow(main_last_week_mdd)` en Madre de Dios.  

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.align = 'center', results='hide', fig.width=7,fig.height=2.7}


data(main_last_week, package = "unhcrthemes")
names <- c('lugar_monitoreo')
main_last_week[,names] <- lapply(main_last_week[,names] , to_factor)

main_last_week_chart_previo <- main_last_week |> 
  select(paisprevio, lugar_monitoreo) |> 
  group_by(paisprevio, lugar_monitoreo) |> 
  summarise(total = n()) |> 
  group_by(lugar_monitoreo) |> 
  mutate(percent = total/sum(total)) |> 
  ungroup() 
#  select(paisprevio, lugar_monitoreo, percent) 


#glimpse(main_last_week_chart_previo)

#ymax_previo <- ifelse(max(main_last_week_chart_previo$total) / sum(main_last_week_chart_previo$total) > 0.89, 1, max(main_last_week_chart_previo$total) / sum(main_last_week_chart_previo$total) + 0.1)
# 
# 
# ggplot(main_last_week_chart_previo, aes(x = reorder(paisprevio, -percent), y = percent)) +
#   geom_col(
#            fill = unhcr_pal(n = 1, "pal_blue"),
#            width = 0.8) +
#    geom_text(aes(label = paste0( round(percent*100, 0), "%" )), vjust = 1.5, colour = "white", size = 5) +
#   labs(title = "Principales paises de procedencia",
#        y = "Personas entrevistadas",
#        caption = "Fuente: Monitoreo de Fronteras de ACNUR") +
#   scale_y_continuous(labels=scales::percent) +
#   coord_cartesian(ylim = c(0.0, 1)) + 
#  # scale_x_continuous(breaks = pretty_breaks(10)) +
#  theme_unhcr(font_size = 14,
#     grid = FALSE,
#     axis = FALSE,
#     axis_title = FALSE,
#     axis_text = "x"
#   ) +
#   facet_grid(~ lugar_monitoreo, scales='free', space='free') 



# Plot
ggplot(
  main_last_week_chart_previo,
  aes(area = total,
  subgroup = lugar_monitoreo)) +
  geom_treemap(
    color = "#FFFFFF",
    size = 1,
    fill = unhcr_pal(n = 1, "pal_blue"),
    start = "topleft"
  ) +
  geom_treemap_text(aes(label = paste0(
    round(percent * 100, 1),
    "%\n",
    paisprevio
  )),
  color = "#FFFFFF",
  size = 16,
  start = "topleft",
  family = "Lato"
  ) +
  labs(
    title = "Principales paises de procedencia",
    caption = "Fuente: Monitoreo de Fronteras de ACNUR"
  ) +
  theme_unhcr(
    axis = FALSE,
    axis_title = FALSE,
    grid = FALSE,
    font_size = 20
  ) +
  geom_treemap_subgroup_border(colour = "white", size = 4) +
  # geom_treemap_subgroup_text(place = "bottom",
  #                            grow = F,
  #                            alpha = 0.6,
  #                            colour = "#FAFAFA",
  #                            min.size = 0,
  #                            max.size = 5) 
 facet_wrap( ~ lugar_monitoreo)


```

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.align = 'center', results='hide', fig.width=7,fig.height=2.7}

data(main_last_week, package = "unhcrthemes")


main_last_week_chart_destino <- main_last_week |> 
  select(paisdestino, lugar_monitoreo) |> 
  group_by(paisdestino, lugar_monitoreo) |> 
  summarise(total = n()) |> 
  group_by(lugar_monitoreo) |> 
  mutate(percent = total/sum(total)) |> 
  ungroup() 
#  select(paisdestino, lugar_monitoreo, percent) 


#glimpse(main_last_week_chart_destino)

#ymax_destino <- ifelse(max(main_last_week_chart_destino$total) / sum(main_last_week_chart_destino$total) > 0.89, 1, max(main_last_week_chart_destino$total) / sum(main_last_week_chart_destino$total) + 0.1)

# 
# 
# ggplot(main_last_week_chart_destino, aes(x = reorder(paisdestino, -percent), y = percent)) +
#   geom_col(
#            fill = unhcr_pal(n = 1, "pal_blue"),
#            width = 0.8) +
#    geom_text(aes(label = paste0( round(percent*100, 0), "%" )), vjust = 1.5, colour = "white", size = 5) +
#   labs(title = "Principales paises de destino",
#        y = "Personas entrevistadas",
#        caption = "Fuente: Monitoreo de Fronteras de ACNUR") +
#   scale_y_continuous(labels=scales::percent) +
#   coord_cartesian(ylim = c(0.0, 1)) + 
#  # scale_x_continuous(breaks = pretty_breaks(10)) +
#  theme_unhcr(font_size = 14,
#     grid = FALSE,
#     axis = FALSE,
#     axis_title = FALSE,
#     axis_text = "x"
#   ) +
#   facet_grid(~ lugar_monitoreo, scales='free', space='free') 



# Plot
ggplot(
  main_last_week_chart_destino,
  aes(area = total,
  subgroup = lugar_monitoreo)) +
  geom_treemap(
    color = "#FFFFFF",
    size = 1,
    fill = unhcr_pal(n = 1, "pal_blue"),
    start = "topleft"
  ) +
  geom_treemap_text(aes(label = paste0(
    round(percent * 100, 1),
    "%\n",
    paisdestino
  )),
  color = "#FFFFFF",
  size = 16,
  start = "topleft",
  family = "Lato"
  ) +
  labs(
    title = "Principales paises de destino",
    caption = "Fuente: Monitoreo de Fronteras de ACNUR"
  ) +
  theme_unhcr(
    axis = FALSE,
    axis_title = FALSE,
    grid = FALSE,
    font_size = 20
  ) +
  geom_treemap_subgroup_border(colour = "white", size = 4) +
  # geom_treemap_subgroup_text(place = "bottom",
  #                            grow = F,
  #                            alpha = 0.6,
  #                            colour = "#FAFAFA",
  #                            min.size = 0,
  #                            max.size = 5) 
 facet_wrap( ~ lugar_monitoreo)


```


Para más información, consultar el [dashboard de monitoreo de fronteras](https://app.powerbi.com/links/5xMJ63-7XL?ctid=e5c37981-6664-4134-8a0c-6543d2af80be).



\newpage
## Distribuciones durante los últimos 7 días

<div class = "row">
<div class = "column">
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.align = 'center', results='hide'}

rudah <- main |> 
  dplyr::filter(today > date_start_filter) 


total_kits <- rudah |> 
 select("kit_dis_kit_abrigo_bebe":"kit_dis_other")  |>  
  mutate_all(~coalesce(.,0)) |> 
  rowSums() |> 
  sum()

total_cris <- rudah |> 
 select("cri_dis_balde":"cri_dis_teclado") |> 
 mutate_all(~coalesce(.,0)) |> 
 rowSums() |> 
 sum()

personas_kits <- rudah |> 
  mutate(sum = rowSums(across("kit_dis_kit_abrigo_bebe":"kit_dis_other"))) |> 
  filter(sum > 0) |> 
  select("member_count") |> 
  mutate_all(~coalesce(.,0)) |> 
  rowSums() |> 
  sum()

personas_cris <- rudah |> 
  mutate(sum = rowSums(across("cri_dis_balde":"cri_dis_teclado"))) |> 
  filter(sum > 0) |> 
  select("member_count") |> 
  mutate_all(~coalesce(.,0)) |> 
  rowSums() |> 
  sum()


personas_kits_cris <- rudah |> 
  filter(grepl('asistencia_kit', kit_orientacion)) |> 
  select("member_count") |> 
  rowSums() |> 
  sum()

# Loading required packages
library(ggtext)
library(ggforce)

kits_cris_plot <- data.frame(total_cris, total_kits) |> 
  rename("CRI" = total_cris) |>
  rename("Kits" = total_kits) |>
  pivot_longer(cols = CRI:Kits, names_to = "Type", values_to = "Total")


# Plot total CRIs and Kits
ggplot(kits_cris_plot) +
  geom_arc_bar(aes(
    x0 = 0,
    y0 = 0,
    r0 = 0.6,
    r = 1,
    amount = Total,
    fill = Type
  ),
  stat = "pie",
  size = 1,
  color = "#FFFFFF"
  ) +
  geom_richtext(
    x = c(1.25, -1.25),
    y = c(-0.3, 0.3),
    aes(label = paste0(
      Type,
      "<br><strong> ",
      round(Total, 0),
      "</strong>", "<br>",
      round(100 * Total / sum(Total), 1),
      "%"
    )),
    size = 12,
    fill = NA,
    label.color = NA
  ) +
  geom_richtext(
    x = 0,
    y = 0,
    label = paste0(
      "Total distribuido",
      "<br><strong>",
      round(sum(kits_cris_plot$Total), 0),
      "</strong>"
    ),
    size = 12,
    fill = NA,
    label.color = NA
  ) +
  labs(
    title = "Kits y CRIs distribuidos",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
  scale_fill_unhcr_d(
    palette = "pal_unhcr",
    direction = -1
  ) +
  scale_x_continuous(expand = expansion(c(0.3, 0.5))) +
  theme_unhcr(
    grid = FALSE,
    axis = FALSE,
    axis_title = FALSE,
    axis_text = FALSE,
    legend = FALSE,
    font_size = 30
  )



```
</div>

<div class = "column">


Durante la última semana, la operación distribuyó `r total_kits` Kits y `r total_cris` CRIs, asistiendo a un total de `r personas_kits_cris` personas (`r personas_kits` personas recibieron kits y `r personas_cris` recibieron CRIs).

</div>
</div>

<div class = "row">

<div class = "column">
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.align = 'center', results='hide'}


## Preparing totals by region
names_lug <- c('region')
rudah[,names_lug] <- lapply(rudah[,names_lug] , to_factor)

rudah_kits_cris_plot <- rudah |>
  mutate(Kits = rowSums(across("kit_dis_kit_abrigo_bebe":"kit_dis_other"))) |>
  mutate(CRIs = rowSums(across("cri_dis_balde":"cri_dis_teclado"))) |>
  select("region", "Kits", "CRIs") |>
  group_by(region) |>
  summarise_at(c("Kits", "CRIs"), sum, na.rm = TRUE) |> 
  pivot_longer(!region, names_to="Tipo", values_to="Total")


rudah_kits_cris_plot <- mutate(rudah_kits_cris_plot, region = fct_reorder(region, -Total, sum))

cris_region <- rudah_kits_cris_plot |> 
  filter(Tipo == "CRIs") |> 
  filter(Total != 0) |> 
  select(region, Total) |> 
  mutate_at(vars(region), as.character)


kits_region <- rudah_kits_cris_plot |> 
  filter(Tipo == "Kits") |> 
  filter(Total != 0) |> 
  select(region, Total) |> 
  mutate_at(vars(region), as.character)



# CRIs by region
ggplot(cris_region, aes(x = Total, y = reorder(region, Total))) +
  geom_col(
  fill = unhcr_pal(n = 1, "pal_blue"),
  width = 0.2
  ) +
    geom_text(aes(label = Total),
  position = position_dodge(width = 0.7),
  hjust = -0.1,
  size = 8
  ) +
#  geom_text(aes(label = Total), hjust = 1.5, colour = "white", size = 8)  +
  labs(
    title = "CRIs distribuidos durante los últimos 7 días",
    x = "Número de CRIs",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
  scale_x_continuous(
    expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(n = 7),
    labels = label_number_si()
  ) +
  theme_unhcr(
    grid = FALSE,
    axis = "y",
    axis_title = "x",
    font_size = 30
  )
# # Kits by region
# ggplot(kits_region, aes(x = Total, y = reorder(region, Total))) +
#   geom_col(
#   fill = unhcr_pal(n = 1, "pal_blue"),
#   width = 0.8
#   ) +
#   geom_text(aes(label = Total), hjust = 1.5, colour = "white")  +
#   labs(
#     title = "Kits distribuidos durante los últimos 7 días",
#     x = "Número de CRIs",
#     caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
#   ) +
#   scale_x_continuous(
#     expand = expansion(c(0, 0.1)),
#     breaks = pretty_breaks(n = 7),
#     labels = label_number_si()
#   ) +
#   theme_unhcr(
#     grid = FALSE,
#     axis = "y",
#     axis_title = "x"
#   )


```
``
</div>


<div class = "column">
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.align = 'center', results='hide'}

# Kits by region
ggplot(kits_region, aes(x = Total, y = reorder(region, Total))) +
  geom_col(
  fill = unhcr_pal(n = 1, "pal_blue"),
  width = 0.8
  ) +
   geom_text(aes(label = Total),
  position = position_dodge(width = 0.7),
  hjust = -0.1,
  size = 8
  ) +
#  geom_text(aes(label = Total), hjust = 1.5, colour = "white", size = 8)  +
  labs(
    title = "Kits distribuidos durante los últimos 7 días",
    x = "Número de CRIs",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
  scale_x_continuous(
    expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(n = 7),
    labels = label_number_si()
  ) +
  theme_unhcr(
    grid = FALSE,
    axis = "y",
    axis_title = "x",
    font_size = 30
  )


```
``
</div>
</div>




```{r, echo=FALSE, warning = FALSE, message = FALSE,  fig.width=7,fig.height=3}

# 

# 
# 
# ggplot(rudah_kits_cris_plot) +
#   geom_col(aes(
#     x = Tipo,
#     y = Total,
#     fill = Tipo
#   ),
#   position = position_dodge(width = 0.7),
#   width = 0.6
#   ) +
# #  facet_wrap(~ Oficina, nrow = 2) +
#     facet_grid(~ region, scales='free', space='free') +
#   geom_text(aes(
#     x = Tipo,
#     y = Total,
#     group = Tipo,
#     label = Total
#   ),
#   position = position_dodge(width = 0.7),
#   vjust = -1,
#   size = 8 / .pt
#   ) +
#   scale_fill_unhcr_d(
#     palette = "pal_unhcr",
#     nmax = 3,
#     order = c(2, 3, 1)
#   ) +
#   labs(
#     title = "Asistencia brindada",
#     y = "Insumos distribuidos",
#     x = "Oficina de terreno",
#     caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
#   ) +
#  # scale_x_continuous(breaks = pretty_breaks(n = 4)) +
#   scale_y_continuous(expand = expansion(c(0, 0.1))) +
#   theme_unhcr(
#     grid = FALSE,
#     axis = "x",
#     axis_title = FALSE,
#     axis_text = "x"
#   ) +
#   ylim(0,rudah_kits_cris_plot_ymax) +
#   guides(fill = guide_legend(nrow = 2, byrow = TRUE)) +
#   facet_wrap(~ region, ncol = 3, scales='free') 
# 



total_kits_cris_line <- rudah |> 
 select(today, "kit_dis_kit_abrigo_bebe":"kit_dis_other", "cri_dis_balde":"cri_dis_teclado") |>  
  mutate_at(vars(starts_with("kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("kit")), as.numeric) |>
  mutate_at(vars(starts_with("cri")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("cri")), as.numeric) |>
  mutate(Kits = rowSums(across("kit_dis_kit_abrigo_bebe":"kit_dis_other"))) |>
  mutate(CRIs = rowSums(across("cri_dis_balde":"cri_dis_teclado"))) |>
  select(today, Kits, CRIs) |> 
  group_by(today) |>
  summarise_at(c("Kits", "CRIs"), sum, na.rm = TRUE) |> 
  pivot_longer(!today, names_to="Tipo", values_to="Total")
  
rudah_kits_cris_plot_ymax <- max(total_kits_cris_line$Total)*1.2

ggplot(total_kits_cris_line, aes(
    x = today,
    y = Total)) +
  geom_col(aes(
    fill = Tipo
  ),
  position = position_dodge(width = 0.7),
  width = 0.6
  ) +
  geom_text(aes(
    group = Tipo,
    label = Total, 
    size = 8
  ),
  position = position_dodge(width = 0.7),
  vjust = -1,
  size = 5
  ) +
  scale_fill_unhcr_d(
    palette = "pal_unhcr",
    nmax = 3,
    order = c(2, 3, 1)
  ) +
  labs(
    title = "Distribuciones diarias durante los ultimos 7 dias",
    y = "Cantidad de insumos",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
 # scale_x_continuous(breaks = pretty_breaks(n = 4)) +
  scale_y_continuous(
    expand = expansion(c(0, 0.1)),
    labels = label_number_si()
  ) +
  ylim(0,rudah_kits_cris_plot_ymax) +
  theme_unhcr(
    grid = FALSE,
    axis = "x",
    axis_title = "x",
    font_size = 16
  ) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE))


```

El Anexo 1 brinda el desglose de los Kits y CRIs distribuidos durante los últimos 7 días por región. 
\newpage








## Distribuciones acumuladas

<div class = "row">
<div class = "column">
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.align = 'center', results='hide'}

rudah_all <- main  


total_kits_all <- rudah_all |> 
 select("kit_dis_kit_abrigo_bebe":"kit_dis_other")  |>  
  mutate_all(~coalesce(.,0)) |> 
  rowSums() |> 
  sum()

total_cris_all <- rudah_all |> 
 select("cri_dis_balde":"cri_dis_teclado") |> 
 mutate_all(~coalesce(.,0)) |> 
 rowSums() |> 
 sum()

personas_kits_all <- rudah_all |> 
  mutate(sum = rowSums(across("kit_dis_kit_abrigo_bebe":"kit_dis_other"))) |> 
  filter(sum > 0) |> 
  select("member_count") |> 
  mutate_all(~coalesce(.,0)) |> 
  rowSums() |> 
  sum()

personas_cris_all <- rudah_all |> 
  mutate(sum = rowSums(across("cri_dis_balde":"cri_dis_teclado"))) |> 
  filter(sum > 0) |> 
  select("member_count") |> 
  mutate_all(~coalesce(.,0)) |> 
  rowSums() |> 
  sum()


personas_kits_cris_all <- rudah_all |> 
  filter(grepl('asistencia_kit', kit_orientacion)) |> 
  select("member_count") |> 
  rowSums() |> 
  sum()

# Loading required packages
library(ggtext)
library(ggforce)

kits_cris_plot_all <- data.frame(total_cris_all, total_kits_all) |> 
  rename("CRI" = total_cris_all) |>
  rename("Kits" = total_kits_all) |>
  pivot_longer(cols = CRI:Kits, names_to = "Type", values_to = "Total")


# Plot total CRIs and Kits
ggplot(kits_cris_plot_all) +
  geom_arc_bar(aes(
    x0 = 0,
    y0 = 0,
    r0 = 0.6,
    r = 1,
    amount = Total,
    fill = Type
  ),
  stat = "pie",
  size = 1,
  color = "#FFFFFF"
  ) +
  geom_richtext(
    x = c(1.25, -1.25),
    y = c(-0.3, 0.3),
    aes(label = paste0(
      Type,
      "<br><strong> ",
      format(Total, big.mark = ","),
 #     round(Total, 0),
      "</strong>", "<br>",
 #     format(round(100 * Total / sum(Total), 1), big.mark = ","),
      round(100 * Total / sum(Total), 1),
      "%"
    )),
    size = 12,
    fill = NA,
    label.color = NA
  ) +
  geom_richtext(
    x = 0,
    y = 0,
    label = paste0(
      "Total distribuido",
      "<br><strong>",
      format(sum(kits_cris_plot_all$Total), big.mark = ","),
#      round(sum(kits_cris_plot_all$Total), 0),
      "</strong>"
    ),
    size = 12,
    fill = NA,
    label.color = NA
  ) +
  labs(
    title = "Kits y CRIs distribuidos",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
  scale_fill_unhcr_d(
    palette = "pal_unhcr",
    direction = -1
  ) +
  scale_x_continuous(expand = expansion(c(0.3, 0.5))) +
  theme_unhcr(
    grid = FALSE,
    axis = FALSE,
    axis_title = FALSE,
    axis_text = FALSE,
    legend = FALSE,
    font_size = 30
  )

## Preparing totals by region
names_lug_all <- c('region')
rudah_all[,names_lug_all] <- lapply(rudah_all[,names_lug_all] , to_factor)

rudah_kits_cris_plot_all <- rudah_all |>
  mutate(Kits = rowSums(across("kit_dis_kit_abrigo_bebe":"kit_dis_other"))) |>
  mutate(CRIs = rowSums(across("cri_dis_balde":"cri_dis_teclado"))) |>
  select("region", "Kits", "CRIs") |>
  group_by(region) |>
  summarise_at(c("Kits", "CRIs"), sum, na.rm = TRUE) |> 
  pivot_longer(!region, names_to="Tipo", values_to="Total")


rudah_kits_cris_plot_all <- mutate(rudah_kits_cris_plot_all, region = fct_reorder(region, -Total, sum))

cris_region_all <- rudah_kits_cris_plot_all |> 
  filter(Tipo == "CRIs") |> 
  filter(Total != 0) |> 
  select(region, Total) |> 
  mutate_at(vars(region), as.character)


kits_region_all <- rudah_kits_cris_plot_all |> 
  filter(Tipo == "Kits") |> 
  filter(Total != 0) |> 
  select(region, Total) |> 
  mutate_at(vars(region), as.character)

start_rudah_all = min(rudah_all$today)

total_kits_cris_all = format(sum(rudah_kits_cris_plot_all$Total), big.mark = ",")

total_kits_all = format(sum(subset(rudah_kits_cris_plot_all, Tipo == "Kits")$Total), big.mark = ",")
total_cris_all = format(sum(subset(rudah_kits_cris_plot_all, Tipo == "CRIs")$Total), big.mark = ",")


```
</div>

<div class = "column">


Desde la implementación actual del RUDAH (`r start_rudah_all`) se registró la distribución de un total de `r total_kits_cris_all` insumos, entre ellos `r total_kits_all` Kits y `r total_cris_all` CRIs.

</div>
</div>

<div class = "row">

<div class = "column">
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.align = 'center', results='hide'}





# CRIs by region
ggplot(cris_region_all, aes(x = Total, y = reorder(region, Total))) +
  geom_col(
  fill = unhcr_pal(n = 1, "pal_blue"),
  width = 0.8
  ) +
    geom_text(aes(label = format(Total, big.mark = ",")),
  position = position_dodge(width = 0.7),
  hjust = -0.1,
  size = 8
  ) +
#  geom_text(aes(label = Total), hjust = 1.5, colour = "white", size = 8)  +
  labs(
    title = "CRIs distribuidos",
    x = "Número de CRIs",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
  scale_x_continuous(
    expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(n = 7),
    labels = label_number_si()
  ) +
  theme_unhcr(
    grid = FALSE,
    axis = "y",
    axis_title = "x",
    font_size = 30
  )


```
``
</div>


<div class = "column">
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.align = 'center', results='hide'}

# Kits by region
ggplot(kits_region_all, aes(x = Total, y = reorder(region, Total))) +
  geom_col(
  fill = unhcr_pal(n = 1, "pal_blue"),
  width = 0.8
  ) +
    geom_text(aes(label = format(Total, big.mark = ",")),
  position = position_dodge(width = 0.7),
  hjust = -0.1,
  size = 8
  ) +
#  geom_text(aes(label = Total), hjust = 1.5, colour = "white", size = 8)  +
  labs(
    title = "Kits distribuidos",
    x = "Número de CRIs",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
  scale_x_continuous(
    expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(n = 7),
    labels = label_number_si()
  ) +
  theme_unhcr(
    grid = FALSE,
    axis = "y",
    axis_title = "x",
    font_size = 30
  )


```
``
</div>
</div>




```{r, echo=FALSE, warning = FALSE, message = FALSE, dpi= 150,  fig.width=7,fig.height=3}

## Mobile average over time of kits and CRI distributions by region

library(zoo)
library(padr)

## Total trends CRIs and Kits national level
kits_cris_list_trend_all <- rudah_all |>
  select(today, "kit_dis_kit_abrigo_bebe":"kit_dis_other", "cri_dis_balde":"cri_dis_teclado") |>
  mutate_at(vars(starts_with("kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("kit")), as.numeric) |>
  mutate_at(vars(starts_with("cri")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("cri")), as.numeric) |>
  pivot_longer(cols = c("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), names_to="Tipo", values_to="Total") |>
  separate(Tipo, into=c("Kit_CRI", "Detalle"), sep = 3) |> 
  mutate(across('Kit_CRI', str_replace, 'kit', 'Kit')) |> 
  mutate(across('Kit_CRI', str_replace, 'cri', 'CRI')) |> 
  filter(Total != 0) |> 
  mutate_at(vars(Total), as.numeric) |>
  group_by(today, Kit_CRI) |> 
  summarise_at(c("Total"), sum, na.rm = TRUE) |> 
  arrange(today, Kit_CRI, -Total) |> 
  pivot_wider(names_from = Kit_CRI, values_from = Total) |> 
  ungroup() |> 
  mutate(group = "group") |> 
  padr::pad(interval = "day", group = "group") |> 
  mutate_at(vars(starts_with("Kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("CRI")), ~ replace(., is.na(.), 0)) |>
  group_by(group) |> 
#  filter(sum(Kit) + sum(CRI) != 0) |> 
  mutate(cma_kits = zoo::rollmean(Kit, 10, fill = NA)) |>   # Centered moving average
  mutate(cma_cris = zoo::rollmean(CRI, 10, fill = NA)) |> 
  filter(!is.na(cma_kits)) |> 
  select(today, cma_kits, cma_cris) 
  # rename("Kits" = cma_kits) |>
  # rename("CRIs" = cma_cris) 
#  pivot_longer(cols = c(Kits, CRIs), names_to = "Tipo", values_to = "Total")


ymax_kits_cris_list_trend_all <- max(kits_cris_list_trend_all$cma_kits * 1.1)

ggplot(kits_cris_list_trend_all, aes(
    x = today)) +
  geom_line(aes(
    y = cma_kits
  ),
  size = 0.5,
  color = unhcr_pal(n = 1, "pal_blue")
  ) +
  geom_line(aes(
    y = cma_cris
  ),
  size = 0.5,
  color = unhcr_pal(n = 1, "pal_grey")
  ) +
  labs(
    title = "Distribución de Kits y CRIs",
    y = "Numero de insumos",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
 # scale_x_continuous(breaks = pretty_breaks()) +
  scale_y_continuous(
    expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(n = 4),
    labels = label_number_si(),
    limits = c(0, ymax_kits_cris_list_trend_all)
  ) +
  theme_unhcr(font_size = 20,
    grid = "Y",
    axis = "x",
    axis_title = "y"
  ) 


```


Promedio móvil (10 días) de distribuciones diarias de Kits (en azul) y CRIs (en gris) a nivel nacional.

\newpage


Promedio móvil (10 días) de distribuciones diarias de Kits (en azul) y CRIs (en gris) por región:

```{r, echo=FALSE, warning = FALSE, message = FALSE, dpi=300,  fig.width=7,fig.height=5.8}

## Mobile average over time of kits and CRI distributions by region



## First total trends by total kits and CRIs
kits_cris_list_trend <- rudah_all |>
  select(region, today, "kit_dis_kit_abrigo_bebe":"kit_dis_other", "cri_dis_balde":"cri_dis_teclado") |>
  mutate_at(vars(starts_with("kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("kit")), as.numeric) |>
  mutate_at(vars(starts_with("cri")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("cri")), as.numeric) |>
  pivot_longer(cols = c("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), names_to="Tipo", values_to="Total") |>
  separate(Tipo, into=c("Kit_CRI", "Detalle"), sep = 3) |> 
  mutate(across('Kit_CRI', str_replace, 'kit', 'Kit')) |> 
  mutate(across('Kit_CRI', str_replace, 'cri', 'CRI')) |> 
  filter(Total != 0) |> 
  mutate_at(vars(Total), as.numeric) |>
  group_by(region, today, Kit_CRI) |> 
  summarise_at(c("Total"), sum, na.rm = TRUE) |> 
  arrange(region, today, Kit_CRI, -Total) |> 
  pivot_wider(names_from = Kit_CRI, values_from = Total) |> 
  ungroup() |> 
  pad(interval = "day", group = "region") |> 
  mutate_at(vars(starts_with("Kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("CRI")), ~ replace(., is.na(.), 0)) |>
  group_by(region) |> 
#  filter(sum(Kit) + sum(CRI) != 0) |> 
  mutate(cma_kits = zoo::rollmean(Kit, 10, fill = NA)) |>   # Centered moving average
  mutate(cma_cris = zoo::rollmean(CRI, 10, fill = NA)) |> # Centered moving average
  filter(!is.na(cma_cris)) 
  # select(region, today, cma_kits, cma_cris) |> 
  # pivot_longer(cols = c(cma_kits, cma_cris), names_to = "Tipo", values_to = "CMA") |> 
  #  na.omit() |> 
  # group_by(region) %>%
  # filter(sum(Kit) + sum(CRI) != 0)


ymax_kits_cris_list_trend <- max(kits_cris_list_trend$cma_cris * 1.1)

ggplot(kits_cris_list_trend, aes(
    x = today, group = region)) +
  geom_line(aes(
    y = cma_kits
  ),
  size = 0.5,
  color = unhcr_pal(n = 1, "pal_blue"),
  lineend = "round",
  linejoin = "round"
  ) +
    geom_line(aes(
    y = cma_cris
  ),
  size = 0.5,
  color = unhcr_pal(n = 1, "pal_grey"),
  lineend = "round",
  linejoin = "round"
  ) +
  labs(
    title = "Distribución de Kits y CRIs",
    y = "Numero de insumos",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
 # scale_x_continuous(breaks = pretty_breaks()) +
  scale_y_continuous(
    expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(n = 4),
    labels = label_number_si()
#    limits = c(0, ymax_kits_cris_list_trend)
  ) +
  theme_unhcr(font_size = 30,
    grid = "Y",
    axis = "x",
    axis_title = "y",
    legend = TRUE
  ) +
  facet_wrap(~ region, ncol = 3, scales='free') 
  
```

### Predicción: 30 días de Kits y CRIs necesarios

Utilizando los promedios indicados arriba para los últimos dos meses, se puede proyectar que **durante los próximos 30 días** cada región necesitará los siguientes insumos:

```{r, echo=FALSE, warning = FALSE, message = FALSE,  fig.width=7,fig.height=3}

## Prediction: # of Kits and # of CRIs needed over the coming two weeks, with breakdown of type

## Reference periods
referencemin = Sys.Date() - 60
referencemax = Sys.Date()

projectiondays = 30

## Basic prediction calculation based on moving averages

kits_cris_list_trend_pred <- kits_cris_list_trend |> 
  filter(today > referencemin) |> 
  na.omit() |> 
  group_by(region) |> 
  summarise_at(c("cma_kits", "cma_cris"), mean, na.rm = TRUE) |> 
  mutate("Kits Necesarios" = round(cma_kits * projectiondays, digits = 0)) |> 
  mutate("CRIs Necesarios" = round(cma_cris * projectiondays, digits = 0)) |> 
  mutate(Total = `Kits Necesarios` + `CRIs Necesarios`) |> 
  arrange(-Total) |> 
  select(region, "Kits Necesarios", "CRIs Necesarios") 
  


kits_cris_list_trend_pred |>
  kbl() |>
  kable_styling(bootstrap_options = "striped", html_font = "Arial", font_size = 10)


```

Con desglose estimado por tipo de kit y CRI:

```{r, echo=FALSE, warning = FALSE, message = FALSE,  fig.width=7,fig.height=4.1}

## Mobile average over time of kits and CRI distributions by region


## Trends by Kits and CRIs
kits_cris_list_trend_detail <- rudah_all |>
  select(region, today, "kit_dis_kit_abrigo_bebe":"kit_dis_other", "cri_dis_balde":"cri_dis_teclado") |>
  mutate_at(vars(starts_with("kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("kit")), as.numeric) |>
  mutate_at(vars(starts_with("cri")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("cri")), as.numeric) |>
   group_by(region, today) |> 
  summarise_at(vars("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), sum, na.rm = TRUE) 


## Adding min and max dates for missing values by region
kits_cris_list_trend_detail_min <- kits_cris_list_trend_detail |> 
  group_by(region) |> 
  summarize(across(where(is.numeric), ~ 0), today = referencemin)

kits_cris_list_trend_detail_max <- kits_cris_list_trend_detail |> 
  group_by(region) |> 
  summarize(across(where(is.numeric), ~ 0), today = referencemax)



kits_cris_list_trend_detail <- kits_cris_list_trend_detail |>
  ungroup() |> 
  bind_rows(kits_cris_list_trend_detail_min) |> 
  bind_rows(kits_cris_list_trend_detail_max) |>
  pad(interval = "day", group = "region") |> 
  mutate_at(vars(starts_with("Kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("CRI")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), list(~zoo::rollmean(., 7, fill = NA, align = "center"))) |> 
  na.omit()|> 
  filter(today > referencemin) |> 
  na.omit() |> 
  group_by(region) |> 
  summarise_at(vars("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), mean, na.rm = TRUE) |> 
  mutate_at(vars("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), 
            list(~. * projectiondays)) |> 
  mutate_at(vars("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), 
            list(~round(., digits = 0))) |> 
  pivot_longer(cols = c("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), names_to="Tipo", values_to="Total") |>
  filter(Total > 0) |> 
  pivot_wider(names_from = region, values_from = Total) |> 
  mutate_if(is.numeric , replace_na, replace = 0) |> 
  separate(Tipo, into=c("Kit_CRI", "Detalle"), sep = 3) |> 
  mutate(across(c('Detalle'), substr, 6, nchar(Detalle))) |> 
#  mutate(across(c('Detalle'), str_replace, '_', ' '))
  mutate_all(funs(str_replace_all(., "_", " "))) |> 
  mutate(Detalle = sub("(.)", "\\U\\1", Detalle, perl=TRUE)) |> 
  mutate_all(funs(str_replace_all(., "acnur", "ACNUR"))) |> 
  mutate_all(funs(str_replace_all(., "nna", "NNA"))) |> 
  mutate(across('Kit_CRI', str_replace, 'kit', 'Kit')) |> 
  mutate(across('Kit_CRI', str_replace, 'cri', 'CRI')) |> 
  mutate_at(vars("Arequipa":"Tumbes"), as.numeric) |>
  mutate(Total = rowSums(across("Arequipa":"Tumbes"))) |>
  # mutate_at(vars("PE04":"PE24"), as.numeric) |>
  # mutate(Total = rowSums(across("PE04":"PE24"))) |>
  filter(Total != 0) |> 
  arrange(Kit_CRI, Detalle) |> 
  select(Detalle, "Arequipa":"Tumbes") |> 
  pivot_longer(cols = "Arequipa":"Tumbes", names_to = "region", values_to = "Total") |> 
  filter(Total != 0)
# 
# df <- read_csv("https://raw.githubusercontent.com/GDS-ODSSS/unhcr-dataviz-platform/master/data/correlation/heatmap.csv")

ggplot(
  kits_cris_list_trend_detail,
  aes(
    x = region,
    y = fct_rev(Detalle)
  )
) +
  geom_tile(aes(
    fill = Total
  ),
  color = "white",
  lwd = .5,
  linetype = 1
  ) +
  geom_text(aes(label = Total), colour = "white", size = 5)  +
  labs(
    title = "Kits y CRIs posiblemente necesitados",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
  # scale_x_continuous(
  #   expand = expansion(c(0, 0)),
  #   breaks = pretty_breaks(n = 10)
  # ) +
  # scale_y_discrete(
  #   labels = scales::label_wrap(17)
  # ) +
  scale_fill_stepsn(
    colors = unhcr_pal(n = 10, "pal_blue"),
    n.break = 10,
    name = "Numero de insumos"
  ) +
  # coord_fixed() +
    theme_unhcr(
    font_size = 16,
    grid = FALSE,
    axis = FALSE,
    axis_title = FALSE,
    legend_title = TRUE,
    legend = FALSE
  )
# 
# kits_cris_list_trend_detail |>
#   kbl() |>
#   kable_styling(bootstrap_options = "striped", html_font = "Arial", font_size = 9)


```

Cabe resaltar que se trata de datos indicativos basados en actividades pasadas, que no consideran eventuales nuevos eventos o decisiones operativas.

Entre estos, los siguientes insumos podrían ser destinados a los socios:

```{r, echo=FALSE, warning = FALSE, message = FALSE,  fig.width=7,fig.height=3.9}

## Mobile average over time of kits and CRI distributions by region by partner

## Preparing the data

kits_cris_list_trend_detail_socios <- rudah_all |>
  dplyr::filter(grepl("sociounhcr", organizacion) | grepl("obc", organizacion) | grepl("ciremi", organizacion)) |> 
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "hias", "HIAS")) |>  
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "crus_roja", "Cruz Roja")) |> 
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "caritas", "Caritas")) |>  
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "encuentros", "Encuentros")) |> 
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "scalabrini", "Scalabrini")) |> 
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "ach", "ACH")) |> 
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "uv", "UV")) |> 
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "aldeas", "Aldeas"))|> 
  dplyr::filter(tipo_socio != "other") |> 
  select(region, today, organizacion, "kit_dis_kit_abrigo_bebe":"kit_dis_other", "cri_dis_balde":"cri_dis_teclado") |>
  mutate_at(vars(starts_with("kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("kit")), as.numeric) |>
  mutate_at(vars(starts_with("cri")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("cri")), as.numeric) |>
   group_by(region, today, organizacion) |> 
  summarise_at(vars("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), sum, na.rm = TRUE) 


## Adding min and max dates for missing values by region and organization
kits_cris_list_trend_detail_socios_min <- kits_cris_list_trend_detail_socios |> 
  group_by(region, organizacion) |> 
  summarize(across(where(is.numeric), ~ 0), today = referencemin)

kits_cris_list_trend_detail_socios_max <- kits_cris_list_trend_detail_socios |> 
  group_by(region, organizacion) |> 
  summarize(across(where(is.numeric), ~ 0), today = referencemax)



## Continuing the pipe: Trends by type of kits and CRIs and partners
kits_cris_list_trend_detail_socios <- kits_cris_list_trend_detail_socios |>
  ungroup() |> 
  bind_rows(kits_cris_list_trend_detail_socios_min) |>
  bind_rows(kits_cris_list_trend_detail_socios_max) |>
  group_by(region, organizacion) |> 
  complete(today = seq(min(today), max(today), by = "1 day")) %>%
  # pad(interval = "day") |>
  ungroup() |> 
  mutate_at(vars(starts_with("Kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("CRI")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), list(~zoo::rollmean(., 7, fill = NA, align = "center"))) |> 
  na.omit()|> 
  filter(today > referencemin) |> 
  na.omit() |> 
  group_by(region, organizacion) |> 
  summarise_at(vars("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), mean, na.rm = TRUE) |> 
  mutate_at(vars("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), 
            list(~. * projectiondays)) |> 
  mutate_at(vars("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), 
            list(~round(., digits = 0))) |> 
  pivot_longer(cols = c("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), names_to="Tipo", values_to="Total") |>
  filter(Total > 0) |> 
  mutate_if(is.numeric , replace_na, replace = 0) |> 
  pivot_wider(names_from = region, values_from = Total) |> 
  separate(Tipo, into=c("Kit_CRI", "Detalle"), sep = 3) |> 
  mutate(across(c('Detalle'), substr, 6, nchar(Detalle))) |> 
#  mutate(across(c('Detalle'), str_replace, '_', ' '))
  mutate_all(funs(str_replace_all(., "_", " "))) |> 
  mutate(Detalle = sub("(.)", "\\U\\1", Detalle, perl=TRUE)) |> 
  mutate_all(funs(str_replace_all(., "acnur", "ACNUR"))) |> 
  mutate_all(funs(str_replace_all(., "nna", "NNA"))) |> 
  mutate(across('Kit_CRI', str_replace, 'kit', 'Kit')) |> 
  mutate(across('Kit_CRI', str_replace, 'cri', 'CRI')) |> 
  mutate(across('organizacion', str_replace, 'obc', 'OBC')) |> 
  mutate(across('organizacion', str_replace, 'sociounhcr', 'Socio ACNUR Local')) |> 
  mutate(across('organizacion', str_replace, 'ciremi', 'CIREMI')) |> 
  mutate_at(vars("Arequipa":"Tumbes"), as.numeric) |>
  mutate_at(vars("Arequipa":"Tumbes"), ~replace_na(.,0)) |>
  mutate(Total = rowSums(across("Arequipa":"Tumbes"))) |>
  rename("Org." = organizacion) |>
  # mutate_at(vars("PE04":"PE24"), as.numeric) |>
  # mutate_at(vars("PE04":"PE24"), ~replace_na(.,0)) |>
  # mutate(Total = rowSums(across("PE04":"PE24"))) |>
#  filter(Total > 5) |> 
  select(`Org.`, Detalle, Total)


ggplot(
  kits_cris_list_trend_detail_socios,
  aes(
    x = `Org.`,
    y = fct_rev(Detalle)
  )
) +
  geom_tile(aes(
    fill = Total
  ),
  color = "white",
  lwd = .5,
  linetype = 1
  ) +
  geom_text(aes(label = Total), colour = "white", size = 5)  +
  labs(
    title = "Kits y CRIs posiblemente necesitados por socio",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
  # scale_x_continuous(
  #   expand = expansion(c(0, 0)),
  #   breaks = pretty_breaks(n = 10)
  # ) +
  # scale_y_discrete(
  #   labels = scales::label_wrap(17)
  # ) +
  scale_fill_stepsn(
    colors = unhcr_pal(n = 10, "pal_blue"),
    n.break = 10,
    name = "Numero de insumos"
  ) +
  # coord_fixed() +
    theme_unhcr(
    font_size = 16,
    grid = FALSE,
    axis = FALSE,
    axis_title = FALSE,
    legend_title = TRUE,
    legend = FALSE
  )

# kits_cris_list_trend_detail_socios |>
#   kbl() |>
#   kable_styling(bootstrap_options = "striped", html_font = "Arial", font_size = 9)


```

El Anexo 2 brinda un desglose por tipo de insumo, socio y región.

## Orientaciones brindadas en frontera durante los últimos 7 días


```{r, echo=FALSE, warning=FALSE}


rudah_ori <- main |> 
  dplyr::filter(today > date_start_filter) 


total_ori_gen <- rudah_ori |>
  dplyr::select("tipo_orientacion") |>
  na.omit() |> 
  dplyr::filter(grepl("ori_general", tipo_orientacion)) |> 
  nrow() |>
  sum()

total_ori_legal <- rudah_ori |>
  dplyr::select("tipo_orientacion") |>
  na.omit() |> 
  dplyr::filter(grepl("ori_legal", tipo_orientacion)) |> 
  nrow() |>
  sum()


personas_ori_gen <- rudah_ori |>
  dplyr::select("tipo_orientacion", "member_count") |>
  na.omit() |> 
  dplyr::filter(grepl("ori_general", tipo_orientacion)) |> 
  select("member_count") |>
  rowSums() |>
  sum()

personas_ori_legal <- rudah_ori |>
  dplyr::select("tipo_orientacion", "member_count") |>
  na.omit() |> 
  dplyr::filter(grepl("ori_legal", tipo_orientacion)) |> 
  select("member_count") |>
  rowSums() |>
  sum()


personas_ori_tot <- rudah_ori |>
  dplyr::select("tipo_orientacion", "member_count") |>
  na.omit() |> 
  dplyr::filter(grepl("ori_legal", tipo_orientacion) | grepl("ori_general", tipo_orientacion)) |> 
  select("member_count") |>
  rowSums() |>
  sum()

tot_ori_statement <- ifelse(personas_ori_tot == 0 | personas_ori_gen == 0 | personas_ori_legal == 0, "", paste(" (", personas_ori_gen, "personas con orientaciones generales y ", personas_ori_legal, "personas con orientaciones legales)"))

```


La operación brindó `r total_ori_gen` orientaciones generales y `r total_ori_legal` orientaciones legales durante los últimos 7 días a un total de `r personas_ori_tot` personas`r tot_ori_statement`.


```{r, echo=FALSE, warning = FALSE, message = FALSE,  fig.width=7,fig.height=3}


rudah_ori_plot <- main

names_lug_ori <- c('region')
rudah_ori_plot[,names_lug_ori] <- lapply(rudah_ori_plot[,names_lug_ori] , to_factor)

rudah_ori_plot <- rudah_ori_plot |>
  dplyr::filter(today > date_start_filter) |> 
  dplyr::select("region", "tipo_orientacion") |>
  na.omit() |>
  dplyr::filter(grepl("ori_legal", tipo_orientacion) | grepl("ori_general", tipo_orientacion)) |> 
  tidyr::separate(tipo_orientacion, into = c("Ori1", "Ori2"), sep = "\\s") |> 
  pivot_longer(!region, names_to="Tipo", values_to="tipo_orientacion") |> 
  filter(!is.na(tipo_orientacion)) |>
  select(region, tipo_orientacion) |> 
  mutate(tot = 1) |>
  dplyr::add_row(region = NA, tipo_orientacion = "ori_legal", tot = 0) |>
  dplyr::add_row(region = NA, tipo_orientacion = "ori_general", tot = 0) |>
  group_by(region, tipo_orientacion) |> 
  summarise_at(vars("tot"), sum, na.rm = TRUE) |> 
  pivot_wider(names_from = "tipo_orientacion", values_from = "tot") |>
  filter(!is.na(region)) |>
  mutate_at(c("ori_legal", "ori_general"), ~replace_na(.,0)) |>
  rename("Or. Legal" = ori_legal) |>
  rename("Or. General" = ori_general) |>
  pivot_longer(!region, names_to="Tipo", values_to="Total")




rudah_ori_plot_ymax <- max(rudah_ori_plot$Total)*1.1


ggplot(rudah_ori_plot) +
  geom_col(aes(
    x = Tipo,
    y = Total,
    fill = Tipo
  ),
  position = position_dodge(width = 0.7),
  width = 0.6
  ) +
#  facet_wrap(~ Oficina, nrow = 2) +
    facet_grid(~ region, scales='free', space='free') +
  geom_text(aes(
    x = Tipo,
    y = Total,
    group = Tipo,
    label = Total, 
    size = 8
  ),
  position = position_dodge(width = 0.7),
  vjust = -1,
  size = 8 / .pt
  ) +
  scale_fill_unhcr_d(
    palette = "pal_unhcr",
    nmax = 3,
    order = c(2, 3, 1)
  ) +
  labs(
    title = "Orientaciones brindadas",
    y = "Orientaciones brindadas",
    x = "Oficina de terreno",
    caption = "Fuente: Registro Único para la Distribución de Asistencia Humanitaria (RUDAH)"
  ) +
 # scale_x_continuous(breaks = pretty_breaks(n = 4)) +
  scale_y_continuous(expand = expansion(c(0, 0.1))) +
  theme_unhcr(
    grid = FALSE,
    axis = "x",
    axis_title = FALSE,
    axis_text = "x"
  ) +
  ylim(0,rudah_ori_plot_ymax) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE))


```


```{r, echo=FALSE, warning = FALSE, message=FALSE, fig.align = 'left', fig.width=7,fig.height=2}
# 
# library(knitr)
# library(kableExtra)
# 
# 
# orientaciones <- rudah |>
#   select(region, "orientacion_general", "orientacion_legal") |>
#   mutate_at(vars(starts_with("ori")), ~ replace(., is.na(.), 0)) |>
#   pivot_longer(!region, names_to="Tipo", values_to="Total") |>
#   filter(Total > 0) |>
#   group_by(region, Tipo) |>
#   summarise_at(c("Total"), sum, na.rm = TRUE)
# 
# 
# orientaciones <- left_join(orientaciones, rudah_xls_ofi, by="oficina")
# 
# 
# rudah_xls_ori <- rudah_xls |>
#   filter(list_name == "orientacion_general" | list_name == "orientacion_legal") |>
#   mutate(namenew = paste(list_name, "_", name, sep="")) |>
#   select(namenew, label)
# 
# 
# colnames(rudah_xls_ori) <- c("Tipo", "Nombre Orientacion")
# 
# orientaciones <- left_join(orientaciones, rudah_xls_ori, by="Tipo")
# 
# orientaciones <- orientaciones[,c("Nombre", "Nombre Orientacion", "Total")]
# 
# 
# colnames(orientaciones) <- c("Oficina/Unidad", "Tipo de Orientación Brindada", "Total")
# 
# orientaciones |>
#   kable() |>
#   kable_styling(bootstrap_options = "striped", html_font = "Arial", font_size = 9)

```
\newpage
### Anexo 1: Tipo de Kits y CRIs distribuidos durante los últimos 7 días
```{r, echo=FALSE, warning = FALSE, message=FALSE, fig.align = 'left', fig.width=7,fig.height=2}



kits_cris_list <- rudah |>
  select(region, "kit_dis_kit_abrigo_bebe":"kit_dis_other", "cri_dis_balde":"cri_dis_teclado") |>
#  mutate_at(c('col1', 'col2'), as.numeric)
#  mutate_at('kit_dis_kit_abrigo_bebe':'cri_dis_teclado', ~replace_na(.,0))
  mutate_at(vars(starts_with("kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("kit")), as.numeric) |>
  mutate_at(vars(starts_with("cri")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("cri")), as.numeric) |>
  pivot_longer(!region, names_to="Tipo", values_to="Total") |>
  separate(Tipo, into=c("Kit_CRI", "Detalle"), sep = 3) |> 
  mutate(across(c('Detalle'), substr, 6, nchar(Detalle))) |> 
#  mutate(across(c('Detalle'), str_replace, '_', ' '))
  mutate_all(funs(str_replace_all(., "_", " "))) |> 
  mutate(Detalle = sub("(.)", "\\U\\1", Detalle, perl=TRUE)) |> 
  mutate_all(funs(str_replace_all(., "Acnur", "ACNUR"))) |> 
  mutate_all(funs(str_replace_all(., "nna", "NNA"))) |> 
  mutate(across('Kit_CRI', str_replace, 'kit', 'Kit')) |> 
  mutate(across('Kit_CRI', str_replace, 'cri', 'CRI')) |> 
  filter(Total != 0) |> 
  mutate_at(vars(Total), as.numeric) |>
  group_by(region, Kit_CRI, Detalle) |> 
  summarise_at(c("Total"), sum, na.rm = TRUE) |> 
  arrange(region, Kit_CRI, -Total)

kits_cris_list |>
  kbl() |>
  kable_styling(bootstrap_options = "striped", html_font = "Arial", font_size = 10)

```
\newpage
### Anexo 2: Insumos proyectados necesarios para los próximos 30 días por región y socio
```{r, echo=FALSE, warning = FALSE, message = FALSE,  fig.width=7,fig.height=3}

## Mobile average over time of kits and CRI distributions by region by partner

## Preparing the data

kits_cris_list_trend_detail_socios <- rudah_all |>
  dplyr::filter(grepl("sociounhcr", organizacion) | grepl("obc", organizacion) | grepl("ciremi", organizacion)) |> 
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "hias", "HIAS")) |>  
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "crus_roja", "Cruz Roja")) |> 
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "caritas", "Caritas")) |>  
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "encuentros", "Encuentros")) |> 
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "scalabrini", "Scalabrini")) |> 
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "ach", "ACH")) |> 
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "uv", "UV")) |> 
  dplyr::mutate(organizacion = replace(organizacion, tipo_socio == "aldeas", "Aldeas"))|> 
  dplyr::filter(tipo_socio != "other") |> 
  select(region, today, organizacion, "kit_dis_kit_abrigo_bebe":"kit_dis_other", "cri_dis_balde":"cri_dis_teclado") |>
  mutate_at(vars(starts_with("kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("kit")), as.numeric) |>
  mutate_at(vars(starts_with("cri")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("cri")), as.numeric) |>
   group_by(region, today, organizacion) |> 
  summarise_at(vars("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), sum, na.rm = TRUE) 


## Adding min and max dates for missing values by region and organization
kits_cris_list_trend_detail_socios_min <- kits_cris_list_trend_detail_socios |> 
  group_by(region, organizacion) |> 
  summarize(across(where(is.numeric), ~ 0), today = referencemin)

kits_cris_list_trend_detail_socios_max <- kits_cris_list_trend_detail_socios |> 
  group_by(region, organizacion) |> 
  summarize(across(where(is.numeric), ~ 0), today = referencemax)



## Continuing the pipe: Trends by type of kits and CRIs and partners
kits_cris_list_trend_detail_socios <- kits_cris_list_trend_detail_socios |>
  ungroup() |> 
  bind_rows(kits_cris_list_trend_detail_socios_min) |>
  bind_rows(kits_cris_list_trend_detail_socios_max) |>
  group_by(region, organizacion) |> 
  complete(today = seq(min(today), max(today), by = "1 day")) %>%
  # pad(interval = "day") |>
  ungroup() |> 
  mutate_at(vars(starts_with("Kit")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars(starts_with("CRI")), ~ replace(., is.na(.), 0)) |>
  mutate_at(vars("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), list(~zoo::rollmean(., 7, fill = NA, align = "center"))) |> 
  na.omit()|> 
  filter(today > referencemin) |> 
  na.omit() |> 
  group_by(region, organizacion) |> 
  summarise_at(vars("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), mean, na.rm = TRUE) |> 
  mutate_at(vars("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), 
            list(~. * projectiondays)) |> 
  mutate_at(vars("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), 
            list(~round(., digits = 0))) |> 
  pivot_longer(cols = c("kit_dis_kit_abrigo_bebe":"cri_dis_teclado"), names_to="Tipo", values_to="Total") |>
  filter(Total > 0) |> 
  mutate_if(is.numeric , replace_na, replace = 0) |> 
  pivot_wider(names_from = region, values_from = Total) |> 
  separate(Tipo, into=c("Kit_CRI", "Detalle"), sep = 3) |> 
  mutate(across(c('Detalle'), substr, 6, nchar(Detalle))) |> 
#  mutate(across(c('Detalle'), str_replace, '_', ' '))
  mutate_all(funs(str_replace_all(., "_", " "))) |> 
  mutate(Detalle = sub("(.)", "\\U\\1", Detalle, perl=TRUE)) |> 
  mutate_all(funs(str_replace_all(., "acnur", "ACNUR"))) |> 
  mutate_all(funs(str_replace_all(., "nna", "NNA"))) |> 
  mutate(across('Kit_CRI', str_replace, 'kit', 'Kit')) |> 
  mutate(across('Kit_CRI', str_replace, 'cri', 'CRI')) |> 
  mutate(across('organizacion', str_replace, 'obc', 'OBC')) |> 
  mutate(across('organizacion', str_replace, 'sociounhcr', 'Socio ACNUR Local')) |> 
  mutate(across('organizacion', str_replace, 'ciremi', 'CIREMI')) |> 
  mutate_at(vars("Arequipa":"Tumbes"), as.numeric) |>
  mutate_at(vars("Arequipa":"Tumbes"), ~replace_na(.,0)) |>
  mutate(Total = rowSums(across("Arequipa":"Tumbes"))) |>
  rename("Org." = organizacion) |>
  # mutate_at(vars("PE04":"PE24"), as.numeric) |>
  # mutate_at(vars("PE04":"PE24"), ~replace_na(.,0)) |>
  # mutate(Total = rowSums(across("PE04":"PE24"))) |>
  filter(Total > 5) |> 
  arrange(`Org.`, Kit_CRI, Detalle) 

kits_cris_list_trend_detail_socios |>
  kbl() 
# kable_styling(bootstrap_options = "striped", html_font = "Arial", font_size = 10)


```